# MCP代码完善

## 添加HTTP适配器

它可以作为桥接层，让小智机器人等 HTTP 客户端通过 HTTP 请求调用你的 MCP stdio 服务器。

**用法说明：**

1. 启动适配器服务：
   ```bash
   uvicorn Code.mcp_http_adapter:app --host 0.0.0.0 --port 8000
   ```

2. 机器人或其他 HTTP 客户端可以这样调用：
   - POST `/mcp/tool`
   - 请求体示例：
     ```json
     {
       "name": "get_tke_pod_logs",
       "arguments": {
         "ClusterId": "cls-xxxxxx",
         "Namespace": "default",
         "PodName": "nginx-xxxxxx",
         "ContainerName": "nginx"
       }
     }
     ```

3. 适配器会自动转发请求到 MCP stdio 服务器，并将结果返回。

## 并发优化

### 方案说明：多并发池

- 启动 N 个 MCP 子进程（如 4 个，可配置）。

- 每个 HTTP 请求自动分配到一个空闲子进程（轮询/随机/队列）。

- 每个子进程独立处理请求，互不干扰，提升吞吐量。

- 保证请求-响应一一对应，避免串行阻塞和响应错乱。

  

## 容器服务

关于腾讯云 TKE（容器服务）的功能主要体现在**Tools（工具）**部分，具体包括以下实现：

---

### 工具定义

在 `@app.list_tools()` 里，TKE 相关的工具有：

当然可以！下面是对你列出的每个 TKE 工具的详细介绍，适合用作 MCP 工具的 description 字段、文档或机器人帮助信息。

---

#### 1. get_tke_pod_logs

- **作用**：获取腾讯云 TKE 指定 Pod 的日志内容。
- **详细介绍**：  
  该工具通过调用腾讯云 TKE API，获取指定集群（ClusterId）、命名空间（Namespace）、Pod 名称（PodName）和容器名称（ContainerName）下的最新日志内容。适用于运维排查、故障分析、自动化日志采集等场景。
- **参数**：
  - `ClusterId`：集群ID
  - `Namespace`：命名空间
  - `PodName`：Pod名称
  - `ContainerName`：容器名称

---

#### 2. restart_tke_pod

- **作用**：重启腾讯云 TKE 指定 Pod（通过删除 Pod 实现重启）。
- **详细介绍**：  
  该工具通过调用腾讯云 TKE API 的删除 Pod 接口，将指定的 Pod 删除，Kubernetes 会自动根据副本控制器（如 Deployment）重建新的 Pod，从而实现“重启”效果。适用于自动化修复、Pod 故障自愈等场景。
- **参数**：
  - `ClusterId`：集群ID
  - `Namespace`：命名空间
  - `PodName`：Pod名称

---

#### 3. analyze_tke_logs

- **作用**：分析 TKE 日志内容，输出异常或关键信息（如 error、warning）。
- **详细介绍**：  
  该工具对传入的日志内容进行自动分析，筛选出包含“error”或“warning”等关键字的异常日志行，帮助运维人员快速定位问题。适用于日志告警、自动化巡检、异常检测等场景。
- **参数**：
  - `log_content`：待分析的日志内容（字符串）

---

#### 4. list_tke_clusters

- **作用**：列出所有 TKE 集群。
- **详细介绍**：  
  该工具通过调用腾讯云 TKE API，获取当前账号下所有已创建的容器集群的基本信息。适用于多集群管理、自动化巡检、集群资源统计等场景。
- **参数**：无

---

#### 5. describe_tke_cluster

- **作用**：获取指定 TKE 集群的详细信息。
- **详细介绍**：  
  该工具通过调用腾讯云 TKE API，获取指定集群（ClusterId）的详细配置信息，包括网络、节点池、状态等。适用于集群健康检查、配置审计、自动化运维等场景。
- **参数**：
  - `ClusterId`：集群ID

---

#### 6. list_tke_nodes

- **作用**：列出指定 TKE 集群的所有节点。
- **详细介绍**：  
  该工具通过调用腾讯云 TKE API，获取指定集群（ClusterId）下所有节点（包括主节点和工作节点）的详细信息。适用于节点状态监控、资源统计、自动化扩缩容等场景。
- **参数**：
  - `ClusterId`：集群ID

---

#### 7. scale_tke_node_pool

- **作用**：调整 TKE 节点池的节点数量（自动扩缩容）。
- **详细介绍**：  
  该工具通过调用腾讯云 TKE API，调整指定集群（ClusterId）下某个节点池（NodePoolId）的期望节点数（DesiredNodeCount），实现节点池的自动扩容或缩容。适用于弹性伸缩、自动化资源调度等场景。
- **参数**：
  - `ClusterId`：集群ID
  - `NodePoolId`：节点池ID
  - `DesiredNodeCount`：期望节点数（整数）

---

### 典型调用参数示例

- 获取 Pod 日志：
  ```json
  {
    "name": "get_tke_pod_logs",
    "arguments": {
      "ClusterId": "cls-xxxxxx",
      "Namespace": "default",
      "PodName": "nginx-xxxxxx",
      "ContainerName": "nginx"
    }
  }
  ```

- 重启 Pod：
  ```json
  {
    "name": "restart_tke_pod",
    "arguments": {
      "ClusterId": "cls-xxxxxx",
      "Namespace": "default",
      "PodName": "nginx-xxxxxx"
    }
  }
  ```

- 分析日志内容：
  ```json
  {
    "name": "analyze_tke_logs",
    "arguments": {
      "log_content": "your log text here"
    }
  }
  ```

---

### 总结

MCP 服务器当前已支持以下 TKE 运维自动化能力：

**获取 Pod 日志**

**重启 Pod**

**日志内容分析**

**列出所有 TKE 集群**

**获取指定 TKE 集群的详细信息**

**列出指定 TKE 集群的所有节点**

**调整 TKE 节点池的节点数量（自动扩缩容）**

## 提示模板结构和内容规范化

主要添加了分析日志的提示词模板

```
    "ops_summary": {
        "name": "ops_summary",
        "description": "根据日志内容生成运维日报总结。",
        "arguments": [
            {"name": "log_content", "type": "string", "description": "当天的运维日志内容", "required": True}
        ],
        "format": "markdown",
        "template": (
            "请根据以下日志内容，生成一份简明的运维日报总结，突出异常、告警和关键事件：\n\n{log_content}"
        )
    }
```

## 需要的参数

当前 MCP 服务器中各个 TKE 相关工具（tool）**所需的参数说明**，以及每个参数的含义和示例值

---

### 1. get_tke_pod_logs

- **作用**：获取腾讯云 TKE 指定 Pod 的日志
- **所需参数**：
  - `ClusterId`（string）：集群ID（如 `"cls-xxxxxx"`）
  - `Namespace`（string）：命名空间（如 `"default"`）
  - `PodName`（string）：Pod名称（如 `"nginx-xxxxxx"`）
  - `ContainerName`（string）：容器名称（如 `"nginx"`）

**示例参数：**
```json
{
  "ClusterId": "cls-xxxxxx",
  "Namespace": "default",
  "PodName": "nginx-xxxxxx",
  "ContainerName": "nginx"
}
```

---

### 2. restart_tke_pod

- **作用**：重启腾讯云 TKE 指定 Pod
- **所需参数**：
  - `ClusterId`（string）：集群ID
  - `Namespace`（string）：命名空间
  - `PodName`（string）：Pod名称

**示例参数：**
```json
{
  "ClusterId": "cls-xxxxxx",
  "Namespace": "default",
  "PodName": "nginx-xxxxxx"
}
```

---

### 3. analyze_tke_logs

- **作用**：分析 TKE 日志内容，输出异常或关键信息
- **所需参数**：
  - `log_content`（string）：待分析的日志内容（如多行字符串）

**示例参数：**
```json
{
  "log_content": "2024-07-18 10:00:00 error: something failed\n2024-07-18 10:01:00 info: ok"
}
```

---

### 4. list_tke_clusters

- **作用**：列出所有 TKE 集群
- **所需参数**：无

**示例参数：**
```json
{}
```

---

### 5. describe_tke_cluster

- **作用**：获取指定 TKE 集群的详细信息
- **所需参数**：
  - `ClusterId`（string）：集群ID

**示例参数：**
```json
{
  "ClusterId": "cls-xxxxxx"
}
```

---

### 6. list_tke_nodes

- **作用**：列出指定 TKE 集群的所有节点
- **所需参数**：
  - `ClusterId`（string）：集群ID

**示例参数：**
```json
{
  "ClusterId": "cls-xxxxxx"
}
```

---

### 7. scale_tke_node_pool

- **作用**：调整 TKE 节点池的节点数量（自动扩缩容）
- **所需参数**：
  - `ClusterId`（string）：集群ID
  - `NodePoolId`（string）：节点池ID（如 `"np-xxxxxx"`）
  - `DesiredNodeCount`（integer）：期望节点数（如 `5`）

**示例参数：**
```json
{
  "ClusterId": "cls-xxxxxx",
  "NodePoolId": "np-xxxxxx",
  "DesiredNodeCount": 5
}
```

---

### 总结

- 每个 tool 的参数都可以在 `inputSchema` 字段和 description 字段中查到。
- 调用时只需将参数填入 `arguments` 字段即可。

## env文件

![image-20250718184235276](./7%E6%9C%8818%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250718184235276-1752835356575-1-1752835358440-3.png)

## 结果

### MCP 服务器启动成功

- 终端显示 启动 MCP 服务器: mcp-server-template v1.0.0，说明你的 MCP 服务器已经在等待请求。

- 你现在可以通过 MCP 协议（如 HTTP 适配器、机器人、自动化脚本等）调用你实现的各种工具（如 TKE 运维、日志分析等）。

![image-20250718191629004](./7%E6%9C%8818%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250718191629004-1752837390204-5.png)
