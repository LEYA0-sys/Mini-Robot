好的 ✅ 那我为你写了一个 **快速操作指南**，包含每一步的操作，方便你按照顺序执行实验并触发不同的回滚策略。

------

## 🚀 快速操作指南：演练 MCP 回滚工具

### 1. **准备环境**

首先，将 **完整的 YAML 文件** 部署到集群里：

```bash
kubectl apply -f rollback-lab.yaml
```

这个命令会部署：

- **Nginx Web 服务**
- **MySQL StatefulSet**
- **Sysbench 压测 Pod**
- **NetworkPolicy**（限制 MySQL 访问，用来模拟网络异常）

### 2. **触发回滚策略：**

#### ⚡ **模拟 CPU 和内存过载**

1. 确保 **Sysbench Pod** 正在运行，利用 **sysbench** 对 MySQL 进行压测：

   ```bash
   kubectl logs sysbench-client
   ```

2. 观察到高 CPU 和内存消耗时，可能会触发以下回滚：

   - `rollback_cpu_high_usage`
   - `rollback_memory_high_usage`

#### ⚡ **模拟 Pod CrashLoop**

1. 修改 **Nginx** 部署，故意将 `livenessProbe` 的 `path` 改为错误的路径：

   ```yaml
   livenessProbe:
     httpGet:
       path: /wrong-path   # 触发 CrashLoop
   ```

2. 更新 Nginx 部署：

   ```bash
   kubectl apply -f rollback-lab.yaml
   ```

3. 观察 Nginx Pod 会不断重启，触发：

   - `rollback_pod_crash_loop`

#### ⚡ **模拟服务不可用**

1. 修改 **Nginx** 部署，故意将 `readinessProbe` 的 `path` 改为错误的路径：

   ```yaml
   readinessProbe:
     httpGet:
       path: /wrong-path   # 触发服务不可用
   ```

2. 更新 Nginx 部署：

   ```bash
   kubectl apply -f rollback-lab.yaml
   ```

3. 观察到 Nginx 服务不可用，触发：

   - `rollback_service_unavailable`

#### ⚡ **模拟镜像拉取失败**

1. 修改 **Nginx** 或 **MySQL** 部署，改为错误的镜像：

   ```yaml
   image: nginx:fake123  # 错误镜像
   ```

2. 更新部署：

   ```bash
   kubectl apply -f rollback-lab.yaml
   ```

3. 观察到 Pod 启动失败，触发：

   - `rollback_image_pull_failed`

#### ⚡ **模拟存储问题**

1. 修改 **MySQL** 部署，改为一个不存在的 `storageClassName`：

   ```yaml
   storageClassName: invalid-storage-class  # 改错存储类
   ```

2. 更新 MySQL 部署：

   ```bash
   kubectl apply -f rollback-lab.yaml
   ```

3. 观察到 MySQL Pod 卡在 `Pending` 状态，触发：

   - `rollback_storage_issues`

#### ⚡ **模拟网络问题**

1. 部署后，默认 MySQL Pod 是可访问的。我们通过 **NetworkPolicy** 禁止访问 MySQL 服务：

   ```bash
   kubectl apply -f rollback-lab.yaml
   ```

2. 然后用 **Sysbench** 访问 MySQL，会失败，触发：

   - `rollback_network_issues`

3. 如果你想恢复网络访问，可以删除 `NetworkPolicy`：

   ```bash
   kubectl delete networkpolicy deny-mysql-access
   ```

------

### 3. **恢复操作**

#### ⚡ **恢复网络**

1. 删除 `NetworkPolicy`，恢复 MySQL 访问：

   ```bash
   kubectl delete networkpolicy deny-mysql-access
   ```

#### ⚡ **恢复服务**

1. 恢复 Nginx 服务的健康检查配置，修改 `livenessProbe` 和 `readinessProbe`，重新应用：

   ```bash
   kubectl apply -f rollback-lab.yaml
   ```

#### ⚡ **恢复资源配置**

1. 恢复资源请求与限制，避免过载：

   ```yaml
   resources:
     requests:
       cpu: "100m"
       memory: "256Mi"
     limits:
       cpu: "500m"
       memory: "512Mi"
   ```

### 4. **清理实验环境**

当你完成实验后，记得清理环境：

```bash
kubectl delete -f rollback-lab.yaml
```

------

## 📊 触发回滚总结：

- **CPU/Mem 过载**：使用 Sysbench 压测触发
- **Pod CrashLoop**：修改 `livenessProbe` 错误路径
- **服务不可用**：修改 `readinessProbe` 错误路径
- **镜像拉取失败**：使用错误镜像名
- **存储问题**：配置不存在的 `storageClassName`
- **网络问题**：通过 `NetworkPolicy` 禁止访问 MySQL

------

通过这个实验，你可以全面演练 **MCP 回滚工具**，验证其对不同故障场景的自动恢复能力。

有其他想要添加的实验或修改的地方吗？