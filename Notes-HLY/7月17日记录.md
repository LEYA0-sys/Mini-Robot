# 容器服务





| 字段名        | 含义     | 使用场景         |
| ------------- | -------- | ---------------- |
| ContainerName | 容器名称 | 查询容器实例日志 |
| ClusterId     | 集群ID   | 查看集群状态     |
|               |          |                  |

# 日志服务

| 字段名          | 含义             | 使用场景 |
| --------------- | ---------------- | -------- |
| accessKeyId     | AWS 访问密钥 ID  |          |
| secretAccessKey | AWS 密钥访问密钥 |          |
| logGroupName    | 日志组的名称     |          |
|                 |                  |          |

# 人脸服务

| 字段名   | 含义                                 | 使用场景 |
| -------- | ------------------------------------ | -------- |
| Image    | 人脸的图片                           | 人员搜索 |
| Url      | 能访问人脸的URL，和Image二选一就可以 | 人员搜索 |
| GroupIds | 人员库ID                             | 人员搜索 |
|          |                                      |          |

# 腾讯云容器服务集群问题模

## 模拟集群问题的方法

### 节点资源耗尽

• 在节点上部署高负载应用，消耗所有CPU/内存资源

• 使用压力测试工具：stress --cpu 8 --vm 4 --vm-bytes 1024M

### 网络问题模拟

• 修改节点安全组规则，阻断部分网络通信

• 在节点上使用iptables丢弃部分网络包

### 组件故障

• 手动停止kubelet服务：systemctl stop kubelet

• 删除或修改关键系统组件配置文件

### 存储问题

• 将节点上的docker存储目录填满：dd if=/dev/zero of=/var/lib/docker/fill bs=1M

### 配置错误

• 修改集群错误的kubeconfig

• 设置错误的资源配额限制

## 备注

本身集群在不干涉的情况下就会报错，这是使用SQL语句查找到的系统中各类Kubernetes资源报错的数量

```
responseStatus.code >= 400 | SELECT count(*) AS error_count, objectRef.resource AS resource GROUP BY resource ORDER BY error_count DESC
```

![image-20250717163932525](./7%E6%9C%8817%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250717163932525-1752741574432-1.png)

### 分析

这个表格是你在腾讯云日志服务平台执行SQL查询后的结果，它展示了系统中各类Kubernetes资源（resource）在出现HTTP 400及以上错误（错误响应）时的统计情况。以下是具体解读：

---

### **表格含义**
| error_count | resource    |
| ----------- | ----------- |
| 40400       | pods        |
| 1690        | apiservices |
| 850         | deployments |
| ...         | ...         |

- **error_count**：每种资源（resource）触发错误响应（`responseStatus.code >= 400`）的总次数。
- **resource**：Kubernetes资源类型，表示错误发生在哪个资源上。

---

### **关键发现**
1. **错误分布**  
   - **Pods（40400次）** 是错误最多的资源，远超其他资源，可能需要优先排查：
     - 可能原因：Pod频繁崩溃、健康检查失败、资源不足等。
   - **APIServices（1690次）** 和 **Deployments（850次）** 是第二、第三高错误来源：
     - APIServices错误可能涉及Kubernetes API Server的通信问题。
     - Deployments错误可能与部署配置或滚动更新失败有关。

2. **NULL值（32次）**  
   - 部分错误未关联到具体资源（`resource`字段为空），可能是系统级错误或日志记录不完整。

3. **低频错误**  
   - 如 `healthcheckpolicies`、`leases` 等错误次数较少，但仍需关注是否集中在特定场景。

---

### **下一步建议**
1. **聚焦Pods问题**  
   - 检查Pod日志（如 `kubectl logs <pod-name>`），分析常见错误（如CrashLoopBackOff、ImagePullBackOff）。
   - 确认资源配额（CPU/内存）是否充足。

2. **APIServices排查**  
   - 检查Kubernetes API Server的可用性，以及自定义APIService（如metrics-server）是否正常运行。

3. **Deployments/Services**  
   - 检查部署配置（如YAML中的镜像标签、探针设置）和服务端口匹配性。

4. **NULL值调查**  
   - 检查日志中是否有未关联资源的错误信息（如权限拒绝、全局配置错误）。

---

### **补充说明**
- 腾讯云日志服务平台的SQL查询结果直接反映了错误分布的优先级，可帮助快速定位关键问题。
- 如果需要更详细分析，可以进一步筛选错误类型（如 `responseStatus.code == 500`）或时间范围。

## 举例

![image-20250717164735698](./7%E6%9C%8817%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250717164735698-1752742056840-3.png)

以上面的图片为例，Pod节点运行过程出错，把日志丢给AI进行分析，看看是什么错误。同时AI给出解决方案

这个日志显示的是 **腾讯云 CBS（Cloud Block Storage）CSI 驱动** 在尝试创建云硬盘（CBS 磁盘）时遇到的错误，核心问题是 **磁盘大小不符合要求**。以下是详细分析：

---

### **核心问题**
日志中反复出现以下错误（每 5 分钟重试一次）：
```plaintext
E0717 07:52:45.339372 GRPC error: rpc error: code = InvalidArgument desc = disk size is invalid. Must in [10, 32000]
```
- **错误原因**：请求的磁盘大小不在腾讯云 CBS 允许的范围内（最小 10GB，最大 32000GB）。
- **触发操作**：每次尝试创建名为 `pvc-cbadac2e-5a18-4fb0-90a4-1b9a6d7defaa` 的 PVC（PersistentVolumeClaim）时都会失败。

---

### **关键日志分析**
1. **请求的磁盘大小**  
   在 `GRPC request` 中可以看到容量需求：
   ```json
   "capacity_range":{"required_bytes":5368709120}
   ```
   - `5368709120 bytes` = **5GB**（不符合腾讯云 CBS 的最小 10GB 要求）。

2. **腾讯云 CBS 的磁盘规格**  
   日志中返回的磁盘配置（`diskQuotaResp`）明确限制了磁盘大小范围：
   - **CLOUD_PREMIUM（高性能云硬盘）**：`MinDiskSize:10GB`, `MaxDiskSize:32000GB`
   - 其他类型（如 CLOUD_SSD）最小 20GB。

3. **根本原因**  
   - 用户（或系统）创建的 PVC 请求了 **5GB** 的磁盘，但腾讯云 CBS 要求最小 **10GB**（高性能云硬盘）或 **20GB**（其他类型）。

---

### **解决方案**
1. **修改 PVC 的存储请求**  
   将 PVC 的 `storage` 字段调整为至少 **10GB**（例如 10Gi），例如：
   ```yaml
   apiVersion: v1
   kind: PersistentVolumeClaim
   metadata:
     name: your-pvc-name
   spec:
     storageClassName: cbs
     accessModes:
       - ReadWriteOnce
     resources:
       requests:
         storage: 10Gi  # 必须 ≥10GB
   ```

2. **检查 StorageClass 配置**  
   确认使用的 StorageClass（如 `cbs`）是否指定了支持的磁盘类型（如 `CLOUD_PREMIUM`），例如：
   ```yaml
   kind: StorageClass
   apiVersion: storage.k8s.io/v1
   metadata:
     name: cbs
   provisioner: com.tencent.cloud.csi.cbs
   parameters:
     type: CLOUD_PREMIUM  # 高性能云硬盘（最小 10GB）
   ```

3. **验证现有 PVC**  
   执行以下命令检查出问题的 PVC：
   ```bash
   kubectl get pvc pvc-cbadac2e-5a18-4fb0-90a4-1b9a6d7defaa -o yaml
   ```
   确认 `spec.resources.requests.storage` 是否合规。

---

### **其他注意事项**
- **重试机制**：CSI 驱动会每 5 分钟自动重试（日志中多次 `GRPC call: /csi.v1.Controller/CreateVolume`），但只有修复 PVC 配置后才能成功。
- **磁盘类型**：如果必须使用 SSD 类型（如 `CLOUD_SSD`），则需将 PVC 大小调整为至少 **20GB**。
- **权限问题**：日志中还有 `Get secretID or secretKey from env failed` 的警告，但这不是导致当前错误的主因（驱动已回退到默认权限）。

---

### **总结**
问题本质是 **PVC 请求的磁盘大小（5GB）不满足腾讯云 CBS 的最小要求（10GB）**。通过调整 PVC 或 StorageClass 配置即可解决。
