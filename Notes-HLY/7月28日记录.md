# 流程

注册-用注册的用户名+密码登录->添加智能体->播报

![aae6199e911beeb79ed5db55572bc41f](./7%E6%9C%8828%E6%97%A5%E8%AE%B0%E5%BD%95.assets/aae6199e911beeb79ed5db55572bc41f-1753714687233-2.png)

会议：确认用户注册+用户录入声纹 全手动

解决问题：

1.在自己的服务端添加声纹，说话人目前有0个。

账号*2：声纹识别的说话人用真名->黄色页面注册时候也用真名、腾讯云的id和key写真实值->MCP

2.前后端出了问题，无法连接

待办：

0.部署腾讯云+MCP接入文档

1.设计把说话人名称作为参数，去数据库中搜索对应的腾讯云平台信息

2.怎么主动去调用告警的MCP

MCP：

1.设计告警策略

2.获取日志->关于告警

3.LLM去自然语言处理，说人话

4.小智说出来告警信息（播报）

5.询问是否回滚（处理告警问题->LLM给出策略->MCP->解决）



# 部署集群

## 日志

开启了业务日志、审计日志、事件日志，没有开启CoreDNS日志

配置了通知渠道组，设置webhook接口，http://1.13.92.135:8002/webhook/alert

对于告警内容，我们分为以下几个部分：

### 预置告警策略

#### 实现思路

配置通知渠道组，一旦告警先发送给webhook接口，机器人服务端接收告警信息自动存储为当日播报内容，并且需要由用户确认是否回滚以后再去处置告警；如果处理不成功会在12h后发送给用户微信

> [!CAUTION]
>
> 这里面实操起来需要用户自己添加自己的联系方式如微信/邮件等

![image-20250729003131664](./7%E6%9C%8828%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250729003131664-1753720292875-1.png)

![image-20250729003154187](./7%E6%9C%8828%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250729003154187-1753720315226-3.png)

### 分析日志内容

#### 仪表盘——图像分析并播报

内置仪表盘，用于进行图像的分析，也是SQL检索分析的升级版，即自定义SQL语句检索日志，生成仪表盘

![image-20250729005055108](./7%E6%9C%8828%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250729005055108-1753721456112-5.png)

#### COS桶——保存完整日志

使用已有的MCP直接从COS桶中下载压缩为gzip的日志文件，以天为级别保存日志

![image-20250729012611361](./7%E6%9C%8828%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250729012611361-1753723572364-7.png)

# 下一步计划（重点）

目前已经生成了两个测试用户的账号并且已经进行了声纹录入+平台注册+添加智能体

> [!IMPORTANT]
>
> #### **本周计划**
>
> 1.演示腾讯云平台关于以下三类获取日志的功能,组员对这个要有一点了解
>
> 2.修复架构问题
>
> - **延迟增加**：每次都需要声纹识别 + 数据库查询->.env id key
> - **资源消耗**：重复的认证和查询操作
> - **用户体验差**：响应时间较长
>
> 3.商讨以后确认分工,目前已经有了三类要播报的内容,我的想法是一人负责一个,把LLM总结出的告警内容保存为云服务器下的一个文件,然后最后三个文件再一起丢给LLM分析得出总结版以后进行播报。这一套流程重点在于全自动，之后的回滚以及其他操作都可以慢慢通过写MCP 工具去添加再人为触发。

```PlainText
用户打招呼 → 检查每日触发状态 → 并行启动三个告警收集任务
     ↓
任务A: COS日志分析 → 生成analysis_cos.json
任务B: 仪表盘图像分析 → 生成analysis_dashboard.json  
任务C: Webhook告警收集 → 生成analysis_webhook.json
     ↓
等待三个任务完成 → LLM整合分析 → 生成最终报告 → 语音播报
```

```
mcp-log-service/
├── README.md
├── requirements.txt
├── mcp_pipe.py              # WebSocket通信管道
├── log_service_server.py    # 主MCP服务器
├── tools/
│   ├── __init__.py
│   ├── cos_log_downloader.py    # COS日志下载
│   ├── dashboard_capture.py     # 仪表盘截图
│   ├── webhook_receiver.py      # Webhook接收
│   ├── log_analyzer.py          # 日志分析
│   └── notification_sender.py   # 通知发送
├── config/
│   ├── __init__.py
│   └── settings.py
└── utils/
    ├── __init__.py
    └── logger.py
```

声纹识别得到用户名参数以后自动拿去调用MCP，这里需要有几个与日志/告警有关的MCP：

> [!IMPORTANT]
>
> 每日播报内容是前一天的日志内容

（1）使用webhook接口http://1.13.92.135:8002/webhook/alert接收由告警策略触发的告警内容，并交由LLM进行整合

（2）下载COS桶（存储桶）里面的前一天的日志文件后递交给LLM进行分析，查看是否有异常告警部分

> [!WARNING]
>
> 日志文件是gzip文件，格式是转义过的JSON，需要解压
>
> 同时考虑设计每日22：00（用户下班后）开始自动删除该日志文件，这样不会堆积在一起

（3）获取腾讯云日志服务的仪表盘信息，我已经内置了关于三个已开通的日志的仪表盘，即分析图象，同样需要LLM来分析，并且需要设计提示词

集成以上三者再交由LLM总结出当日要播报的告警内容，再交给小智进行播报。

> [!WARNING]
>
> 这一块建议让LLM把总结的内容生成以天为级别的文件，存储在文件夹下。这样方便溯源，而且保存在服务器里的只有这一套每日总结的内容，内存消耗较小并且便于追溯

类似于以下格式，这块应该需要写提示词：

**你好，XX。下面我将从告警历史、日志文件、仪表盘三个角度为你播报昨日日志告警内容，如果您需要我投递今天播报内容至你的工作邮箱或是让我开始针对告警内容进行回滚，请告知我。**

**从XX角度，+分析内容**

（4）投递至邮箱：写MCP

（5）开始回滚：这个是之后才涉及到的，算是第三个场景设计了。前提是要有内容进行回滚，目前设想可以把三者总结出的告警内容保存为文件，投递邮箱和回滚都可以把这个作为参考。关于回滚的思路之后再讨论。



## 当前系统架构分析

### 现有流程的问题
根据代码分析，当前系统确实存在以下流程：
1. **声纹识别** → 通过 <mcfile name="voiceprint_provider.py" path="/home/ubuntu/prjs/xiaozhi-esp32-server-main/main/xiaozhi-server/core/utils/voiceprint_provider.py"></mcfile> 识别用户身份
2. **数据库查询** → 从 <mcfile name="SysUserEntity.java" path="/home/ubuntu/prjs/xiaozhi-esp32-server-main/main/manager-api/src/main/java/xiaozhi/modules/sys/entity/SysUserEntity.java"></mcfile> 中获取用户的腾讯云密钥
3. **MCP调用** → 使用获取的密钥调用腾讯云相关的MCP服务

这种方式确实会带来：
- **延迟增加**：每次都需要声纹识别 + 数据库查询
- **资源消耗**：重复的认证和查询操作
- **用户体验差**：响应时间较长

## 优化建议

### 1. 会话级密钥缓存
```python
class UserSession:
    def __init__(self, user_id, tencent_credentials):
        self.user_id = user_id
        self.tencent_cloud_id = tencent_credentials['id']
        self.tencent_cloud_key = tencent_credentials['key']
        self.last_activity = time.time()
        self.session_timeout = 3600  # 1小时
    
    def is_valid(self):
        return time.time() - self.last_activity < self.session_timeout
```

### 2. 智能认证策略
- **首次连接**：进行声纹识别 + 密钥获取
- **会话期间**：使用缓存的密钥，无需重复认证
- **定期刷新**：设置合理的会话超时时间

### 3. 预加载机制
```python
class MCPCredentialManager:
    def __init__(self):
        self.user_credentials = {}
    
    async def preload_user_credentials(self, user_id):
        """预加载用户凭据"""
        credentials = await self.db.get_user_tencent_credentials(user_id)
        self.user_credentials[user_id] = credentials
    
    def get_credentials(self, user_id):
        return self.user_credentials.get(user_id)
```

### 4. 分层认证架构

#### 设备级认证（一次性）
- 设备首次连接时进行声纹识别
- 建立设备与用户的绑定关系
- 生成设备专用的认证token

#### 会话级认证（周期性）
- 基于设备token进行快速认证
- 定期（如每小时）进行声纹验证
- 异常情况下触发重新认证

#### 操作级认证（按需）
- 敏感操作时进行额外验证
- 高价值MCP调用时的二次确认

### 5. 具体实现方案

#### 修改 <mcfile name="mcp_handler.py" path="/home/ubuntu/prjs/xiaozhi-esp32-server-main/main/xiaozhi-server/core/providers/tools/device_mcp/mcp_handler.py"></mcfile>
```python
class MCPClient:
    def __init__(self):
        # ... 现有代码 ...
        self.user_session = None
        self.credential_cache = {}
    
    async def ensure_user_credentials(self, force_refresh=False):
        """确保用户凭据可用"""
        if not force_refresh and self.user_session and self.user_session.is_valid():
            return self.user_session
        
        # 进行声纹识别
        user_id = await self.voiceprint_identify()
        if user_id:
            # 获取用户凭据
            credentials = await self.get_user_credentials(user_id)
            self.user_session = UserSession(user_id, credentials)
            return self.user_session
        
        return None
```

### 6. 配置优化

在 <mcfile name="config.yaml" path="/home/ubuntu/prjs/xiaozhi-esp32-server-main/main/xiaozhi-server/config.yaml"></mcfile> 中添加：
```yaml
auth:
  session_timeout: 3600  # 会话超时时间（秒）
  voiceprint_interval: 1800  # 声纹验证间隔（秒）
  credential_cache_size: 100  # 凭据缓存大小
  
mcp:
  tencent_cloud:
    credential_source: "user_session"  # 从用户会话获取
    fallback_credentials: "system"     # 备用系统凭据
```

## 实施建议

### 阶段一：会话缓存
1. 实现用户会话管理
2. 添加凭据缓存机制
3. 优化首次认证流程

### 阶段二：智能认证
1. 实现分层认证策略
2. 添加异常检测和重认证
3. 优化用户体验

### 阶段三：高级优化
1. 预测性凭据加载
2. 多用户并发优化
3. 安全性增强

这样的优化可以将响应时间从「声纹识别(2-3秒) + 数据库查询(0.1秒) + MCP调用」减少到「直接MCP调用」，大大提升用户体验。
        















