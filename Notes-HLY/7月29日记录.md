


## mcp-log-service 完整架构

```
mcp-log-service/
├── README.md                           # 项目说明文档
├── requirements.txt                    # Python依赖包
├── mcp_pipe.py                        # WebSocket通信管道
├── log_service_server.py              # 主MCP服务器
├── .env.example                       # 环境变量示例
├── .gitignore                         # Git忽略文件
├── docker-compose.yml                 # Docker编排文件
├── Dockerfile                         # Docker镜像构建文件
│
├── tools/                             # MCP工具集
│   ├── __init__.py
│   ├── cos_log_downloader.py          # COS日志下载工具
│   ├── dashboard_capture.py           # 仪表盘截图工具
│   ├── webhook_receiver.py            # Webhook接收工具
│   ├── log_analyzer.py                # 日志分析工具
│   ├── notification_sender.py         # 通知发送工具
│   ├── secret_manager.py              # 密钥管理工具
│   ├── health_checker.py              # 健康检查工具
│   └── batch_processor.py             # 批处理工具
│
├── config/                            # 配置文件目录
│   ├── __init__.py
│   ├── settings.py                    # 主配置文件
│   ├── cos_config.py                  # COS配置
│   ├── webhook_config.py              # Webhook配置
│   ├── notification_config.py         # 通知配置
│   ├── database_config.py             # 数据库配置
│   └── logging_config.py              # 日志配置
│
├── utils/                             # 工具类目录
│   ├── __init__.py
│   ├── logger.py                      # 日志工具
│   ├── redis_client.py                # Redis客户端
│   ├── database.py                    # 数据库操作
│   ├── encryption.py                  # 加密工具
│   ├── file_handler.py                # 文件处理工具
│   ├── time_utils.py                  # 时间工具
│   └── validation.py                  # 数据验证工具
│
├── models/                            # 数据模型
│   ├── __init__.py
│   ├── log_entry.py                   # 日志条目模型
│   ├── alert_model.py                 # 告警模型
│   ├── dashboard_model.py             # 仪表盘模型
│   └── secret_model.py                # 密钥模型
│
├── services/                          # 业务服务层
│   ├── __init__.py
│   ├── log_service.py                 # 日志服务
│   ├── alert_service.py               # 告警服务
│   ├── dashboard_service.py           # 仪表盘服务
│   ├── notification_service.py        # 通知服务
│   └── secret_service.py              # 密钥服务
│
├── sql/                               # 数据库脚本
│   ├── create_tables.sql              # 创建表脚本
│   ├── create_secret_tables.sql       # 创建密钥表脚本
│   ├── init_data.sql                  # 初始化数据
│   └── migrations/                    # 数据库迁移脚本
│       ├── 001_initial.sql
│       ├── 002_add_secrets.sql
│       └── 003_add_indexes.sql
│
├── tests/                             # 测试文件
│   ├── __init__.py
│   ├── test_tools/                    # 工具测试
│   │   ├── test_cos_downloader.py
│   │   ├── test_dashboard_capture.py
│   │   ├── test_secret_manager.py
│   │   └── test_webhook_receiver.py
│   ├── test_services/                 # 服务测试
│   │   ├── test_log_service.py
│   │   └── test_alert_service.py
│   └── test_integration/              # 集成测试
│       ├── test_mcp_server.py
│       └── test_end_to_end.py
│
├── scripts/                           # 脚本文件
│   ├── start.sh                       # 启动脚本
│   ├── stop.sh                        # 停止脚本
│   ├── setup_db.py                    # 数据库初始化脚本
│   ├── migrate_db.py                  # 数据库迁移脚本
│   └── health_check.py                # 健康检查脚本
│
├── docs/                              # 文档目录
│   ├── API.md                         # API文档
│   ├── DEPLOYMENT.md                  # 部署文档
│   ├── CONFIGURATION.md               # 配置文档
│   ├── TROUBLESHOOTING.md             # 故障排除
│   └── examples/                      # 使用示例
│       ├── basic_usage.py
│       ├── advanced_usage.py
│       └── integration_examples.py
│
├── logs/                              # 日志文件目录
│   ├── app.log
│   ├── error.log
│   └── access.log
│
└── data/                              # 数据文件目录
    ├── downloads/                     # 下载的日志文件
    ├── screenshots/                   # 仪表盘截图
    ├── exports/                       # 导出文件
    └── temp/                          # 临时文件
```

## 核心文件说明

### 1. 主要入口文件

- **`mcp_pipe.py`**: WebSocket通信管道，处理MCP协议通信
- **`log_service_server.py`**: 主MCP服务器，注册所有工具

### 2. 工具集 (`tools/`)

- **`cos_log_downloader.py`**: 从腾讯云COS下载日志文件
- **`dashboard_capture.py`**: 捕获Grafana等仪表盘截图
- **`webhook_receiver.py`**: 接收各种Webhook告警
- **`log_analyzer.py`**: 分析日志内容，提取关键信息
- **`notification_sender.py`**: 多渠道通知发送
- **`secret_manager.py`**: 密钥管理，从数据库获取和更新密钥
- **`health_checker.py`**: 系统健康检查
- **`batch_processor.py`**: 批量处理工具

### 3. 配置管理 (`config/`)

- **`settings.py`**: 主配置文件，整合所有配置
- **`cos_config.py`**: COS服务配置
- **`webhook_config.py`**: Webhook配置
- **`notification_config.py`**: 通知渠道配置
- **`database_config.py`**: 数据库连接配置

### 4. 工具类 (`utils/`)

- **`logger.py`**: 统一日志管理
- **`redis_client.py`**: Redis连接和操作
- **`database.py`**: 数据库连接池和操作
- **`encryption.py`**: 加密解密工具
- **`file_handler.py`**: 文件操作工具

### 5. 数据模型 (`models/`)

- **`log_entry.py`**: 日志条目数据模型
- **`alert_model.py`**: 告警数据模型
- **`secret_model.py`**: 密钥数据模型

### 6. 业务服务 (`services/`)

- **`log_service.py`**: 日志处理业务逻辑
- **`alert_service.py`**: 告警处理业务逻辑
- **`secret_service.py`**: 密钥管理业务逻辑

## 依赖关系图

```
log_service_server.py (主服务器)
├── tools/ (MCP工具)
│   ├── cos_log_downloader.py
│   ├── dashboard_capture.py
│   ├── webhook_receiver.py
│   ├── secret_manager.py
│   └── ...
├── services/ (业务服务)
│   ├── log_service.py
│   ├── alert_service.py
│   └── secret_service.py
├── config/ (配置管理)
│   ├── settings.py
│   └── ...
├── utils/ (工具类)
│   ├── logger.py
│   ├── redis_client.py
│   ├── database.py
│   └── ...
└── models/ (数据模型)
    ├── log_entry.py
    └── ...
```

## 启动流程

1. **初始化配置**: 加载 `config/settings.py` 中的所有配置
2. **建立连接**: 初始化数据库连接池、Redis连接
3. **注册工具**: 在 `log_service_server.py` 中注册所有MCP工具
4. **启动服务**: 通过 `mcp_pipe.py` 启动WebSocket服务
5. **健康检查**: 定期执行健康检查确保服务正常

## 特点

1. **模块化设计**: 每个功能独立成模块，便于维护和扩展
2. **配置分离**: 配置文件独立管理，支持不同环境
3. **安全性**: 密钥加密存储，支持密钥轮换
4. **可测试性**: 完整的测试覆盖，包括单元测试和集成测试
5. **可观测性**: 完善的日志记录和健康检查
6. **容器化**: 支持Docker部署，便于运维

这个架构提供了一个完整、可扩展、安全的日志服务MCP工具集，能够满足企业级的日志管理和监控需求。
        