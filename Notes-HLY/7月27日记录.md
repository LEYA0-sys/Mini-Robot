# 

## 已实现

用户可使用网站进行注册并且信息存储在数据库下，填写信息如下：

![image-20250727183239545](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727183239545-1753612361461-25.png)



下一步计划开始使用MCP依次实现下面的场景

# 主动触发场景设计

## 每日播报

### 场景描述

用户每日早上到达工位以后和小智打招呼，“你好，小智”，小智进行声纹识别后触发日志服务查询，获取日志并且LLM分析后生成摘要并语音播报。设计每日无论打多少次招呼只会在早上**主动**触发一次

下面是AI给出的具体流程

![image-20250727163709027](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727163709027-1753605430168-1.png)



### 必须需求

#### 关于播报内容（待确认）

每日小智主动播报的内容是告警内容还是日志内容，这决定了哪一个内容的播报是被动触发的

之前会议上提出要分析图像内容，这一块是要放在主动播报还是被动触发的部分

![image-20250727180646150](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727180646150-1753610807038-14.png)



#### 关于回滚（待确认）

这一块主要有两个场景设想，目前倾向于使用第一个场景：

1.回滚是主动触发的：小智在每日的固定时间比如早上5点（用户上班前）开始主动处理前一天的告警并回滚

##### 细化：

（1）限制回滚次数为n，超过了n次不再回滚而是添加到当日主动触发的播报内容中，告知用户集群中存在LLM无法解决的问题

（2）LLM给告警内容进行打分（1-10分）操作，分数越高代表告警越严重，需要及时处理并且回滚次数对应增加。

如下是AI给出的表格

![image-20250727173945565](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727173945565-1753609186515-3.png)



2.回滚是被动触发的：用户在小智播报完日志/告警内容后告知小智触发回滚功能



### 可拓展需求

#### 对于唤醒词

目前暂定一套固定的唤醒词，如“你好，小智”

计划：设计多套，或者用户可以自定义唤醒词，自行更改

#### 对于机器人名称

用户可以自定义机器人名字，不一定叫小智

#### 对于告警

考虑到机器人主动播报的内容用户听了以后大概率记不住，可以把每日播报的内容转发给用户的邮箱，具体场景如下：

![image-20250727174530382](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727174530382-1753609531874-5.png)

这个场景和腾讯云的主动推送告警不同之处在于：腾讯云推送的是由告警策略触发导致的告警，而这个场景推送的是由LLM处理后的日志/告警分析内容和告警处理结果，但是目前只是设想，最后推送的格式会进行确认

![image-20250727175107214](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727175107214-1753609868132-10.png)

# 被动触发场景设计

这个场景下是用户主动要求小智做的事情，目前写出的场景都是基于腾讯云平台的功能写出，实操过程会考虑是否可以真的写成MCP

## 容器服务

包括获取不同地域下不同集群不同节点池的信息、添加节点池、添加Yaml配置等



## 日志服务

创建告警策略、检索分析、创建日志集/日志主题、新建定时SQL分析

查看并分析仪表盘的图像，类似于下面

![image-20250727180124684](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727180124684-1753610485637-12.png)



![image-20250727180705890](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250727180705890-1753610826904-16.png)



# 腾讯云MCP服务架构设计总结

## 一、项目背景与目标
### 1.1 核心需求
- 主动日志播报 ：每日定时触发腾讯云CLS日志分析并语音播报
- 被动信息查询 ：用户语音查询腾讯云容器服务、日志等信息
- 智能告警处理 ：自动检测告警、评分、执行回滚操作
- 多渠道推送 ：支持邮件、微信、钉钉等方式推送播报内容
- 声纹身份认证 ：基于用户声纹进行身份验证和权限控制
### 1.2 设计原则
- 模块化架构 ：按功能领域拆分MCP服务，职责清晰
- 智能决策 ：LLM负责分析决策，MCP负责具体执行
- 安全可控 ：多层权限验证，操作审计，风险评估
- 可扩展性 ：支持新功能快速集成，配置灵活
- 用户友好 ：语音交互为主，配置简单，体验流畅
## 二、MCP服务架构设计
###  核心服务层
mcp-tencent-cloud-basic ：基础云服务集成

mcp-tencent-devops ：智能运维与告警处理

mcp-notification-push ：多渠道推送服务

mcp-tencent-analytics ：数据分析与洞察 

### 支撑服务层

身份认证模块 ：声纹识别与权限验证

数据库操作模块 ：统一数据访问接口

腾讯云SDK封装 ：API调用与错误处理

配置管理模块 ：动态配置与参数管理

## 三、核心功能模块详解

### 3.1 日志服务集成模块 主动日报功能
- 触发机制 ：基于 last_log_trigger_date 字段实现每日一次限制
- 时间窗口 ：支持配置有效触发时间段（如6:00-10:00）
- 数据获取 ：调用腾讯云CLS API获取指定时间范围日志
- 智能分析 ：LLM分析日志内容，生成结构化摘要
- 语音播报 ：转换为自然语言进行语音播报 被动查询功能
- 灵活查询 ：支持按时间、关键词、日志主题等条件查询
- 实时响应 ：即时调用API获取最新数据
- 结果处理 ：格式化查询结果，适配语音播报
### 3.2 容器服务管理模块 集群信息查询
- 集群列表 ：获取用户有权限的TKE集群信息
- 节点状态 ：查询集群节点健康状态和资源使用情况
- 工作负载 ：获取Pod、Service、Deployment等状态
- 资源监控 ：CPU、内存、存储等资源使用情况 运维操作支持
- 扩缩容操作 ：支持工作负载副本数调整
- 重启操作 ：支持Pod、Service重启
- 配置管理 ：ConfigMap、Secret等配置更新
### 3.3 智能告警处理模块 告警评分系统
- 多维度评分 ：
  - 影响范围（40%）：受影响服务数、用户数
  - 严重程度（30%）：资源使用率、错误率
  - 业务重要性（20%）：核心业务vs辅助功能
  - 时间敏感性（10%）：工作时间vs非工作时间
- 动态权重 ：根据历史数据调整评分权重
- 学习优化 ：基于回滚成功率优化评分模型 智能回滚策略
- 分级回滚 ：
  
  - 90-100分：6次回滚机会，激进策略
  - 70-89分：4次回滚机会，标准策略
  - 50-69分：3次回滚机会，保守策略
  - 30-49分：2次回滚机会，快速转播报
  - 0-29分：1次回滚机会，主要依赖播报
- 渐进式操作 ：
  
  - 第1次：轻量级操作（重启、配置刷新）
  - 第2次：中等影响（扩容、负载调整）
  - 第3次：重大变更（版本回滚）
  - 第4次：紧急措施（服务隔离）
  - 第5次：全面回滚
  - 第6次：人工介入播报 安全控制机制
- 权限验证 ：基于用户 rollback_permission 字段控制操作权限
- 操作限制 ：时间窗口、频率限制、影响范围评估
- 审计日志 ：完整记录所有回滚操作和决策过程
- 回滚点管理 ：自动创建操作前检查点，支持快速恢复
### 3.4 多渠道推送模块 推送方式支持
- 邮件推送 ：
  
  - 语音配置邮箱地址
  - 支持HTML格式邮件
  - 附件支持（日志文件、报告等）
- 微信集成 ：
  
  - 专属推送群机器人
  - 二维码快速加入
  - 富文本消息支持
- 钉钉集成 ：
  
  - Webhook机器人推送
  - 支持@特定用户
  - 卡片消息格式
- 分享链接 ：
  
  - 生成临时访问链接
  - 支持多种分享方式
  - 可设置过期时间 推送配置管理
- 语音配置 ：通过语音指令设置推送偏好
- 动态调整 ：支持实时修改推送方式和目标
- 批量推送 ：支持同时推送到多个渠道
- 推送状态跟踪 ：记录推送成功率和用户反馈
### 3.5 数据分析与洞察模块 日志分析能力
- 趋势分析 ：识别日志量、错误率等趋势变化
- 异常检测 ：基于历史基线检测异常模式
- 关键词提取 ：自动提取重要信息和关键事件
- 智能摘要 ：生成结构化的日志摘要报告 性能监控分析
- 资源使用分析 ：CPU、内存、网络等资源使用趋势
- 性能瓶颈识别 ：自动识别系统性能瓶颈
- 容量规划建议 ：基于历史数据预测资源需求
- 优化建议生成 ：提供具体的性能优化建议 运维效果评估
- 回滚成功率统计 ：按时间、服务类型统计回滚效果
- 告警处理效率 ：分析告警响应时间和解决率
- 策略优化建议 ：基于数据分析优化回滚策略

## 四.架构设计

```
mcp-tencent-cloud/
├── services/
│   ├── basic_service.py          # 基础云服务MCP
│   ├── devops_service.py         # 智能运维MCP
│   ├── push_service.py           # 推送服务MCP
│   └── analytics_service.py      # 数据分析MCP
├── utils/
│   ├── tencent_client.py         # 腾讯云SDK封装
│   ├── database.py               # 数据库操作工具
│   ├── auth.py                   # 身份认证工具
│   ├── alert_scorer.py           # 告警评分算法
│   ├── rollback_strategies.py    # 回滚策略实现
│   └── push_handlers.py          # 推送处理器
├── config/
│   ├── settings.py               # 配置管理
│   ├── alert_rules.json          # 告警规则配置
│   └── rollback_config.json      # 回滚策略配置
├── tests/
│   ├── test_basic_service.py     # 基础服务测试
│   ├── test_devops_service.py    # 运维服务测试
│   └── test_push_service.py      # 推送服务测试
├── docs/
│   ├── API.md                    # API文档
│   ├── DEPLOYMENT.md             # 部署指南
│   └── CONFIGURATION.md          # 配置说明
├── requirements.txt              # Python依赖
├── docker-compose.yml            # Docker部署配置
└── README.md                     # 项目说明
```

## 五.实施路线图
### 第一阶段：核心基础服务
#### 目标

建立基础的腾讯云服务连接和核心功能

#### 实施内容

- 部署 mcp-tencent-cloud 服务

- 实现基础的日志查询、容器管理、认证功能

- 完成数据库表结构扩展（ sys_user 表添加 push_config 字段）

- 基础的MCP工具测试和验证

  #### 验收标准

- 能够正常连接腾讯云API

- 基础日志查询功能正常

- 容器状态监控可用
### 第二阶段：智能运维服务
#### 目标

实现告警处理和自动回滚核心功能

#### 实施内容

- 部署 mcp-tencent-devops 服务
- 实现告警评分系统
- 开发自动回滚机制
- 完成 alert_rules 、 rollback_operations 、 broadcast_queue 表创建
- 集成LLM决策 + MCP执行架构

  #### 验收标准

- 告警评分算法正常工作
- 自动回滚功能可用
- 播报机制正常触发
### 第三阶段：数据分析服务
#### 目标

提供深度数据分析和智能洞察

#### 实施内容

- 部署 mcp-tencent-analytics 服务
- 实现日志分析和性能监控
- 开发智能洞察功能
- 建立学习优化机制
- 完善整体系统监控

  #### 验收标准

- 日志分析报告生成正常
- 性能趋势分析可用
- 智能建议功能正常
### 第四阶段：多渠道通知服务
#### 目标

 实现邮件、微信、钉钉等多渠道推送

#### 实施内容

- 部署 mcp-notification-push 服务
- 实现邮件转发功能
- 集成微信/钉钉推送（推荐优先微信）
- 开发语音配置邮箱功能
- 完善推送配置管理

  #### 验收标准

- 每日播报邮件转发正常
- 微信推送功能可用
- 语音配置邮箱功能正常

## 六、风险评估与应对
### 技术风险
- API限制 ：腾讯云API调用频率和配额限制
  - 应对：实现缓存机制，优化API调用策略
- 网络延迟 ：云服务API调用延迟影响用户体验
  - 应对：异步处理，超时控制，降级策略
- 数据安全 ：用户敏感信息和云服务凭证安全
  - 应对：加密存储，权限控制，审计日志
### 业务风险
- 误操作风险 ：自动回滚可能导致服务中断
  - 应对：多层安全检查，操作前确认，回滚点管理
- 权限滥用 ：用户权限过大可能导致安全问题
  - 应对：细粒度权限控制，操作审计，异常检测
### 运维风险
- 服务依赖 ：MCP服务故障影响整体功能
  - 应对：服务监控，自动重启，降级模式
- 数据一致性 ：多服务间数据同步问题
  - 应对：事务管理，数据校验，定期同步
## 七.成功指标与评估

最基本的要求：最后的评估标准是MCP的正确调用率要达到90%？

![5101dc4101d84f8583b96bf464265d27](./7%E6%9C%8827%E6%97%A5%E8%AE%B0%E5%BD%95.assets/5101dc4101d84f8583b96bf464265d27-1753611388768-21.png)





下面的指标的AI给的，先不用看

### 功能指标

- 日报触发成功率 ≥ 95%
- 告警处理响应时间 ≤ 30秒
- 回滚操作成功率 ≥ 85%
- 推送到达率 ≥ 90%
### 性能指标
- API调用平均延迟 ≤ 2秒
- 服务可用性 ≥ 99.5%
- 并发处理能力 ≥ 100请求/分钟
### 用户体验指标
- 语音识别准确率 ≥ 95%
- 用户满意度 ≥ 4.5/5.0
- 功能使用率 ≥ 80%