# UVå·¥å…·çš„å®‰è£…ä¸ä½¿ç”¨

## ä»€ä¹ˆæ˜¯uvå·¥å…·

`uv` æ˜¯ä¸€ä¸ªç”¨äº Python åŒ…ç®¡ç†çš„ç°ä»£å·¥å…·ï¼Œå®ƒæ—¨åœ¨æ›¿ä»£ `pip` å’Œ `virtualenv`ï¼Œæä¾›æ›´å¿«ã€æ›´é«˜æ•ˆçš„åŒ…å®‰è£…ä¸è™šæ‹Ÿç¯å¢ƒç®¡ç†ä½“éªŒã€‚`uv` æ˜¯ç”± Astral å›¢é˜Ÿå¼€å‘çš„ï¼Œå¹¶é€æ¸æˆä¸º Python ç¤¾åŒºä¸­çš„ä¸€ä¸ªçƒ­é—¨æ›¿ä»£å·¥å…·ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œ`uv` æ˜¯ä¸€ä¸ª **è¶…å¿«çš„ Python åŒ…ç®¡ç†å™¨**ï¼Œå®ƒé›†æˆäº†ï¼š

- åŒ…å®‰è£…ï¼ˆæ›¿ä»£ `pip`ï¼‰
- è™šæ‹Ÿç¯å¢ƒç®¡ç†ï¼ˆæ›¿ä»£ `virtualenv`ï¼‰
- é”å®šæ–‡ä»¶ï¼ˆå…¼å®¹ `pip-tools` å’Œ `Poetry`ï¼‰

## uvçš„ä¼˜åŠ¿

- ğŸš€ **æå¿«çš„å®‰è£…é€Ÿåº¦**ï¼šåŸºäº Rust å®ç°ï¼Œé€Ÿåº¦æ¯” pip å¿«ä¸Šå‡ åå€
- ğŸ“¦ **è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**ï¼šç±»ä¼¼ Poetryï¼Œæ— éœ€æ‰‹åŠ¨æ¿€æ´»
- ğŸ” **é”å®šä¾èµ–**ï¼šç”Ÿæˆ `uv.lock` æ–‡ä»¶ï¼Œç¡®ä¿å¯é‡å¤æ„å»º
- ğŸ **å…¼å®¹æ€§å¼º**ï¼šå…¼å®¹ `pyproject.toml`ï¼Œæ— ç¼å¯¹æ¥ç°æœ‰é¡¹ç›®
- ğŸ“ **ç¼“å­˜æœºåˆ¶ä¼˜ç§€**ï¼šå……åˆ†åˆ©ç”¨ç¼“å­˜ï¼ŒåŠ å¿«å®‰è£…æµç¨‹

## uvå·¥å…·å¿«é€Ÿä½¿ç”¨

ä»¥ä¸‹æ˜¯å¿«é€Ÿä¸Šæ‰‹ uv çš„æ­¥éª¤ï¼š

### å®‰è£… uv

`Linux`æ“ä½œç³»ç»Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…

```
curl -Ls https://astral.sh/uv/install.sh | bash
```

å¦‚æœç”µè„‘ä¸­å®‰è£…è¿‡`Python`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`pip`å‘½ä»¤å®‰è£…ï¼š

```
pip install uv
```

### åˆå§‹åŒ–é¡¹ç›®

åœ¨æ¡Œé¢åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹`uv_test`

![image-20250417180502853](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417180502853.png)

æ‰“å¼€æ–‡ä»¶å¤¹ï¼Œå³é”®æ–‡ä»¶å¤¹ç©ºç™½å¤„ï¼Œç‚¹å‡»åœ¨ç»ˆç«¯æ‰“å¼€

![image-20250417180525916](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417180525916.png)

è¾“å…¥`uv init`å³å¯åˆå§‹åŒ–`uv`å·¥ç¨‹ã€‚

```
uv init
```

![image-20250417180621322](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417180621322.png)

> `uv`å·¥ç¨‹é»˜è®¤ä¼šç”Ÿæˆ4ä¸ªæ–‡ä»¶ï¼š
>
> `.python-version`ï¼šè®°å½•å½“å‰å·¥ç¨‹çš„`Python`ç‰ˆæœ¬ã€‚
>
> `main.py`ï¼šä¸»è„šæœ¬ã€‚
>
> `pyproject.toml`ï¼šè®°å½•å½“å‰`uv`å·¥ç¨‹çš„ä¾èµ–æƒ…å†µã€‚
>
> `README.md`ï¼šå·¥ç¨‹çš„è¯´æ˜æ–‡ä»¶ã€‚

### ç”Ÿæˆè™šæ‹Ÿç¯å¢ƒ

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥ä¸ºé¡¹ç›®åˆå§‹åŒ–ä¸€ä¸ª`Python`è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®š`Python`è§£é‡Šå™¨ç‰ˆæœ¬ã€‚

```
uv venv --python 3.10
```

![image-20250417181245476](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181245476.png)

> ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›´æ¥åˆ›å»ºå·¥ç¨‹å¹¶æŒ‡å®š`python`è§£é‡Šå™¨ç‰ˆæœ¬ã€‚
>
> å¤åˆ¶
>
> ```
> uv init uv_test -p 3.10
> ```

### æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

è¾“å…¥ä»¥ä¸‹å‘½ä»¤å³å¯æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

```
.\.venv\Scripts\activate
```

![image-20250417181358365](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181358365.png)

### ä¸‹è½½ç¬¬ä¸‰æ–¹åº“

```
uv add pandas opencv-python
```

![image-20250417181502610](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181502610.png)

è¾“å…¥å‘½ä»¤`uv tree`ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰è™šæ‹Ÿç¯å¢ƒä¸­çš„ä¾èµ–æ ‘

```
uv tree
```

![image-20250417181541837](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181541837.png)

å¯ä»¥çœ‹åˆ°å‰é¢å®‰è£…çš„`pandas`å’Œ`opencv`éƒ½å®‰è£…æˆåŠŸäº†ã€‚

## å¸è½½ç¬¬ä¸‰æ–¹åº“

ä¾‹å¦‚ï¼Œå¸è½½`pandas`åº“ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤



```
uv remove pandas
```

![image-20250417181657976](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181657976.png)

å†æ¬¡æŸ¥çœ‹ä¾èµ–æ ‘

```
uv tree
```

![image-20250417181719673](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181719673.png)

å¯ä»¥çœ‹åˆ°`pandas`åº“å·²ç»è¢«å¸è½½ã€‚

### æ‰§è¡Œå‘½ä»¤

åˆå§‹åŒ–`uv`å·¥ç¨‹æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸»è„šæœ¬`main.py`ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œ`Python`è„šæœ¬ã€‚

```
uv run main.py
```

![image-20250417182312761](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417182312761.png)

## uvçš„å…¶ä»–åŸºæœ¬å‘½ä»¤

### uv pip

```
uv`å·¥å…·ä¸­ä¹Ÿæœ‰`pip`åŠŸèƒ½å¯ä»¥è°ƒç”¨ï¼Œé€šè¿‡`uv pip`è¿›è¡Œè°ƒç”¨ï¼Œä¾‹å¦‚ä¸‹è½½`pandas`åº“ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`pip
```

```
uv pip install pandas
```

![image-20250417181900514](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181900514.png)

é€šè¿‡`pip`ä¸‹è½½çš„å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ä¾èµ–åˆ—è¡¨ã€‚

```
uv pip list
```

![image-20250417181958953](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417181958953.png)

> å¦‚æœä½ ä¸é€‚åº”`uv`çš„å‘½ä»¤ï¼Œä½ ä¹Ÿå®Œå…¨å¯ä»¥é€šè¿‡`uv pip`çš„æ–¹å¼å»è°ƒç”¨`pip`å·¥å…·çš„ç›¸å…³å‘½ä»¤ï¼Œå®ƒæ¯”åŸç”Ÿçš„`pip`å‘½ä»¤æ›´ä¸ºé«˜æ•ˆã€‚

### uv sync

æ¯ä¸ª`uv`å·¥ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ª`pyproject.toml`æ–‡ä»¶ï¼Œç”¨äºè®°å½•è¯¥å·¥ç¨‹çš„ä¾èµ–ç¯å¢ƒã€‚æ¯æ¬¡ä½¿ç”¨`uv`å‘½ä»¤å»ä¸‹è½½æˆ–è€…ä¿®æ”¹ä¾èµ–éƒ½ä¼šé€ æˆ`pyproject.toml`æ–‡ä»¶çš„å˜åŒ–ã€‚

åœ¨ä½¿ç”¨åˆ«äººçš„`uv`å·¥ç¨‹æ—¶ï¼Œå¯ä»¥é€šè¿‡`uv sync`å‘½ä»¤ä¸€é”®å…‹éš†å…¶ç¯å¢ƒä¾èµ–ï¼ˆåŒ…å«`Python`ç‰ˆæœ¬ï¼‰ã€‚

> æ³¨æ„ï¼šä½¿ç”¨`uv pip`å®‰è£…çš„ä¾èµ–ï¼Œä¸ä¼šè®°å½•åœ¨`pyproject.toml`æ–‡ä»¶ä¸­ã€‚

### uv python

`uv`å¯ä»¥æå‰ç¼“å­˜å¤šä¸ªç‰ˆæœ¬çš„`python`è§£é‡Šå™¨ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹å¹¶å®‰è£…ã€‚

```
# æ˜¾ç¤ºå½“å‰å·²ç»å®‰è£…çš„å’Œå¯ä¾›å®‰è£…çš„Pythonç‰ˆæœ¬
uv python list
```

![image-20250417182813189](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417182813189.png)

å·²ç»å®‰è£…å¥½çš„ï¼Œåœ¨è¾“å‡ºç»“æœä¸­ä¼šå‘ˆç°è“è‰²ã€‚

```
# ä½ å¯ä»¥æå‰ç¼“å­˜pythonæŒ‡å®šç‰ˆæœ¬ï¼Œè¿™æ ·åç»­åœ¨å…¶ä»–é¡¹ç›®ä¸­å®‰è£…Pythonç¯å¢ƒæ—¶ï¼Œä¸éœ€è¦ä¸‹è½½ã€‚
uv python install 3.10 3.11 3.12
```

![image-20250417183002601](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417183002601.png)

```
# å¸è½½ç¼“å­˜çš„æŒ‡å®šPythonç‰ˆæœ¬
uv python uninstall 3.12
```

![image-20250417183038541](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417183038541.png)

```
# åˆ‡æ¢å½“å‰å·¥ç¨‹çš„Pythonç‰ˆæœ¬
uv python pin 3.11
uv sync
```

![image-20250417184402723](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250417184402723.png)

> æ­¤å‘½ä»¤åªä¼šå…ˆä¿®æ”¹`.python-version`æ–‡ä»¶å†…å®¹ï¼Œå¦‚æœè¦æ›´æ–°`Python`è§£é‡Šå™¨æ–‡ä»¶ï¼Œåˆ™éœ€è¦æ‰§è¡Œ`uv sync`ï¼Œå› ä¸ºä¿®æ”¹äº†`Python`ç‰ˆæœ¬ï¼Œå¯¹åº”çš„ä¾èµ–ä¹Ÿéœ€è¦è·Ÿä¹Ÿ`Python`ç‰ˆæœ¬å»é‡æ–°æ›´æ–°ã€‚

# ä»0å¼€å§‹å®ç°MCP-Server

## MCP Serveræ¦‚å¿µ

`MCP Server` æ˜¯ä¸€ä¸ªä¸­é—´å±‚æœåŠ¡å™¨ï¼Œå®ƒä¸»è¦è´Ÿè´£å¤„ç†å’Œç®¡ç† AI æ¨¡å‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç¡®ä¿æ¨¡å‹èƒ½å¤Ÿé«˜æ•ˆä¸”å‡†ç¡®åœ°ç†è§£å’Œå“åº”ç”¨æˆ·è¯·æ±‚ã€‚å®ƒä½œä¸ºåº”ç”¨ç¨‹åºå’Œ`AI`æ¨¡å‹ä¹‹é—´çš„æ¡¥æ¢ï¼Œä¼˜åŒ–äº†ä¿¡æ¯çš„ä¼ é€’å’Œå¤„ç†è¿‡ç¨‹ã€‚

æ ¹æ®MCPåè®®å®šä¹‰ï¼ŒServerå¯ä»¥æä¾›ä¸‰ç§ç±»å‹çš„æ ‡å‡†èƒ½åŠ›ï¼Œ**Resourcesã€Toolsã€Prompts**ï¼Œæ¯ä¸ªServerå¯åŒæ—¶æä¾›è€…ä¸‰ç§ç±»å‹èƒ½åŠ›æˆ–å…¶ä¸­ä¸€ç§ã€‚

- **Resourcesï¼š**èµ„æºï¼Œç±»ä¼¼äºæ–‡ä»¶æ•°æ®è¯»å–ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶èµ„æºæˆ–æ˜¯APIå“åº”è¿”å›çš„å†…å®¹ã€‚
- **Toolsï¼š**å·¥å…·ï¼Œç¬¬ä¸‰æ–¹æœåŠ¡ã€åŠŸèƒ½å‡½æ•°ï¼Œé€šè¿‡æ­¤å¯æ§åˆ¶LLMå¯è°ƒç”¨å“ªäº›å‡½æ•°ã€‚
- **Promptsï¼š**æç¤ºè¯ï¼Œä¸ºç”¨æˆ·é¢„å…ˆå®šä¹‰å¥½çš„å®Œæˆç‰¹å®šä»»åŠ¡çš„æ¨¡æ¿ã€‚

## MCPé€šä¿¡æ–¹å¼

`MCPï¼ˆModel Context Protocolï¼‰`æ˜¯ä¸€ç§ä¸ºäº†ç»Ÿä¸€å¤§è§„æ¨¡æ¨¡å‹å’Œå·¥å…·é—´é€šä¿¡è€Œè®¾è®¡çš„åè®®ï¼Œå®ƒå®šä¹‰äº†æ¶ˆæ¯æ ¼å¼å’Œé€šä¿¡æ–¹å¼ã€‚MCP åè®®æ”¯æŒå¤šç§ä¼ è¾“æœºåˆ¶ï¼Œå…¶ä¸­åŒ…æ‹¬ `stdio`ã€`Server-Sent Eventsï¼ˆSSEï¼‰` å’Œ `Streamable HTTP`ã€‚

## Stdio ä¼ è¾“ï¼ˆStandard Input/Outputï¼‰

`stdio` ä¼ è¾“æ–¹å¼æ˜¯æœ€ç®€å•çš„é€šä¿¡æ–¹å¼ï¼Œé€šå¸¸åœ¨æœ¬åœ°å·¥å…·ä¹‹é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’æ—¶ä½¿ç”¨ã€‚å®ƒåˆ©ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºï¼ˆ`stdin/stdout`ï¼‰ä½œä¸ºæ•°æ®ä¼ è¾“é€šé“ï¼Œé€‚ç”¨äºæœ¬åœ°è¿›ç¨‹é—´çš„äº¤äº’ã€‚

- **å·¥ä½œæ–¹å¼**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºæµï¼ˆ`stdin/stdout`ï¼‰è¿›è¡Œé€šä¿¡ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤å’Œæ•°æ®ï¼ŒæœåŠ¡å™¨æ‰§è¡Œå¹¶é€šè¿‡æ ‡å‡†è¾“å‡ºè¿”å›ç»“æœã€‚
- **åº”ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºæœ¬åœ°å¼€å‘ã€å‘½ä»¤è¡Œå·¥å…·ã€è°ƒè¯•ç¯å¢ƒï¼Œæˆ–è€…æ¨¡å‹å’Œå·¥å…·æœåŠ¡åœ¨åŒä¸€è¿›ç¨‹å†…è¿è¡Œçš„æƒ…å†µã€‚

## Server-Sent Eventsï¼ˆSSEï¼‰

`SSE` æ˜¯åŸºäº `HTTP` åè®®çš„æµå¼ä¼ è¾“æœºåˆ¶ï¼Œå®ƒå…è®¸æœåŠ¡å™¨é€šè¿‡ `HTTP` å•å‘æ¨é€äº‹ä»¶åˆ°å®¢æˆ·ç«¯ã€‚`SSE` é€‚ç”¨äºå®¢æˆ·ç«¯éœ€è¦æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨äºå®æ—¶æ•°æ®æ›´æ–°ã€‚

- **å·¥ä½œæ–¹å¼**ï¼šå®¢æˆ·ç«¯é€šè¿‡ `HTTP GET` è¯·æ±‚å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ï¼ŒæœåŠ¡å™¨ä»¥æµå¼æ–¹å¼æŒç»­å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œå®¢æˆ·ç«¯é€šè¿‡è§£ææµæ•°æ®æ¥è·å–å®æ—¶ä¿¡æ¯ã€‚
- **åº”ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºéœ€è¦æœåŠ¡å™¨ä¸»åŠ¨æ¨é€æ•°æ®çš„åœºæ™¯ï¼Œå¦‚å®æ—¶èŠå¤©ã€å¤©æ°”é¢„æŠ¥ã€æ–°é—»æ›´æ–°ç­‰ã€‚

## Streamable HTTP

`Streamable HTTP` æ˜¯ `MCP` åè®®ä¸­æ–°å¼•å…¥çš„ä¸€ç§ä¼ è¾“æ–¹å¼ï¼Œå®ƒåŸºäº `HTTP` åè®®æ”¯æŒåŒå‘æµå¼ä¼ è¾“ã€‚ä¸ä¼ ç»Ÿçš„ `HTTP` è¯·æ±‚å“åº”æ¨¡å‹ä¸åŒï¼Œ`Streamable HTTP` å…è®¸æœåŠ¡å™¨åœ¨ä¸€ä¸ªé•¿è¿æ¥ä¸­å®æ—¶å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒå¤šä¸ªè¯·æ±‚å’Œå“åº”çš„æµå¼ä¼ è¾“ã€‚

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`MCP`åªæä¾›äº†`Streamable HTTP`åè®®å±‚çš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯è§„èŒƒäº†`MCP`å®¢æˆ·ç«¯åœ¨ä½¿ç”¨`Streamable HTTP`é€šä¿¡æ—¶çš„é€šä¿¡è§„åˆ™ï¼Œè€Œå¹¶æ²¡æœ‰æä¾›ç›¸å…³çš„`SDK`å®¢æˆ·ç«¯ã€‚å¼€å‘è€…åœ¨å¼€å‘`Streamable HTTP`æœºåˆ¶ä¸‹çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ¯”å¦‚`Python httpx`åº“è¿›è¡Œå¼€å‘ã€‚

- **å·¥ä½œæ–¹å¼**ï¼šå®¢æˆ·ç«¯é€šè¿‡ `HTTP``POST` å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¹¶å¯ä»¥æ¥æ”¶æµå¼å“åº”ï¼ˆå¦‚ `JSON-RPC` å“åº”æˆ– `SSE` æµï¼‰ã€‚å½“è¯·æ±‚æ•°æ®è¾ƒå¤šæˆ–éœ€è¦å¤šæ¬¡äº¤äº’æ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡é•¿è¿æ¥å’Œåˆ†æ‰¹æ¨é€çš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚
- **åº”ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºéœ€è¦æ”¯æŒé«˜å¹¶å‘ã€ä½å»¶è¿Ÿé€šä¿¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯è·¨æœåŠ¡æˆ–è·¨ç½‘ç»œçš„åº”ç”¨ã€‚é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯ï¼Œå¦‚å®æ—¶æµåª’ä½“ã€åœ¨çº¿æ¸¸æˆã€é‡‘èäº¤æ˜“ç³»ç»Ÿç­‰ã€‚

## MCP Serverå®ç°æµç¨‹

åœ¨æœ¬æ•™ç¨‹ä¸­å°†å¸¦é¢†å¤§å®¶ä¸€èµ·å®ç°ä¸€ä¸ªç±»ä¼¼äº`MCP`å®˜ç½‘çš„å¤©æ°”æŸ¥è¯¢`MCP Server`ï¼Œä½†æ˜¯ä¸å®˜ç½‘çš„`MCP`ç¤ºä¾‹ä¸åŒçš„æ˜¯ï¼Œå®˜ç½‘çš„å¤©æ°”æŸ¥è¯¢ä»…ä»…æ”¯æŒç¾å›½çš„å·å¸‚ï¼Œæ— æ³•æŸ¥è¯¢ä¸­å›½åŸå¸‚çš„å¤©æ°”æƒ…å†µã€‚æ‰€ä»¥ï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œä½¿ç”¨çš„æ˜¯`openweather`çš„å…è´¹æ¥å£ï¼Œå®ç°å…¨ä¸–ç•Œå„åœ°çš„ä¸€ä¸ªé€šç”¨å¤©æ°”æŸ¥è¯¢`MCP`æœåŠ¡ã€‚

## ä¸šåŠ¡åŠŸèƒ½å®ç°

è¿›å…¥`OpenWeather`å®˜ç½‘ï¼ˆhttps://openweathermap.org/ï¼‰ï¼Œç„¶åä½¿ç”¨è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œä¸€ä¸ªè´¦å·ã€‚

![image-20250418145737828](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418145737828.png)

æ¥ç€æˆ‘ä»¬éœ€è¦ç”³è¯·ä¸€ä¸ª`API Keys`ï¼Œç”¨äºåæœŸæ¥å£æ ¡éªŒã€‚ç‚¹å‡»`My APIKeys`ã€‚

![image-20250418145826431](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418145826431.png)

é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨ç»™ä½ ç”Ÿæˆä¸€ä¸ª`API Keys`ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨é»˜è®¤ç”Ÿæˆçš„`API Keys`ï¼Œæˆ–è€…è‡ªå·±é‡æ–°åˆ›å»ºä¸€ä¸ª`API Keys`ã€‚

![image-20250418150008898](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418150008898.png)

è™½ç„¶ä¸¤è€…éƒ½å¯ä»¥ï¼Œä½†æ˜¯å»ºè®®å¤§å®¶ç›´æ¥ä½¿ç”¨é»˜è®¤çš„`API Keys`å³å¯ï¼Œå› ä¸ºåˆ›å»ºæ–°çš„`API Keys`åï¼Œéœ€è¦ç­‰5åˆ†é’Ÿå·¦å³æ‰èƒ½ç”Ÿæ•ˆã€‚é»˜è®¤çš„`API Keys`åªéœ€è¦3åˆ†é’Ÿå·¦å³å³å¯ä½¿ç”¨ã€‚

å¤åˆ¶è‡ªå·±çš„`API Keys`åï¼Œç‚¹å‡»èœå•æ ä¸Šçš„`API`å³å¯å¼€å§‹é€‰æ‹©è‡ªå·±æ‰€éœ€è¦çš„æœåŠ¡ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`OpenWeather`æœ‰å¾ˆå¤šå…³äºå¤©æ°”çš„æœåŠ¡ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰æœåŠ¡éƒ½æ˜¯å…è´¹çš„ï¼Œä½ éœ€è¦æ ¹æ®ä»–çš„æè¿°ï¼Œé€‰æ‹©è‡ªå·±æ‰€éœ€è¦çš„æœåŠ¡å³å¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥é€‰æ‹©`Current Weather Data`æ¥å£ï¼Œè¯¥æ¥å£æ˜¯å…è´¹çš„ã€‚ç‚¹å‡»å…¶å¯¹åº”çš„`API doc`ã€‚

![image-20250418150312577](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418150312577.png)

è¯¥æ¥å£ä¹Ÿæœ‰å¾ˆå¤šç§è¯·æ±‚æ–¹å¼ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸¤ç§ã€‚

1. é€šè¿‡ç»çº¬åº¦ï¼Œè¯·æ±‚å¯¹åº”ç»çº¬åº¦çš„å½“å‰å¤©æ°”æƒ…å†µã€‚

![image-20250418150456587](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418150456587-1752657820345-47.png)

1. é€šè¿‡åŸå¸‚åç§°ï¼ŒæŸ¥è¯¢å¯¹åº”åŸå¸‚åç§°çš„å½“å‰å¤©æ°”æƒ…å†µã€‚

![image-20250418150555253](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418150555253.png)

æ— è®ºæ˜¯å“ªç§è¯·æ±‚æ–¹å¼ï¼Œ`API Key`éƒ½æ˜¯å¿…å¡«å‚æ•°ã€‚

æˆ‘ä»¬æœ‰äº†è‡ªå·±çš„`API Key`åï¼Œå¯ä»¥ç›´æ¥é€šè¿‡æµè§ˆå™¨è¯·æ±‚çš„æ–¹å¼ï¼ŒéªŒè¯å½“å‰æ¥å£æ˜¯å¦å¯ç”¨ã€‚ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥`url`å³å¯ã€‚

æ¯”å¦‚ï¼Œæˆ‘é€šè¿‡æŒ‡å®šåŸå¸‚åç§°ä¸ºwuhanï¼ŒæŸ¥è¯¢æ­¦æ±‰å¯¹åº”çš„å¤©æ°”æƒ…å†µã€‚

```plain
https://api.openweathermap.org/data/2.5/weather?q=wuhan&appid={API key}
```

æ³¨æ„ï¼š{API key}éœ€è¦æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ã€‚(ligang:f543ca6fa6c3e75e8ac30cc2c89ca753)

æœ‰ä»¥ä¸‹è¿”å›ï¼Œè¯´æ˜æ¥å£æ˜¯å¯ç”¨çš„ã€‚

![image-20250418150851828](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418150851828.png)

å¦‚æœè¿”å›ä»¥ä¸‹å†…å®¹ï¼Œè¯´æ˜`API Key`æœªç”Ÿæ•ˆï¼Œæˆ–è€…`API Key`é”™è¯¯ã€‚å¦‚æœæ˜¯æ£€æŸ¥äº†`API Key`ç¡®å®šæ²¡æœ‰å¡«å†™é”™è¯¯ï¼Œé‚£ä¹ˆè¯·ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•ã€‚

![image-20250418150942804](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418150942804.png)

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æ”¯æŒå¦‚ä½•é€šè¿‡ç»çº¬åº¦å’Œåœ°åè·å–å¤©æ°”äº†ï¼Œæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å°†è¯¥æœåŠ¡å°è£…æœª`MCP Server`ã€‚

## MCP ServeråŠŸèƒ½ç¼–å†™

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆæµ‹è¯•`stdio`é€šä¿¡æ–¹å¼ï¼Œé‡‡ç”¨æœ¬åœ°å¼€å¯ä¸€ä¸ª`MCP Server`çš„æ–¹å¼å®ç°ã€‚

é¦–å…ˆï¼Œä½¿ç”¨`uv`å·¥å…·ï¼Œåˆ›å»ºé¡¹ç›®å¹¶å®‰è£…ç›¸å…³ä¾èµ–ã€‚è¿™é‡Œæˆ‘å°†é¡¹ç›®æ”¾åˆ°`D`ç›˜çš„æ ¹ç›®å½•ï¼Œåœ¨`D`ç›˜ä¸‹æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ã€‚

```plain
uv init weather_mcp_server -p 3.10
```

![image-20250418152617215](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418152617215.png)

æ¥ç€è¿›å…¥`uv`å·¥ç¨‹ã€‚

ç„¶åè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚

![image-20250418152838376](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418152838376.png)

æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

![image-20250418152913928](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418152913928.png)

ç”±äºæˆ‘ç”µè„‘ä¸­é»˜è®¤ä¼šæ¿€æ´»ä¸€ä¸ª`conda`çš„`base`è™šæ‹Ÿç¯å¢ƒï¼Œæ‰€ä»¥å†æ¿€æ´»`uv`å·¥ç¨‹çš„è™šæ‹Ÿç¯å¢ƒåï¼Œåœ¨è·¯å¾„å‰é¢å‡ºç°äº†ä¸¤ä¸ª`()`ï¼Œæ•…æˆ‘è¿˜éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€€å‡º`conda`çš„`base`è™šæ‹Ÿç¯å¢ƒã€‚

å®‰è£…ä¾èµ–

![image-20250418153323532](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418153323532.png)

ä¾èµ–å‡†å¤‡å®Œæˆï¼Œæ¥ä¸‹æ¥å¼€å§‹ä»£ç ç¼–å†™éƒ¨åˆ†å†…å®¹ã€‚

`weather.py`ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

æ³¨ï¼šä»£ç ä¸­çš„`{API KEY}`éƒ¨åˆ†ï¼Œè¯·æ›¿æ¢ä¸ºè‡ªå·±çš„`API Key`ã€‚

```python
from typing import Any
import httpx
from mcp.server.fastmcp import FastMCP


mcp = FastMCP("weather")


NWS_API_BASE = "https://api.openweathermap.org/data/2.5/weather"
USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36"


def kelvin_to_celsius(kelvin: float) -> float:
    return kelvin - 273.15

async def get_weather_from_cityname(cityname: str) -> dict[str, Any] | None:
    """å‘openweathermapå‘é€è¯·æ±‚å¹¶è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†ã€‚"""
    headers = {
        "User-Agent": USER_AGENT,
        "Accept": "application/geo+json"
    }
    params = {
        "q": cityname,
        "appid": "{API KEY}"
    }
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(NWS_API_BASE, headers=headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None
        

async def get_weather_from_latitude_longitude(latitude: float, longitude: float) -> dict[str, Any] | None:
    """å‘openweathermapå‘é€è¯·æ±‚å¹¶è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†ã€‚"""
    headers = {
        "User-Agent": USER_AGENT,
        "Accept": "application/geo+json"
    }
    params = {
        "lat": latitude,
        "lon": longitude,
        "appid": "{API KEY}"
    }
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(NWS_API_BASE, headers=headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None

def format_alert(feature: dict) -> str:
    """å°†æ¥å£è¿”å›çš„å¤©æ°”ä¿¡æ¯è¿›è¡Œæ ¼å¼åŒ–æ–‡æœ¬è¾“å‡º"""
    if feature["cod"] == 404:
        return "å‚æ•°å¼‚å¸¸ï¼Œè¯·ç¡®è®¤åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"
    elif feature["cod"] == 401:
        return "API key å¼‚å¸¸ï¼Œè¯·ç¡®è®¤API keyæ˜¯å¦æ­£ç¡®ã€‚"
    elif feature["cod"] == 200:
        return f"""
        City: {feature.get('name', 'Unknown')}
        Weather: {feature.get('weather', [{}])[0].get('description', 'Unknown')}
        Temperature: {kelvin_to_celsius(feature.get('main', {}).get('temp', 0)):.2f}Â°C
        Humidity: {feature.get('main', {}).get('humidity', 0)}%
        Wind Speed: {feature.get('wind', {}).get('speed', 0):.2f} m/s
        """
    else:
        return "æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚"

@mcp.tool()
async def get_weather_from_cityname_tool(city: str) -> str:
    """Get weather information for a city.

    Args:
        city: City name (e.g., "wuhan"). For Chinese cities, please use pinyin
    """
    data = await get_weather_from_cityname(city)
    return format_alert(data)

@mcp.tool()
async def get_weather_from_latitude_longitude_tool(latitude: float, longitude: float) -> str:
    """Get weather information for a location.

    Args:
        latitude: Latitude of the location
        longitude: Longitude of the location
    """
    data = await get_weather_from_latitude_longitude(latitude, longitude)
    return format_alert(data)

if __name__ == "__main__":
    
    mcp.run(transport='stdio')
```

åœ¨è¯¥ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸€å…±å®šä¹‰äº†ä¸¤ä¸ª`Tool`ï¼š

1. `get_weather_from_cityname_tool`ï¼šé€šè¿‡åŸå¸‚åç§°è·å–å¤©æ°”æƒ…å†µã€‚
2. `get_weather_from_latitude_longitude_tool`ï¼šé€šè¿‡ç»çº¬åº¦è·å–å¤©æ°”æƒ…å†µã€‚

æ³¨æ„ï¼Œç”±äº`MCP`åè®®éœ€è¦ä½¿ç”¨åˆ°`@mcp.tool`æ ‡è®°å·¥å…·å‡½æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨`@mcp.tool`æ ‡è®°çš„å·¥å…·å‡½æ•°ï¼Œå¯¹åº”çš„æ³¨é‡Š**åŠ¡å¿…å†™æ¸…é™¤**ï¼Œåç»­å¤§æ¨¡å‹èƒ½å¤Ÿè¯†åˆ«è¿™äº›å·¥å…·ã€å·¥å…·å¦‚ä½•ä½¿ç”¨ä»¥åŠå·¥å…·åŠŸèƒ½ï¼Œå…¨éƒ½æ˜¯é€šè¿‡è¿™äº›æ³¨é‡Šè¿›è¡Œè§£è¯»çš„ã€‚æ‰€ä»¥ä¸€ä¸ªå¥½çš„`MCP Server`ï¼Œå…¶å¯¹åº”çš„`Tool`æè¿°ä¹Ÿå¿…é¡»è¦éå¸¸çš„æ¸…é™¤ã€‚

![image-20250418152041716](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418152041716.png)

## MCP Serveræµ‹è¯•

æˆ‘ä»¬ç¼–è¾‘å¥½ä»£ç åï¼Œå¯ä»¥ç›´æ¥åœ¨`cursor`ä¸­æµ‹è¯•è¯¥`MCP Server`æ˜¯å¦å¯ä»¥æ­£å¸¸æä¾›åŠŸèƒ½å’Œè¢«å¤§æ¨¡å‹è°ƒç”¨ã€‚

```json
{
  "mcpServers": {
    "weather": {
          "command": "uv",
          "args": [
              "--directory",
              "D:\\weather_mcp_server",  
              "run",
              "weather.py"
          ]
      }
  }
}
```

è®¾ç½®å®Œæˆåï¼Œå¯ä»¥å‘ç°`Cursor`å¯ä»¥æˆåŠŸåŠ è½½æˆ‘ä»¬è‡ªå·±å†™çš„`weather MCP`ã€‚

![image-20250418153509409](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418153509409.png)

æ¥ä¸‹æ¥ï¼Œåœ¨å¯¹è¯ä¸­æµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥è°ƒç”¨åˆ°å¤©æ°”æŸ¥è¯¢æœåŠ¡ã€‚

![image-20250418153813844](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418153813844-1752679664496-3.png)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„`MCP Server`å¯ä»¥æˆåŠŸè¢«`Corsor`è°ƒç”¨ã€‚

## MCP Serverå‘å¸ƒ

å‰é¢æˆ‘ä»¬æ¼”ç¤ºçš„æ˜¯`stdio`æ–¹å¼çš„é€šä¿¡åè®®ï¼Œè¯¥æ–¹å¼æœ¬è´¨ä¸Šå°±æ˜¯åœ¨æœ¬åœ°å…è®¸äº†ä¸€ä¸ªæœåŠ¡ï¼Œç„¶åé€šè¿‡`MCP Client`å»è°ƒç”¨æœ¬åœ°çš„æœåŠ¡å®ç°çš„ã€‚

è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼Œæ— æ³•å°†è‡ªå·±çš„`MCP Server`ï¼Œåœ¨ä¸æŠŠæºä»£ç ç»™åˆ«äººçš„æƒ…å†µä¸‹ï¼Œå…±äº«ç»™å…¶ä»–äººä½¿ç”¨ã€‚è¿™ç§æ–¹å¼åœ¨ä¼ä¸šä¸­è‚¯å®šæ˜¯ä¸èƒ½å¤Ÿè¢«å…è®¸çš„ï¼Œæºä»£ç æ˜¯ä¼ä¸šçš„å‘½è„‰ã€‚æ­¤æ—¶ï¼Œ`SSE`é€šä¿¡æ–¹å¼å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¯ä»¥ä½¿ç”¨`SSE`çš„é€šä¿¡æ–¹å¼å°†è‡ªå·±çš„`MCP Server`éƒ¨ç½²åœ¨æœåŠ¡å™¨ï¼Œç„¶åå…¶ä»–æ‰€æœ‰çš„`MCP Client`è¦è°ƒç”¨`MCP Server`å¯¹åº”çš„æœåŠ¡æ—¶ï¼Œå°±æ— éœ€åœ¨æœ¬åœ°å»æ‰§è¡Œ`MCP Server`æœåŠ¡äº†ã€‚

å¦‚æœéœ€è¦å…¶ä»–æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®å½“ä½ çš„`MCP Server`ï¼Œå°±éœ€è¦å°†è‡ªå·±çš„`MCP Server`é…ç½®åˆ°å…¬ç½‘æœåŠ¡å™¨ã€‚

åœ¨å…¬ç½‘ä¸­é…ç½®ç¯å¢ƒçš„æ–¹å¼ä¸å‰é¢çš„æµç¨‹ä¸€è‡´ï¼Œéœ€è¦æŒ‰ç…§ä»¥ä¸‹æ–¹å¼ä¿®æ”¹ä»£ç å³å¯ã€‚

å°†`weather_sse.py`ä»£ç ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼Œé…ç½®ä¸º`sse`é€šä¿¡åè®®ã€‚

```plain
from typing import Any
import httpx
from mcp.server.fastmcp import FastMCP



mcp = FastMCP(
    name="weather",
    host="0.0.0.0",
    port=8000,
    description="é€šè¿‡åŸå¸‚åç§°ï¼ˆæ‹¼éŸ³ï¼‰æˆ–ç»çº¬åº¦è·å–å¤©æ°”ä¿¡æ¯",
    sse_path="/sse"
)


NWS_API_BASE = "https://api.openweathermap.org/data/2.5/weather"
USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36"


def kelvin_to_celsius(kelvin: float) -> float:
    return kelvin - 273.15

async def get_weather_from_cityname(cityname: str) -> dict[str, Any] | None:
    """å‘openweathermapå‘é€è¯·æ±‚å¹¶è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†ã€‚"""
    headers = {
        "User-Agent": USER_AGENT,
        "Accept": "application/geo+json"
    }
    params = {
        "q": cityname,
        "appid": "24ecadbe4bb3d55cb1f06ea48a41ac51"
    }
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(NWS_API_BASE, headers=headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None
        

async def get_weather_from_latitude_longitude(latitude: float, longitude: float) -> dict[str, Any] | None:
    """å‘openweathermapå‘é€è¯·æ±‚å¹¶è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†ã€‚"""
    headers = {
        "User-Agent": USER_AGENT,
        "Accept": "application/geo+json"
    }
    params = {
        "lat": latitude,
        "lon": longitude,
        "appid": "24ecadbe4bb3d55cb1f06ea48a41ac51"
    }
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(NWS_API_BASE, headers=headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None

def format_alert(feature: dict) -> str:
    """å°†æ¥å£è¿”å›çš„å¤©æ°”ä¿¡æ¯è¿›è¡Œæ ¼å¼åŒ–æ–‡æœ¬è¾“å‡º"""
    if feature["cod"] == 404:
        return "å‚æ•°å¼‚å¸¸ï¼Œè¯·ç¡®è®¤åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"
    elif feature["cod"] == 401:
        return "API key å¼‚å¸¸ï¼Œè¯·ç¡®è®¤API keyæ˜¯å¦æ­£ç¡®ã€‚"
    elif feature["cod"] == 200:
        return f"""
        City: {feature.get('name', 'Unknown')}
        Weather: {feature.get('weather', [{}])[0].get('description', 'Unknown')}
        Temperature: {kelvin_to_celsius(feature.get('main', {}).get('temp', 0)):.2f}Â°C
        Humidity: {feature.get('main', {}).get('humidity', 0)}%
        Wind Speed: {feature.get('wind', {}).get('speed', 0):.2f} m/s
        """
    else:
        return "æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚"

@mcp.tool()
async def get_weather_from_cityname_tool(city: str) -> str:
    """Get weather information for a city.

    Args:
        city: City name (e.g., "wuhan"). For Chinese cities, please use pinyin
    """
    data = await get_weather_from_cityname(city)
    return format_alert(data)

@mcp.tool()
async def get_weather_from_latitude_longitude_tool(latitude: float, longitude: float) -> str:
    """Get weather information for a location.

    Args:
        latitude: Latitude of the location
        longitude: Longitude of the location
    """
    data = await get_weather_from_latitude_longitude(latitude, longitude)
    return format_alert(data)

if __name__ == "__main__":
    
    
    print("Starting server...")
    mcp.run(transport='sse')
```

åœ¨å…¬ç½‘ä¸­æ‰§è¡Œè¯¥è„šæœ¬ï¼Œå¼€å¯`MCP SSE Server`ã€‚æ‰§è¡Œå®Œæˆåï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ‰“å°ç»“æœã€‚

![image-20250418161405895](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418161405895.png)

æ­¤æ—¶ï¼Œå†æ¬¡ä½¿ç”¨`Cursor`æµ‹è¯•`SSE MCP Server`æœåŠ¡æ˜¯å¦å¯ä»¥æ­£å¸¸è°ƒç”¨ã€‚

åœ¨`Cursor`çš„`MCP`é…ç½®ä¸­ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
{
  "mcpServers": {
    "weather": {
      "url": "http://{ä½ çš„å…¬ç½‘IP}:8000/sse"
    }
  }
}
```

é…ç½®å®Œæˆåï¼Œæœ€å¥½é‡å¯`Cursor`ä¸€æ¬¡ï¼Œå› ä¸ºå‰é¢æˆ‘ä»¬åŠ è½½è¿‡ç›¸åŒåå­—çš„`MCP`æœåŠ¡ã€‚

é‡å¯å®Œæˆåï¼Œå¯ä»¥çœ‹åˆ°`Cursor`ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸è¯†åˆ«åˆ°æˆ‘ä»¬çš„`MCP Server`ã€‚

![image-20250418161952944](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418161952944.png)

æµ‹è¯•åŠŸèƒ½æ˜¯å¦å¯ä»¥æ­£å¸¸è°ƒç”¨ã€‚

![image-20250418162419763](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418162419763.png)

åŠŸèƒ½ä¹Ÿå¯ä»¥æ­£å¸¸è°ƒç”¨ã€‚

![image-20250418162834589](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250418162834589-1752666365613-73.png)

æœåŠ¡å™¨ä¹Ÿæœ‰è¯·æ±‚å“åº”ã€‚

# ä»0å¼€å§‹å®ç°MCP-Client

## ä»€ä¹ˆæ˜¯MCP-Clientï¼Ÿ

`MCP-Client`æ˜¯`Model Context Protocol`ï¼ˆæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰æ¶æ„ä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œç”¨äºè¿æ¥`AI`æ¨¡å‹ï¼ˆå¦‚`Claude`ã€`GPT`ç­‰å¤§å‹è¯­è¨€æ¨¡å‹ï¼‰ä¸å¤–éƒ¨æ•°æ®æºã€å·¥å…·å’ŒæœåŠ¡çš„æ¡¥æ¢ã€‚

`MCPï¼ˆModel Context Protocolï¼‰`æ˜¯ç”±`Anthropic`å…¬å¸åœ¨2024å¹´åº•é¦–æ¬¡æå‡ºå¹¶å¼€æºçš„ä¸€ç§å¼€æ”¾æ ‡å‡†åè®®ï¼Œæ—¨åœ¨è§£å†³å¤§è¯­è¨€æ¨¡å‹ï¼ˆ`LLM`ï¼‰ä¸å¤–éƒ¨ä¸–ç•Œçš„è¿æ¥é—®é¢˜ã€‚è¿™ä¸€åè®®çš„æ ¸å¿ƒä»·å€¼åœ¨äºæ‰“ç ´äº†`AI`æ¨¡å‹çš„â€ä¿¡æ¯å­¤å²›â€é™åˆ¶ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿä»¥æ ‡å‡†åŒ–çš„æ–¹å¼è®¿é—®å’Œå¤„ç†å®æ—¶æ•°æ®ï¼Œæ˜¾è‘—æ‰©å±•äº†å¤§æ¨¡å‹çš„åº”ç”¨åœºæ™¯ã€‚

åœ¨`MCP`æ¶æ„ä¸­ï¼Œæœ‰ä¸‰ä¸ªå…³é”®ç»„ä»¶ï¼š

1. MCPæœåŠ¡å™¨ï¼ˆ`Server`ï¼‰ï¼šè½»é‡çº§æœåŠ¡ç¨‹åºï¼Œè´Ÿè´£å¯¹æ¥å…·ä½“æ•°æ®æºæˆ–å·¥å…·ï¼ˆå¦‚æ•°æ®åº“ã€`API`ç­‰ï¼‰ï¼Œå¹¶æŒ‰ç…§MCPè§„èŒƒæä¾›æ ‡å‡†åŒ–çš„åŠŸèƒ½æ¥å£ã€‚æ¯ä¸ª`MCP`æœåŠ¡å™¨å°è£…äº†ç‰¹å®šçš„èƒ½åŠ›ï¼Œå¦‚æ–‡ä»¶æ£€ç´¢ã€æ•°æ®åº“æŸ¥è¯¢ç­‰ã€‚
2. MCPå®¢æˆ·ç«¯ï¼ˆ`Client`ï¼‰ï¼šåµŒå…¥åœ¨`AI`åº”ç”¨ä¸­çš„è¿æ¥å™¨ï¼Œä¸`MCP`æœåŠ¡å™¨å»ºç«‹ä¸€å¯¹ä¸€è¿æ¥ï¼Œå……å½“æ¨¡å‹ä¸æœåŠ¡å™¨ä¹‹é—´çš„æ¡¥æ¢ã€‚å®ƒè´Ÿè´£å‘ç°å¯ç”¨æœåŠ¡ã€å‘é€è°ƒç”¨è¯·æ±‚ã€è·å–ç»“æœï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™`AI`æ¨¡å‹ã€‚
3. å®¿ä¸»åº”ç”¨ï¼ˆ`Host`ï¼‰ï¼šè¿è¡Œ`LLM`çš„åº”ç”¨ç¨‹åºæˆ–ç¯å¢ƒï¼Œå¦‚`Claude`æ¡Œé¢åº”ç”¨ã€`Cursor IDE`ç­‰ã€‚å®¿ä¸»é€šè¿‡é›†æˆ`MCP`å®¢æˆ·ç«¯ï¼Œä½¿å…¶å†…éƒ¨çš„æ¨¡å‹èƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨`MCP`æœåŠ¡å™¨çš„èƒ½åŠ›ã€‚

`MCP-Client`çš„å·¥ä½œåŸç†æ˜¯åŸºäº`JSON-RPC 2.0`åè®®ï¼Œé€šè¿‡æ ‡å‡†åŒ–çš„æ¥å£ä¸`MCP`æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚å®ƒèƒ½å¤Ÿè‡ªåŠ¨å‘ç°å¯ç”¨çš„`MCP`æœåŠ¡å™¨åŠå…¶æä¾›çš„å·¥å…·ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ä»¥ç»“æ„åŒ–çš„æ–¹å¼æä¾›ç»™å¤§è¯­è¨€æ¨¡å‹ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿç†è§£å¯ç”¨çš„å·¥å…·åŠå…¶åŠŸèƒ½ï¼Œä»è€Œæ ¹æ®ç”¨æˆ·éœ€æ±‚å†³å®šä½•æ—¶ä½•åœ°è°ƒç”¨è¿™äº›å·¥å…·ã€‚

## ä¸ºä»€ä¹ˆè¦è‡ªå†™MCP-Clientï¼Ÿ

è‡ªä¸»å¼€å‘`MCP-Client`æœ‰å‡ ä¸ªé‡è¦çš„åŸå› å’Œä¼˜åŠ¿ï¼š

1. **å®šåˆ¶åŒ–éœ€æ±‚**ï¼šå¸‚åœºä¸Šçš„é€šç”¨`MCP`å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ï¼š`ClaudeDesktop`ã€`Cursor`ã€`Cline`ç­‰ç­‰ï¼‰å¯èƒ½æ— æ³•æ»¡è¶³ç‰¹å®šä¸šåŠ¡åœºæ™¯çš„éœ€æ±‚ã€‚é€šè¿‡è‡ªä¸»å¼€å‘ï¼Œå¯ä»¥æ ¹æ®ä¼ä¸šæˆ–ä¸ªäººçš„å…·ä½“éœ€æ±‚è¿›è¡Œå®šåˆ¶ï¼Œæ¯”å¦‚æ·»åŠ ç‰¹å®šçš„å®‰å…¨éªŒè¯ã€æ•°æ®è¿‡æ»¤ã€æˆ–é’ˆå¯¹ç‰¹å®šé¢†åŸŸçš„ä¼˜åŒ–ã€‚
2. **ç³»ç»Ÿé›†æˆ**ï¼šå°†`MCP-Client`ä¸ç°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆã€‚è‡ªä¸»å¼€å‘çš„`MCP-Client`å¯ä»¥æ›´å¥½åœ°é€‚é…å·²æœ‰çš„æŠ€æœ¯æ ˆå’Œæ¶æ„ï¼Œå‡å°‘å…¼å®¹æ€§é—®é¢˜ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚
3. **æ•°æ®éšç§ä¸å®‰å…¨**ï¼šå¯¹äºæ•æ„Ÿæ•°æ®æˆ–å†…éƒ¨ç³»ç»Ÿï¼Œè‡ªä¸»å¼€å‘çš„`MCP-Client`å¯ä»¥å®ç°æ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶å’Œæ•°æ®ä¿æŠ¤æªæ–½ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯ä¸ä¼šè¢«æœªæˆæƒè®¿é—®æˆ–æ³„éœ²ã€‚
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šé’ˆå¯¹ç‰¹å®šç”¨ä¾‹ä¼˜åŒ–æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå¯¹äºéœ€è¦é«˜é¢‘ç‡ã€ä½å»¶è¿Ÿè®¿é—®çš„åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡å®šåˆ¶`MCP-Client`æ¥å‡å°‘é€šä¿¡å¼€é”€ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚
5. **æ‰©å±•åŠŸèƒ½**ï¼šå®ç°æ ‡å‡†`MCP`åè®®ä¹‹å¤–çš„å¢å¼ºåŠŸèƒ½ã€‚æ¯”å¦‚æ·»åŠ é«˜çº§ç¼“å­˜æœºåˆ¶ã€è¯·æ±‚é˜Ÿåˆ—ç®¡ç†ã€è´Ÿè½½å‡è¡¡ï¼Œæˆ–é’ˆå¯¹ç‰¹å®š`AI`æ¨¡å‹ä¼˜åŒ–çš„ä¸Šä¸‹æ–‡å¤„ç†é€»è¾‘ã€‚
6. **æ§åˆ¶å’Œå¯ç»´æŠ¤æ€§**ï¼šå¯¹äºä¾èµ–`AI`èƒ½åŠ›çš„æ ¸å¿ƒä¸šåŠ¡ï¼Œè‡ªä¸»å¼€å‘çš„`MCP-Client`æ„å‘³ç€æ›´å¥½çš„æ§åˆ¶èƒ½åŠ›å’Œå¯ç»´æŠ¤æ€§ã€‚å½“éœ€æ±‚å˜åŒ–æˆ–å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥å¿«é€Ÿè¿›è¡Œè°ƒæ•´å’Œä¿®å¤ï¼Œè€Œä¸å¿…ä¾èµ–ç¬¬ä¸‰æ–¹ä¾›åº”å•†ã€‚
7. **é€‚é…å¤šç§AIæ¨¡å‹**ï¼šè‡ªä¸»å¼€å‘çš„`MCP-Client`å¯ä»¥è®¾è®¡ä¸ºåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚`Claude`ã€`GPT`ç­‰ï¼‰ï¼Œæ ¹æ®ä»»åŠ¡éœ€æ±‚åŠ¨æ€é€‰æ‹©æœ€é€‚åˆçš„æ¨¡å‹ï¼Œæé«˜ç³»ç»Ÿçµæ´»æ€§ã€‚
8. **ç‰¹æ®Šåè®®æ”¯æŒ**ï¼šå¯¹äºéœ€è¦ä½¿ç”¨ç‰¹æ®Šé€šä¿¡åè®®æˆ–æ•°æ®æ ¼å¼çš„åœºæ™¯ï¼Œè‡ªä¸»å¼€å‘å¯ä»¥å®ç°è¿™äº›éæ ‡å‡†éœ€æ±‚ã€‚
9. **é™ä½ä¾èµ–é£é™©**ï¼šå‡å°‘å¯¹ç¬¬ä¸‰æ–¹æœåŠ¡çš„ä¾èµ–ï¼Œå¢å¼ºç³»ç»Ÿçš„ç‹¬ç«‹æ€§å’ŒéŸ§æ€§ã€‚å¦‚æœç¬¬ä¸‰æ–¹æœåŠ¡å‘ç”Ÿå˜æ›´æˆ–ä¸­æ–­ï¼Œè‡ªä¸»å¼€å‘çš„ç³»ç»Ÿå¯ä»¥æ›´å¿«åœ°é€‚åº”å’Œè°ƒæ•´ã€‚
10. **ä¸“ä¸šçŸ¥è¯†æ²‰æ·€**ï¼šé€šè¿‡è‡ªä¸»å¼€å‘`MCP-Client`ï¼Œå›¢é˜Ÿå¯ä»¥ç§¯ç´¯AIä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆçš„ä¸“ä¸šçŸ¥è¯†å’Œç»éªŒï¼Œè¿™å¯¹äºé•¿æœŸçš„AIæˆ˜ç•¥å’Œèƒ½åŠ›å»ºè®¾éå¸¸æœ‰ä»·å€¼ã€‚

å®é™…ä¸Šï¼Œéšç€AIåº”ç”¨çš„æ·±å…¥å’Œæ™®åŠï¼Œè¶Šæ¥è¶Šå¤šçš„ç»„ç»‡å¼€å§‹è®¤è¯†åˆ°ï¼ŒAIåŸºç¡€è®¾æ–½ï¼ˆåŒ…æ‹¬`MCP-Client`ï¼‰æ˜¯ä¸€ç§æˆ˜ç•¥æ€§èµ„äº§ã€‚è‡ªä¸»å¼€å‘è¿™äº›ç»„ä»¶ä¸ä»…å¯ä»¥è·å¾—æ›´å¥½çš„æŠ€æœ¯åŒ¹é…åº¦ï¼Œè¿˜èƒ½åœ¨ç«äº‰ä¸­è·å¾—å·®å¼‚åŒ–ä¼˜åŠ¿ï¼Œå°¤å…¶æ˜¯åœ¨AIæŠ€æœ¯å¯¹ä¸šåŠ¡è‡³å…³é‡è¦çš„é¢†åŸŸã€‚

`MCP`åè®®çš„å¼€æ”¾æ€§æ°æ°ä¸ºè‡ªä¸»å¼€å‘`MCP-Client`æä¾›äº†å¯èƒ½ï¼Œä½¿å¾—ç»„ç»‡å’Œå¼€å‘è€…èƒ½å¤Ÿåœ¨æ ‡å‡†åŒ–æ¡†æ¶ä¸‹åˆ›å»ºé€‚åˆè‡ªå·±éœ€æ±‚çš„å®šåˆ¶è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶ä»ç„¶ä¿æŒä¸æ•´ä¸ªç”Ÿæ€ç³»ç»Ÿçš„äº’æ“ä½œæ€§ã€‚é€šè¿‡è‡ªå†™`MCP-Client`ï¼Œå¼€å‘è€…å¯ä»¥å……åˆ†åˆ©ç”¨`AI`å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒå¯¹ç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµçš„å®Œå…¨æ§åˆ¶ã€‚

## MCP-Clientç¼–å†™

## å·¥ç¨‹æ­å»º

åœ¨æœ¬èŠ‚å®éªŒä¸­ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å‡†å¤‡ä¸€ä¸ªé€‚é…`openai`åè®®çš„å¤§æ¨¡å‹`API`ï¼Œä¾‹å¦‚ï¼š`deepseek V3`ï¼Œ`Qwen`ç³»åˆ—ï¼Œ`Moonshot`æœˆä¹‹æš—é¢ç­‰ç­‰ã€‚

ä¸ºäº†ç¼–å†™`MCP Client`ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä¸Šä¸€èŠ‚ï¼ˆä»0å¼€å§‹å®ç°MCP-Serverï¼‰ä¸­ï¼Œåˆ›å»ºå¥½çš„å·¥ç¨‹ã€‚

é¦–å…ˆåˆ›å»ºç¯å¢ƒå˜é‡`.env`æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æˆ‘ä»¬æ”¾å…¥è‡ªå·±çš„å¤§æ¨¡å‹ç›¸å…³ä¿¡æ¯ï¼š

ä¸»è¦åŒ…å«3ä¸ªå­—æ®µï¼š

1. `OPENAI_API_KEY`ï¼šå¤§æ¨¡å‹çš„`API KEY`
2. `BASE_URL`ï¼šå¤§æ¨¡å‹è¯·æ±‚åœ°å€
3. `MODEL`ï¼šæ¨¡å‹åç§°

![image-20250421221754858](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250421221754858.png)

è¿™é‡Œå¯¹æ¨¡å‹çš„ç§ç±»ä¸é™ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯`moonshot`ï¼Œå¤§å®¶ä½¿ç”¨å…¶ä»–å¤§æ¨¡å‹å‡å¯ã€‚

## MCP-Prompt

ç›®å‰æ”¯æŒæˆ–æ·±åº¦é›†æˆ`MCP`åè®®çš„å¤§æ¨¡å‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š**Claudeç³»åˆ—**å’Œ**GPTç³»åˆ—**ç­‰ã€‚

å›½å†…çš„å¤§æ¨¡å‹ä¾›åº”å•†å¯¹äº`MCP`åè®®åŸºæœ¬ä¸Šæ²¡æœ‰åšé’ˆå¯¹æ€§çš„é›†æˆè®­ç»ƒï¼Œæ‰€ä»¥åœ¨å›½å†…ä½¿ç”¨`MCP`åè®®ï¼Œå¿…é¡»ç¼–å†™ç»“æ„åŒ–çš„`MCP-Prompt`ï¼Œé€šè¿‡`system prompt`çš„æ–¹å¼è®©å›½å†…çš„å¤§æ¨¡å‹å…·å¤‡é€‚é…`MCP`åè®®ã€‚

ä¸ºäº†ç¼–å†™è¿™ä¸ªæç¤ºè¯ï¼Œæˆ‘ä½¿ç”¨`cloudflare`å¯¹å¤§æ¨¡å‹è¿›è¡Œä»£ç†ï¼Œç„¶åå¯¹`Cursor`çš„`MCP`è¯·æ±‚è¿›è¡Œæˆªè·å¹¶å°†`MCP`æç¤ºè¯ç›¸å…³å†…å®¹ä¿ç•™ï¼Œå…¶ä»–æ— å…³å†…å®¹åˆ é™¤ï¼Œå¾—åˆ°ä»¥ä¸‹æç¤ºè¯ï¼Œå½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥è‡ªè¡Œå¯¹è¿™ä¸ªæç¤ºè¯è¿›è¡Œä¿®æ”¹ï¼Œå®ç°è‡ªå·±çš„å®šåˆ¶åŒ–ã€‚

åœ¨å·¥ç¨‹ä¸­åˆ›å»ºæ–‡ä»¶`MCP_Prompt.txt`ï¼Œå°†ä»¥ä¸‹å†…å®¹æ”¾å…¥æ–‡ä»¶ä¸­ã€‚

```plain
You are an AI assistant, you can help users solve problems, including but not limited to programming, editing files, browsing websites, etc.

====

TOOL USE

You have access to a set of tools that are executed upon the user's approval. You can use one tool per message, and will receive the result of that tool use in the user's response. You use tools step-by-step to accomplish a given task, with each tool use informed by the result of the previous tool use.

# Tool Use Formatting

Tool use is formatted using XML-style tags. The tool name is enclosed in opening and closing tags, and each parameter is similarly enclosed within its own set of tags. Here's the structure:

<tool_name>
<parameter1_name>value1</parameter1_name>
<parameter2_name>value2</parameter2_name>
...
</tool_name>

For example:

<read_file>
<path>src/main.js</path>
</read_file>

Always adhere to this format for the tool use to ensure proper parsing and execution.

# Tools
## use_mcp_tool
Description: Request to use a tool provided by a connected MCP server. Each MCP server can provide multiple tools with different capabilities. Tools have defined input schemas that specify required and optional parameters.
Parameters:
- server_name: (required) The name of the MCP server providing the tool
- tool_name: (required) The name of the tool to execute
- arguments: (required) A JSON object containing the tool's input parameters, following the tool's input schema
Usage:
<use_mcp_tool>
<server_name>server name here</server_name>
<tool_name>tool name here</tool_name>
<arguments>
{
  "param1": "value1",
  "param2": "value2"
}
</arguments>
</use_mcp_tool>

# Tool Use Examples
## Example 1: Requesting to use an MCP tool

<use_mcp_tool>
<server_name>weather-server</server_name>
<tool_name>get_forecast</tool_name>
<arguments>
{
  "city": "San Francisco",
  "days": 5
}
</arguments>
</use_mcp_tool>

## Example 2: Another example of using an MCP tool (where the server name is a unique identifier such as a URL)

<use_mcp_tool>
<server_name>github.com/modelcontextprotocol/servers/tree/main/src/github</server_name>
<tool_name>create_issue</tool_name>
<arguments>
{
  "owner": "octocat",
  "repo": "hello-world",
  "title": "Found a bug",
  "body": "I'm having a problem with this.",
  "labels": ["bug", "help wanted"],
  "assignees": ["octocat"]
}
</arguments>
</use_mcp_tool>

===

MCP SERVERS

The Model Context Protocol (MCP) enables communication between the system and locally running MCP servers that provide additional tools and resources to extend your capabilities.

# Connected MCP Servers

When a server is connected, you can use the server's tools via the `use_mcp_tool` tool, and access the server's resources via the `access_mcp_resource` tool.
<$MCP_INFO$>

===
 
CAPABILITIES
- You have access to MCP servers that may provide additional tools and resources. Each server may provide different capabilities that you can use to accomplish tasks more effectively.

====

RULES
- MCP operations should be used one at a time, similar to other tool usage. Wait for confirmation of success before proceeding with additional operations.

====

OBJECTIVE

You accomplish a given task iteratively, breaking it down into clear steps and working through them methodically.

1. Analyze the user's task and set clear, achievable goals to accomplish it. Prioritize these goals in a logical order.
2. Work through these goals sequentially, utilizing available tools one at a time as necessary. Each goal should correspond to a distinct step in your problem-solving process. You will be informed on the work completed and what's remaining as you go.
3. Once you've completed the user's task, you must use the attempt_completion tool to present the result of the task to the user. 
4. The user may provide feedback, which you can use to make improvements and try again. But DO NOT continue in pointless back and forth conversations, i.e. don't end your responses with questions or offers for further assistance."
```

åœ¨è¿™ä¸ªæç¤ºè¯ä¸­ï¼Œæˆ‘è®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ç¬¦`<$MCP_INFO$>`ï¼Œè¯¥æ ‡è®°ç¬¦ç”¨äºåæœŸè½½å…¥`MCP Server`åŠ`MCP Tool`ç›¸å…³å·¥å…·çš„æè¿°ä¿¡æ¯ã€‚

## Stdioé€šä¿¡åè®®

`stdio` ä¼ è¾“æ–¹å¼æ˜¯æœ€ç®€å•çš„é€šä¿¡æ–¹å¼ï¼Œé€šå¸¸åœ¨æœ¬åœ°å·¥å…·ä¹‹é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’æ—¶ä½¿ç”¨ã€‚å®ƒåˆ©ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºï¼ˆ`stdin/stdout`ï¼‰ä½œä¸ºæ•°æ®ä¼ è¾“é€šé“ï¼Œé€‚ç”¨äºæœ¬åœ°è¿›ç¨‹é—´çš„äº¤äº’ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬é¦–å…ˆä»¥ä¸Šä¸€èŠ‚ï¼ˆä»0å¼€å§‹å®ç°MCP-Serverï¼‰ä¸­æ„å»ºçš„`weather MCP Server`ä¸ºä¾‹ï¼Œç¼–å†™`MCP Client`å‘`MCP Server`è¿›è¡Œè¯·æ±‚ã€‚

ç¼–å†™`mcp_client_stdio.py`ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
import asyncio
from typing import Optional
from contextlib import AsyncExitStack
import json

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client
from mcp.client.sse import sse_client

from dotenv import load_dotenv
import os, re
from openai import OpenAI
from lxml import etree

load_dotenv()  

class MCPClient:
    def __init__(self):
        
        self.session: Optional[ClientSession] = None
        self.exit_stack = AsyncExitStack()
        
        self.API_KEY = os.getenv("API_KEY")
        self.BASE_URL = os.getenv("BASE_URL")
        self.MODEL = os.getenv("MODEL")
        
        self.client = OpenAI(api_key=self.API_KEY, base_url=self.BASE_URL)
        
        self.messages = []
        
        with open("./MCP_Prompt.txt", "r", encoding="utf-8") as file:
            self.system_prompt = file.read()

    async def connect_to_stdio_server(self, mcp_name, command: str, args: list[str], env: dict[str, str]={}):
        """Connect to an MCP server

        Args:
            server_script_path: Path to the server script (.py or .js)
        """
        server_params = StdioServerParameters(
            command=command,
            args=args,
            env=env
        )

        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def process_query(self, query: str) -> str:
        """Process a query using Claude and available tools"""
        self.messages.append(
            {
                "role": "system",
                "content": self.system_prompt
            }
        )
        self.messages.append(
            {
                "role": "user",
                "content": query
            }
        )

        
        response = self.client.chat.completions.create(
            model=self.MODEL,
            max_tokens=1024,
            messages=self.messages,
        )

        
        final_text = []
        content = response.choices[0].message.content
        if '<use_mcp_tool>' not in content:
            final_text.append(content)
        else:
            
            server_name, tool_name, tool_args = self.parse_tool_string(content)

            
            result = await self.session.call_tool(tool_name, tool_args)
            print(f"[Calling tool {tool_name} with args {tool_args}]")
            print("-"*40)
            print("Server:", server_name)
            print("Tool:", tool_name)
            print("Args:", tool_args)
            print("-"*40)
            print("Result:", result.content[0].text)
            print("-"*40)
            self.messages.append({
                "role": "assistant",
                "content": content
            })
            self.messages.append({
                "role": "user",
                "content": f"[Tool {tool_name} \n returned: {result}]"
            })

            response = self.client.chat.completions.create(
                model=self.MODEL,
                max_tokens=1024,
                messages=self.messages
            )
            final_text.append(response.choices[0].message.content)
        return "\n".join(final_text)
    
    def parse_tool_string(self, tool_string: str) -> tuple[str, str, dict]:
        """
        è§£æå¤§æ¨¡å‹å·¥å…·è°ƒç”¨è¿”å›çš„å­—ç¬¦ä¸²
        """
        tool_string = re.findall("(<use_mcp_tool>.*?</use_mcp_tool>)", tool_string, re.S)[0]
        root = etree.fromstring(tool_string)
        server_name = root.find('server_name').text
        tool_name = root.find('tool_name').text
        try:
            tool_args = json.loads(root.find('arguments').text)
        except json.JSONDecodeError:
            raise ValueError("Invalid tool arguments")
        return server_name, tool_name, tool_args

    async def chat_loop(self):
        """Run an interactive chat loop"""
        print("\nMCP Client Started!")
        print("Type your queries or 'quit' to exit.")
        self.messages = []
        while True:
            try:
                query = input("\nQuery: ").strip()

                if query.lower() == 'quit':
                    break
                if query.strip() == '':
                    print("Please enter a query.")
                    continue
                response = await self.process_query(query)
                print(response)

            except Exception as e:
                print(f"\nError: {str(e)}")

    async def cleanup(self):
        """Clean up resources"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
        await client.connect_to_stdio_server('weather', 'python', ['weather.py'])
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

æ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨çš„æ˜¯ä¸Šä¸€èŠ‚ä¸­ç¼–å†™çš„`weather MCP Server`ï¼Œæ‰€ä»¥`weather.py`æ–‡ä»¶åº”è¯¥å’Œ`mcp_client_stdio.py`æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚

ä»£ç æ‰§è¡Œæ•ˆæœæ¼”ç¤ºï¼š

![image-20250421223247549](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20250421223247549.png)

`MCP Server`è°ƒç”¨æˆåŠŸï¼

## SSEé€šä¿¡åè®®

`SSE` æ˜¯åŸºäº `HTTP` åè®®çš„æµå¼ä¼ è¾“æœºåˆ¶ï¼Œå®ƒå…è®¸æœåŠ¡å™¨é€šè¿‡ `HTTP` å•å‘æ¨é€äº‹ä»¶åˆ°å®¢æˆ·ç«¯ã€‚`SSE` é€‚ç”¨äºå®¢æˆ·ç«¯éœ€è¦æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨äºå®æ—¶æ•°æ®æ›´æ–°ã€‚

åœ¨è¿™é‡ŒåŒæ ·å¯ä»¥ä»¥ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨å…¬ç½‘ä¸­æ­å»ºçš„`weather MCP SSE Server`ã€‚

ç¼–å†™ä»£ç `mcp_client_sse.py`å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
import asyncio
from typing import Optional
from contextlib import AsyncExitStack
import json

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client
from mcp.client.sse import sse_client

from dotenv import load_dotenv
import os, re
from openai import OpenAI
from lxml import etree

load_dotenv()  

class MCPClient:
    def __init__(self):
        
        self.session: Optional[ClientSession] = None
        self.exit_stack = AsyncExitStack()
        
        self.API_KEY = os.getenv("API_KEY")
        self.BASE_URL = os.getenv("BASE_URL")
        self.MODEL = os.getenv("MODEL")
        
        self.client = OpenAI(api_key=self.API_KEY, base_url=self.BASE_URL)
        
        self.messages = []
        
        with open("./MCP_Prompt.txt", "r", encoding="utf-8") as file:
            self.system_prompt = file.read()

    async def connect_to_sse_server(self, mcp_name, server_url: str):
        stdio_transport = await self.exit_stack.enter_async_context(sse_client(server_url))
        self.sse, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.sse, self.write))

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>\n")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def process_query(self, query: str) -> str:
        """Process a query using Claude and available tools"""
        self.messages.append(
            {
                "role": "system",
                "content": self.system_prompt
            }
        )
        self.messages.append(
            {
                "role": "user",
                "content": query
            }
        )

        
        response = self.client.chat.completions.create(
            model=self.MODEL,
            max_tokens=1024,
            messages=self.messages,
        )

        
        final_text = []
        content = response.choices[0].message.content
        if '<use_mcp_tool>' not in content:
            final_text.append(content)
        else:
            
            server_name, tool_name, tool_args = self.parse_tool_string(content)

            
            result = await self.session.call_tool(tool_name, tool_args)
            print(f"[Calling tool {tool_name} with args {tool_args}]")
            print("-"*40)
            print("Server:", server_name)
            print("Tool:", tool_name)
            print("Args:", tool_args)
            print("-"*40)
            print("Result:", result.content[0].text)
            print("-"*40)
            self.messages.append({
                "role": "assistant",
                "content": content
            })
            self.messages.append({
                "role": "user",
                "content": f"[Tool {tool_name} \n returned: {result}]"
            })

            response = self.client.chat.completions.create(
                model=self.MODEL,
                max_tokens=1024,
                messages=self.messages
            )
            final_text.append(response.choices[0].message.content)
        return "\n".join(final_text)
    
    def parse_tool_string(self, tool_string: str) -> tuple[str, str, dict]:
        """
        è§£æå¤§æ¨¡å‹å·¥å…·è°ƒç”¨è¿”å›çš„å­—ç¬¦ä¸²
        """
        tool_string = re.findall("(<use_mcp_tool>.*?</use_mcp_tool>)", tool_string, re.S)[0]
        root = etree.fromstring(tool_string)
        server_name = root.find('server_name').text
        tool_name = root.find('tool_name').text
        try:
            tool_args = json.loads(root.find('arguments').text)
        except json.JSONDecodeError:
            raise ValueError("Invalid tool arguments")
        return server_name, tool_name, tool_args

    async def chat_loop(self):
        """Run an interactive chat loop"""
        print("\nMCP Client Started!")
        print("Type your queries or 'quit' to exit.")
        self.messages = []
        while True:
            try:
                query = input("\nQuery: ").strip()

                if query.lower() == 'quit':
                    break
                if query.strip() == '':
                    print("Please enter a query.")
                    continue
                response = await self.process_query(query)
                print(response)

            except Exception as e:
                print(f"\nError: {str(e)}")

    async def cleanup(self):
        """Clean up resources"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
         await client.connect_to_sse_server('weather_sse', 'http://47.113.225.16:8000/sse')
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

æ‰§è¡Œæ•ˆæœæ¼”ç¤ºï¼š

![image-20250421223848425](https://ming-log.oss-cn-hangzhou.aliyuncs.com/img/image-20250421223848425.png)

åŒæ ·å¯ä»¥æˆåŠŸè°ƒç”¨`MCP SSE Server`ã€‚

å¤§å®¶å¯ä»¥ç›´æ¥è°ƒç”¨æˆ‘éƒ¨ç½²å¥½çš„`MCP SSE Server`ï¼Œ

ä¸ºäº†æ–¹ä¾¿å¤§å®¶å­¦ä¹ ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨çš„éƒ¨ç½²å¥½çš„æœåŠ¡`http://47.113.225.16:8000/sse`æ¥è¿›è¡Œæµ‹è¯•ã€‚å½“ç„¶ä¹Ÿé¼“åŠ±å¤§å®¶æ¢æˆå…¶ä»–çš„æœåŠ¡å°è¯•ã€‚

## é‡‡ç”¨é…ç½®æ–‡ä»¶è¿›è¡ŒåŠ è½½

ç»è¿‡å‰é¢çš„å®éªŒï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å¯ä»¥é€šè¿‡è‡ªå·±ç¼–å†™çš„`MCP Client`è¿æ¥ä»»æ„`MCP Server`ï¼ŒåŒ…æ‹¬`stdio`å’Œ`sse`é€šä¿¡åè®®ï¼Œä½†æ˜¯éƒ½åªè¿æ¥äº†ä¸€ä¸ª`MCP Server`ã€‚ç”¨è¿‡`Cursor`æˆ–å…¶ä»–`MCP Client`åº”ç”¨çš„åŒå­¦åº”è¯¥å¾ˆæ¸…æ¥šï¼Œä»–ä»¬æ˜¯é€šè¿‡ä¸€ä¸ª`JSON`é…ç½®æ–‡ä»¶å»åŠ è½½å¤šä¸ª`MCP Server`ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„`MCP Client`èƒ½å¦è¾¾åˆ°è¿™ä¸ªæ•ˆæœå‘¢ï¼Ÿ

å½“ç„¶å¯ä»¥ï¼Œæ¥ä¸‹æ¥çš„å®éªŒæˆ‘ä»¬å°±ä¸€èµ·æ¥ç¼–å†™ç›¸å…³ä»£ç ï¼Œå®ç°è¿™ä¸ªéœ€æ±‚ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰è‡ªå·±çš„`JSON`æ–‡ä»¶åè®®ï¼Œä¾‹å¦‚ï¼š

```plain
{
    "mcpServers": {
      "weather-sse": {
        "isActive": true,
        "type": "stdio",
        "command": "python",
        "args": [
          "weather.py"
        ],
        "name": "weather-sse",
        "env": {}
      },
      "amap-amap-sse": {
        "isActive": true,
        "type": "sse",
        "url": "https://mcp.amap.com/sse?key={é«˜å¾·API KEY}",
        "name": "amap-amap-sse"
      }
    }
  }
```

æ³¨æ„ï¼š`{é«˜å¾·API KEY}`å¤§å®¶å¯ä»¥å»é«˜å¾·å®˜ç½‘æ³¨å†Œè´¦å·ï¼Œå¯ä»¥å…è´¹è·å–ã€‚

å­—æ®µæ„ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š

1. å…¬å…±å­—æ®µï¼š

- `isActive`ï¼šç”¨äºæ§åˆ¶è¯¥`MCP Server`æ˜¯å¦è¢«æ¿€æ´»ã€‚
- `type`ï¼š`MCP Server`çš„ç±»å‹ï¼Œå–å€¼ä¸º`stdio`æˆ–`sse`
- `name`ï¼š`MCP Server`åˆ«åã€‚

1. `stdio`ç›¸å…³å­—æ®µï¼š

- `command`ï¼šå‘½ä»¤åç§°ã€‚
- `args`ï¼šå‚æ•°åˆ—è¡¨
- `env`ï¼šç¯å¢ƒå˜é‡å­—å…¸

1. `sse`ç›¸å…³å‚æ•°ï¼š

- `url`ï¼š`SSE MCP Server`æœåŠ¡åœ°å€ã€‚

ç¼–å†™`mcp_client_mix.py`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
import asyncio
from typing import Optional
from contextlib import AsyncExitStack
import json

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client
from mcp.client.sse import sse_client

from dotenv import load_dotenv
import os, re
from openai import OpenAI
from lxml import etree

load_dotenv()  

class MCPClient:
    def __init__(self):
        
        self.session: Optional[ClientSession] = None
        self.exit_stack = AsyncExitStack()
        
        self.API_KEY = os.getenv("API_KEY")
        self.BASE_URL = os.getenv("BASE_URL")
        self.MODEL = os.getenv("MODEL")
        self.client = OpenAI(api_key=self.API_KEY, base_url=self.BASE_URL)
        self.sessions = {}
        self.messages = []
        with open("./MCP_Prompt.txt", "r", encoding="utf-8") as file:
            self.system_prompt = file.read()

    async def mcp_json_config(self, mcp_json_file):
        try:
            with open(mcp_json_file, 'r') as f:
                mcp_config: dict = json.load(f)
        except json.JSONDecodeError:
            raise ValueError("Invalid MCP config")
        servers_config: dict = mcp_config.get('mcpServers', {})
        for k, v in servers_config.items():
            try:
                print('-'*50)
                if v.get('isActive', False) == False:
                    continue
                mcp_name = v.get('name', k)
                mcp_type: str = v.get('type', 'stdio')
                if mcp_type.lower() == 'stdio':
                    command = v.get('command', None)
                    args = v.get('args', [])
                    env = v.get('env', {})
                    if command is None:
                        raise ValueError(f'{mcp_name} command is empty.')
                    if args == []:
                        raise ValueError(f'{mcp_name} args is empty.')
                    await self.connect_to_stdio_server(mcp_name, command, args, env)
                elif mcp_type.lower() == 'sse':
                    server_url = v.get('url', None)
                    if server_url is None:
                        raise ValueError(f'{mcp_name} server_url is empty.')
                    await self.connect_to_sse_server(mcp_name, server_url)
                else:
                    raise ValueError(f'{mcp_name} mcp type must in [stdio, sse].')
            except Exception as e:
                print(f"Error connecting to {mcp_name}: {e}")

    async def connect_to_stdio_server(self, mcp_name, command: str, args: list[str], env: dict[str, str]={}):
        """Connect to an MCP server

        Args:
            server_script_path: Path to the server script (.py or .js)
        """
        server_params = StdioServerParameters(
            command=command,
            args=args,
            env=env
        )

        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))
        self.sessions[mcp_name] = self.session

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def connect_to_sse_server(self, mcp_name, server_url: str):
        """Connect to an MCP server

        Args:
            server_script_path: Path to the server script (.py or .js)
        """
        stdio_transport = await self.exit_stack.enter_async_context(sse_client(server_url))
        self.sse, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.sse, self.write))
        self.sessions[mcp_name] = self.session

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>\n")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def process_query(self, query: str) -> str:
        """Process a query using Claude and available tools"""
        self.messages.append(
            {
                "role": "system",
                "content": self.system_prompt
            }
        )
        self.messages.append(
            {
                "role": "user",
                "content": query
            }
        )

        
        response = self.client.chat.completions.create(
            model=self.MODEL,
            max_tokens=1024,
            messages=self.messages,
        )

        
        final_text = []
        content = response.choices[0].message.content
        if '<use_mcp_tool>' not in content:
            final_text.append(content)
        else:
            
            server_name, tool_name, tool_args = self.parse_tool_string(content)

            
            result = await self.sessions[server_name].call_tool(tool_name, tool_args)
            print(f"[Calling tool {tool_name} with args {tool_args}]")
            print("-"*40)
            print("Server:", server_name)
            print("Tool:", tool_name)
            print("Args:", tool_args)
            print("-"*40)
            print("Result:", result.content[0].text)
            print("-"*40)
            self.messages.append({
                "role": "assistant",
                "content": content
            })
            self.messages.append({
                "role": "user",
                "content": f"[Tool {tool_name} \n returned: {result}]"
            })

            response = self.client.chat.completions.create(
                model=self.MODEL,
                max_tokens=1024,
                messages=self.messages
            )
            final_text.append(response.choices[0].message.content)
        return "\n".join(final_text)
    
    def parse_tool_string(self, tool_string: str) -> tuple[str, str, dict]:
        tool_string = re.findall("(<use_mcp_tool>.*?</use_mcp_tool>)", tool_string, re.S)[0]
        root = etree.fromstring(tool_string)
        server_name = root.find('server_name').text
        tool_name = root.find('tool_name').text
        try:
            tool_args = json.loads(root.find('arguments').text)
        except json.JSONDecodeError:
            raise ValueError("Invalid tool arguments")
        return server_name, tool_name, tool_args

    async def chat_loop(self):
        """Run an interactive chat loop"""
        print("\nMCP Client Started!")
        print("Type your queries or 'quit' to exit.")
        self.messages = []
        while True:
            try:
                query = input("\nQuery: ").strip()

                if query.lower() == 'quit':
                    break
                if query.strip() == '':
                    print("Please enter a query.")
                    continue
                response = await self.process_query(query)
                print(response)

            except Exception as e:
                print(f"\nError: {str(e)}")

    async def cleanup(self):
        """Clean up resources"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
        mcp_config_file = './mcp.json'
        await client.mcp_json_config(mcp_config_file)
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

æ¼”ç¤ºæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20250421230528033](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250421230528033.png)

![image-20250421230615331](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250421230615331.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªå·¥å…·éƒ½å¯ä»¥æˆåŠŸè°ƒç”¨ã€‚

## å€¼å¾—è¿›ä¸€æ­¥ä¼˜åŒ–çš„å°å»ºè®®

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†é€šè¿‡`MCP`é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½æ‰€æœ‰çš„`MCP Server`ï¼Œå¹¶ä¸”ç»è¿‡éªŒè¯æ‰€æœ‰çš„`MCP Server`å·¥å…·éƒ½å¯ä»¥æˆåŠŸè°ƒç”¨ã€‚

ä½†æ˜¯ï¼Œç°åœ¨çš„ç‰ˆæœ¬æ— æ³•å®Œæˆå·¥å…·ä¹‹å‰è¿›è¡Œç›¸äº’è°ƒç”¨ï¼Œæ— æ³•é€šè¿‡ç”¨æˆ·çš„éœ€æ±‚è°ƒç”¨å¤šä¸ªå·¥å…·é…ç½®å®Œæˆç”¨æˆ·é—®é¢˜çš„è§£ç­”ï¼ŒåŸºäºæ­¤å¤§å®¶å¯ä»¥è‡ªè¡Œä¿®æ”¹ç°æœ‰ä»£ç ï¼Œå®ç°çš„æ–¹å¼ä¸éš¾ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±åŠ¨æ‰‹å®æ“ä¸€ä¸‹ã€‚

# å°†FastAPIæ¥å£è½¬åŒ–ä¸ºMCP Server

## èƒŒæ™¯ä»‹ç»

åœ¨å½“å‰å¤§æ¨¡å‹è“¬å‹ƒå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œä¸“ä¸ºå¤§æ¨¡å‹è°ƒç”¨è®¾è®¡çš„â€`API`å·¥å…·â€â€”â€”`MCP`ï¼Œå·²æˆä¸ºç ”ç©¶é¢†åŸŸçš„ç„¦ç‚¹ã€‚åœ¨ä¹‹å‰çš„ä¸¤ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹æŒ‡å¯¼å¤§å®¶å®ç°äº†`MCP Server`å’Œ`MCP Client`ã€‚é€šè¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»æ„è¯†åˆ°`MCP Server`æœ¬è´¨ä¸Šæ˜¯ä¸ºå¤§æ¨¡å‹æä¾›çš„ä¸€ç§æ ¼å¼åŒ–`API`æ¥å£ã€‚

è¯´åˆ°è¿™é‡Œï¼Œå¾ˆå¤šåŒå­¦å¯èƒ½ä¼šæ€è€ƒï¼šå¸‚åœºä¸Šå·²æœ‰æµ·é‡APIèµ„æºï¼Œä½†å®ƒä»¬å¤§å¤šæœªè¢«è½¬åŒ–ä¸º`MCP`æ ¼å¼ã€‚å¦‚æœæƒ³è°ƒç”¨è¿™äº›`API`ï¼Œè¿˜éœ€è¦é‡æ–°ç¼–å†™ä¸€éï¼Œç¡®å®æ¯”è¾ƒç¹çã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§å·¥å…·èƒ½å¤Ÿå°†æˆ‘ä»¬ç°æœ‰çš„`API`ä¸€é”®è½¬æ¢ä¸º`MCP`æ ¼å¼å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ä»Šå¤©æˆ‘ä»¬è¦å‘å¤§å®¶ä»‹ç»çš„æ­£æ˜¯è¿™æ ·ä¸€ä¸ªé¡¹ç›®â€”â€”`FastAPI-MCP`ã€‚è¯¥é¡¹ç›®å®ç°äº†ä»`FastAPI`åˆ°`MCP Server`çš„æ— ç¼è½¬æ¢ï¼Œè®©æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨`FastAPI`å¼€å‘çš„æ¥å£èƒ½å¤Ÿè½»æ¾è½¬åŒ–ä¸º`MCP Server`ï¼Œä¾›å¤§æ¨¡å‹ç›´æ¥è°ƒç”¨ï¼Œå¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡ã€‚

`FastAPI-MCP`é¡¹ç›®åœ°å€ï¼šhttps://github.com/tadata-org/fastapi_mcp

## æ•ˆæœæ¼”ç¤º

## åˆ›å»ºå·¥ç¨‹

é¦–å…ˆåˆå§‹åŒ–å·¥ç¨‹ï¼Œä½¿ç”¨`Python3.10`ç¯å¢ƒï¼Œå¹¶è¿›å…¥å·¥ç¨‹ã€‚

```plain
uv init fastapi2mcp -p 3.10
cd fastapi2mcp
```

![image-20250423100130118](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250423100130118.png)

åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

![image-20250423100204077](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250423100204077.png)

æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

![image-20250423100242653](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250423100242653.png)

æ·»åŠ ä¾èµ–

æŸ¥çœ‹ä¾èµ–æ ‘

![image-20250424100110607](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100110607.png)

åˆ°æ­¤å·¥ç¨‹å’Œä¾èµ–æ­å»ºå®Œæˆã€‚

## FastAPIæ¥å£æ„å»º

é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼Œå°†æˆ‘ä»¬å‰é¢ä»‹ç»çš„å¤©æ°”æŸ¥è¯¢ï¼Œå°è£…ä¸ºä¸€ä¸ª`FastAPI`æ¥å£ï¼š

```
app.py
from fastapi import FastAPI
from pydantic import BaseModel
from utils import format_alert, get_weather_from_cityname, get_weather_from_latitude_longitude
import uvicorn

app = FastAPI()

class CityName(BaseModel):
    cityname: str

class CityLatLon(BaseModel):
    latitude: float
    longitude: float

class Weather(BaseModel):
    cityname: str
    weather: str
    temperature: str
    humidity: str
    wind_speed: str

class WeatherResponse(BaseModel):
    code: int
    weather: Weather | None = None
    msg: str

@app.post("/get_weather/cityname", response_model=WeatherResponse, operation_id="get_weather_cityname")
async def get_weather_cityname(city: CityName):
    """
    é€šè¿‡åŸå¸‚åç§°ï¼ˆä¸­å›½åŸå¸‚ä½¿ç”¨æ‹¼éŸ³ï¼‰è·å–å¤©æ°”ä¿¡æ¯

    Args:
        cityname: åŸå¸‚åç§°ï¼ˆä¸­å›½åŸå¸‚ä½¿ç”¨æ‹¼éŸ³ï¼‰
    
    Returns:
        code: 0 æˆåŠŸ -1 å¤±è´¥
        weather: å¤©æ°”ä¿¡æ¯
        msg: æˆåŠŸæˆ–å¤±è´¥ä¿¡æ¯
    """
    weather_data = await get_weather_from_cityname(city.cityname)
    if weather_data:
        return {"code": 0, "weather": format_alert(weather_data), "msg": "success"}
    else:
        return {"code": -1, "msg": "Failed to fetch weather data"}

@app.post("/get_weather/latitude_longitude", response_model=WeatherResponse, operation_id="get_weather_latitude_longitude")
async def get_weather_latitude_longitude(citylatlon: CityLatLon):
    """
    é€šè¿‡ç»çº¬åº¦è·å–å¤©æ°”ä¿¡æ¯

    Args:
        latitude: çº¬åº¦
        longitude: ç»åº¦

    Returns:
        code: 0 æˆåŠŸ -1 å¤±è´¥
        weather: å¤©æ°”ä¿¡æ¯
        msg: æˆåŠŸæˆ–å¤±è´¥ä¿¡æ¯
    """
    weather_data = await get_weather_from_latitude_longitude(citylatlon.latitude, citylatlon.longitude)
    if weather_data:
        return {"code": 0, "weather": format_alert(weather_data), "msg": "success"}
    else:
        return {"code": -1, "msg": "Failed to fetch weather data"}

if __name__ == "__main__":
    uvicorn.run(app, host='0.0.0.0', port=8001)
```

æ‰§è¡Œä»£ç 

![image-20250424100226517](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100226517.png)

æ¥å£æˆåŠŸå¼€å¯ã€‚

ä½¿ç”¨`Postman`æµ‹è¯•æ¥å£çš„è¿é€šæ€§

![image-20250424100251374](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100251374.png)

æ¥å£å¯ä»¥æ­£å¸¸è¿”å›ã€‚

## å°†FastAPIæ¥å£è½¬åŒ–ä¸ºMCP Server

æ¥ä¸‹æ¥ï¼Œç»™`FastAPI`æ¥å£è½¬åŒ–ä¸º`MCP Server`ï¼Œè½¬åŒ–çš„æ–¹å¼å¾ˆç®€å•ï¼Œç±»ä¼¼äºç»™`FastAPI`æ‰“ä¸Šä¸€ä¸ªè¡¥ä¸ã€‚

åœ¨`app.py`åŒçº§ç›®å½•ä¸‹æ–°å»ºè„šæœ¬`app2mcp.py`ã€‚

```plain
from fastapi_mcp import FastApiMCP
import uvicorn
from app import app

mcp = FastApiMCP(
        fastapi=app,
        name="weather-sse",
        description="é€šè¿‡åŸå¸‚åç§°ï¼ˆä¸­å›½åŸå¸‚ä½¿ç”¨æ‹¼éŸ³ï¼‰æˆ–ç»çº¬åº¦è·å–å¤©æ°”ä¿¡æ¯",
        describe_all_responses=True,     
        describe_full_response_schema=True  
    )
mcp.mount()

if __name__ == "__main__":
    uvicorn.run(app, host='0.0.0.0', port=8001)
```

ç›´æ¥é€šè¿‡`import`è¯­å¥å°†`app.py`ä¸­çš„`FastAPI app`å¯¹è±¡å¯¼å…¥è¿‡æ¥å³å¯ã€‚

æ‰§è¡Œ`app2mcp.py`è„šæœ¬ã€‚

![image-20250424100612367](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100612367.png)

é€šè¿‡ç®€å•çš„è¡¥ä¸ï¼Œæˆ‘ä»¬å°±å·²ç»å°†`FastAPI`è½¬åŒ–ä¸ºäº†`MCP Server`ã€‚

## MCP Serverè°ƒç”¨

### ä½¿ç”¨Cursoræµ‹è¯•MCP Server

åœ¨`Cursor`ä¸­çš„`MCP`é…ç½®iæ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ã€‚

```plain
{
  "mcpServers": {
    "weather-sse": {
      "url": "http://127.0.0.1:8001/mcp",
      "name": "weather-sse"
    }
  }
}
```

ä¿å­˜åï¼Œå¯ä»¥çœ‹åˆ°`Cursor`å·²ç»æˆåŠŸè¿æ¥`MCP Server`

![image-20250424100857447](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100857447.png)

å¹¶ä¸”æœåŠ¡å™¨ç»ˆç«¯ä¹Ÿæœ‰è¿æ¥è¯·æ±‚ã€‚

![image-20250424100916378](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100916378.png)

æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨`Cursor`å¯¹è¯çª—å£æµ‹è¯•`MCP Server`åŠŸèƒ½

![image-20250424100953677](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424100953677.png)

å¯ä»¥çœ‹åˆ°ï¼Œå¯ä»¥æˆåŠŸè°ƒç”¨ã€‚

å…¶ä»–`MCP Client`åº”ç”¨ï¼ˆä¾‹å¦‚ï¼š`Claude-Desktop`ã€`Cherry Studio`ã€`Cline`ç­‰ç­‰ï¼‰çš„å¯¼å…¥ç±»ä¼¼ï¼Œåœ¨æ­¤ä¸å†æ¼”ç¤ºï¼Œå„ä½å¯è‡ªè¡Œæµ‹è¯•ã€‚

### é€šè¿‡æˆ‘ä»¬è‡ªå†™çš„MCP Clientè°ƒç”¨

åœ¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹

```plain
{
  "mcpServers": {
    "weather-sse": {
      "isActive": true,
      "type": "sse",
      "url": "http://127.0.0.1:8001/mcp",
      "name": "weather-sse"
    }
  }
}
```

æ‰§è¡Œ`client_openai_mix.py`

![image-20250424101630567](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424101630567.png)

åŒæ ·å¯ä»¥è°ƒç”¨æˆåŠŸã€‚

å¦‚æœå¤§å®¶å¯¹äºè¿™å—çš„ä»£ç æœ‰ä¸æ¸…æ¥šçš„ï¼Œè¯·çœ‹æˆ‘å‰é¢å‘çš„æ–‡ç« ã€Šä»0å¼€å§‹å®ç°`MCP-Client`ã€‹ã€‚

åŒæ—¶ï¼ŒåŸæ¥çš„`FastAPI`æ¥å£ä¹Ÿæ˜¯ä¸å½±å“ä½¿ç”¨çš„ã€‚

![image-20250424104655834](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424104655834.png)

## æ§åˆ¶æ¥å£ç«¯ç‚¹çš„æš´éœ²

é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œ`FastAPI-MCP`ä¼šå°†æ‰€æœ‰çš„`FastAPI`æ¥å£å…¨éƒ¨æš´éœ²ç»™å¤§æ¨¡å‹ï¼Œå¤§æ¨¡å‹å…¨éƒ¨éƒ½å¯ä»¥å»è°ƒç”¨ã€‚ä½†æ˜¯è¿™æ ·å…¶å®æ˜¯ä¸å®‰å…¨çš„ï¼Œæœ‰äº›æ¥å£å¯èƒ½æ¶‰åŠåˆ°ä¸€äº›æ³•å¾‹å’Œéšç§é—®é¢˜ï¼Œä¸ä¾¿äºå…¬å¼€ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å»é€‰æ‹©è¦æš´éœ²ç»™`MCP Server`çš„æ¥å£å°±æ˜¾å¾—éå¸¸é‡è¦äº†ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å®šä¹‰`FastAPI`æ¥å£æ—¶æŒ‡å®šçš„ï¼Œ`operation_id`å’Œ`tags`è¿›è¡Œè¿‡æ»¤å’Œç­›é€‰ã€‚

### é€šè¿‡operation_idè¿›è¡Œç­›é€‰

é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼Œé€‰æ‹©`operation_id`ä¸º`get_weather_cityname`çš„æ¥å£è¿›è¡Œæš´éœ²ï¼Œè¿™ä¸ªæ—¶å€™å…¶ä»–æ¥å£å°±éƒ½ä¸ä¼šæš´éœ²ã€‚

![image-20250424105111967](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424105111967.png)

è¿˜å¯ä»¥é€šè¿‡`exclude_operations`å¯¹æŸäº›æ¥å£è¿›è¡Œåé€‰ï¼Œè¿™ä¸ªå¤§å®¶è‡ªè¡Œå°è¯•ã€‚

å¯ä»¥é€šè¿‡æ·»åŠ æ‰“å°çš„æ–¹å¼ï¼Œè·å–æš´éœ²çš„æ‰€æœ‰æ¥å£ã€‚

![image-20250424105305540](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424105305540.png)

å¯ä»¥çœ‹åˆ°æ­¤æ—¶åªæœ‰`get_weather_cityname`è¿™ä¸ªæ¥å£æ”¾å…¥äº†`MCP Server`ã€‚

### é€šè¿‡tagsè¿›è¡Œç­›é€‰

`operation_id`ä¸€èˆ¬ç”¨äºæ§åˆ¶å•ä¸ªæ¥å£çš„æš´éœ²ä¸å¦ï¼Œå¦‚æœæˆ‘ä»¬å…ˆè¦æ‰¹é‡å»æ§åˆ¶æŸäº›æ¥å£çš„æš´éœ²ä¸å¦ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`tags`è¿›è¡Œæ§åˆ¶ã€‚

æˆ‘ä»¬ç»™å‰é¢`FastAPI`ä¸­çš„`get_weather_cityname`å·¥å…·æ·»åŠ `tags='mcp'`ã€‚

![image-20250424105707199](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424105707199.png)

ç„¶åå°±å¯ä»¥åœ¨`FastAPI-MCP`ä¸­é€šè¿‡`tags`è¿›è¡Œç­›é€‰ã€‚

![image-20250424105746803](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424105746803.png)

é€šè¿‡è¿™æ ·çš„æ–¹å¼å°±å¯ä»¥æŠŠæ‰€æœ‰æ ‡è®°ä¸º`tags='mcp'`çš„æ¥å£å…¨éƒ¨æš´éœ²å‡ºæ¥ï¼Œæ²¡æœ‰æ ‡è®°çš„æ¥å£å…¨éƒ¨éƒ½ä¸ä¼šæš´éœ²ç»™`MCP Server`ã€‚

åŒæ ·åœ¨è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨`exclude_tags`è¿›è¡Œ`tags`çš„åé€‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå°è¯•ã€‚

![image-20250424105922623](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424105922623.png)

å¯ä»¥çœ‹åˆ°æ­¤æ—¶ï¼ŒåŒæ ·åªæœ‰`get_weather_cityname`è¿™ä¸ªæ¥å£æ”¾å…¥äº†`MCP Server`ã€‚

## å€¼å¾—æ”¹è¿›çš„æ€è€ƒ

ç°åœ¨çš„`FastAPI-MCP`è¿˜æ˜¯éå¸¸ä¾èµ–æ¥å£æ³¨é‡Šçš„è¯¦ç»†ç¨‹åº¦ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯å°†æ¥å£æ³¨é‡Šæœºæ¢°çš„æ”¾å…¥åˆ°æç¤ºè¯ä¸­ã€‚è¿™ä¸ªæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒè¯•çœ‹åˆ°ã€‚

åœ¨å›¾ç¤ºä½ç½®æ·»åŠ æ–­ç‚¹ï¼Œç„¶åå¼€å¯è°ƒè¯•ã€‚

![image-20250424102753910](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424102753910.png)

åœ¨è°ƒè¯•æ§åˆ¶å°ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼Œæ‰“å°å·¥å…·æè¿°ã€‚

```plain
print(mcp.tools[0].description)
```

![image-20250424102833646](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424102833646.png)

å·¥å…·æè¿°è¯¦æƒ…

~~~plain
Get Weather Cityname

é€šè¿‡åŸå¸‚åç§°ï¼ˆä¸­å›½åŸå¸‚ä½¿ç”¨æ‹¼éŸ³ï¼‰è·å–å¤©æ°”ä¿¡æ¯

Args:
    cityname: åŸå¸‚åç§°ï¼ˆä¸­å›½åŸå¸‚ä½¿ç”¨æ‹¼éŸ³ï¼‰

Returns:
    code: 0 æˆåŠŸ -1 å¤±è´¥
    weather: å¤©æ°”ä¿¡æ¯
    msg: æˆåŠŸæˆ–å¤±è´¥ä¿¡æ¯

### Responses:

**200**: Successful Response (Success Response)
Content-Type: application/json

**Example Response:**
```json
{
  "code": 1,
  "msg": "Msg"
}
```

**Output Schema:**
```json
{
  "properties": {
    "code": {
      "type": "integer",
      "title": "Code"
    },
    "weather": {},
    "msg": {
      "type": "string",
      "title": "Msg"
    }
  },
  "type": "object",
  "required": [
    "code",
    "msg"
  ],
  "title": "WeatherResponse"
}
```
**422**: Validation Error
Content-Type: application/json

**Example Response:**
```json
{
  "detail": [
    {
      "loc": [],
      "msg": "Message",
      "type": "Error Type"
    }
  ]
}
```

**Output Schema:**
```json
{
  "properties": {
    "detail": {
      "items": {
        "properties": {
          "loc": {
            "items": {},
            "type": "array",
            "title": "Location"
          },
          "msg": {
            "type": "string",
            "title": "Message"
          },
          "type": {
            "type": "string",
            "title": "Error Type"
          }
        },
        "type": "object",
        "required": [
          "loc",
          "msg",
          "type"
        ],
        "title": "ValidationError"
      },
      "type": "array",
      "title": "Detail"
    }
  },
  "type": "object",
  "title": "HTTPValidationError"
}
```
~~~

å®é™…ä¸Šï¼Œ`FastAPI`å¯¹äº`pydantic`å·¥å…·é›†ä¸­åº¦éå¸¸é«˜ï¼Œç”¨æˆ·å¦‚æœé€šè¿‡ä»¥ä¸‹æ–¹å¼å»å®šä¹‰å˜é‡ã€‚

```plain
from pydantic import BaseModel, Field

class CityName(BaseModel):
    cityname: str = Field(..., description="åŸå¸‚åç§°ï¼Œå¦‚æœæ˜¯ä¸­å›½åŸå¸‚ï¼Œéœ€è¦ä½¿ç”¨æ‹¼éŸ³ã€‚")
```

åœ¨å®šä¹‰å˜é‡æ—¶ï¼Œç”¨æˆ·å°±ç»™å‡ºäº†è¯¦ç»†çš„å­—æ®µè§£é‡Šï¼Œå®é™…ä¸Šè¿™é‡Œçš„è§£é‡Šæ˜¯çœŸæ­£éœ€è¦å†™å…¥åˆ°æç¤ºè¯ä¸­çš„å†…å®¹ï¼Œç°åœ¨çš„`FastAPI-MCP`ç‰ˆæœ¬æ²¡æœ‰å¯¹è¿™æ ·çš„æ•°æ®è¿›è¡Œè·å–ã€‚ç”¨æˆ·å¦‚æœä¸ºäº†é€‚é…ï¼Œ`FastAPI-MCP`å°±æ¯”å¦‚åœ¨æ¯ä¸ªæ¥å£ä¸­é‡å¤çš„æŠŠå­—æ®µè§£é‡Šç¼–å†™ä¸€è¾¹ï¼Œæ˜¾å¾—ä¸å¤ªæ™ºèƒ½å’Œç¹çã€‚

å…¶æ¬¡ï¼Œå¦‚æœæ˜¯å°†æ¥å£ä¿®æ”¹ä¸º`MCP Server`æœ‰å¯èƒ½è¿˜ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™æ¥å£æ—¶ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–çš„`JSON`ä½œä¸ºè¾“å‡ºå†…å®¹ã€‚å¦‚æœç›´æ¥æŠŠ`JSON`è¿”å›ç»™åˆ°å¤§æ¨¡å‹ï¼Œé‚£ä¹ˆè¿”å›ç»“æœä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å¿…é¡»åœ¨æ¥å£çš„æ³¨é‡Šä¸­è¯¦ç»†å†™æ¸…æ¥šï¼Œå¦‚æœæ²¡æœ‰å†™æ¸…æ¥šï¼Œå¹¶ä¸”`JSON`å­—æ®µçš„å‘½åå¯è§£é‡Šæ€§ä¸å¥½ï¼Œå¯èƒ½å°±ä¼šå¯¼è‡´å¤§æ¨¡å‹ç†è§£å‡ºç°é—®é¢˜ã€‚

å¦‚æœ`FastAPI-MCP`èƒ½å¤Ÿå¯¹å­—æ®µè§£é‡Šè¿›è¡Œè§£è¯»ï¼Œè¿™ä¸ªé—®é¢˜å®é™…ä¸Šä¹Ÿæ˜¯å¯ä»¥å¾—åˆ°è§£å†³çš„ï¼Œå› ä¸ºåœ¨å®šä¹‰`FastAPI`æ¥å£æ—¶ï¼Œå¯ä»¥æŒ‡å®š`response_model`ã€‚

![image-20250424104329754](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250424104329754.png)

# Qwen3 MCPå®æµ‹

## å¤§æ¨¡å‹åŸç”Ÿæ”¯æŒMCPåè®®æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·ä»é›¶å¼€å§‹æ­å»ºäº†é€‚é…æ‰€æœ‰å¤§æ¨¡å‹çš„`MCP Client`ï¼Œæ— è®ºæˆ‘ä»¬é€‰æ‹©ä»€ä¹ˆå¤§æ¨¡å‹ï¼Œéƒ½å¯ä»¥å®Œæˆ`MCP`å·¥å…·çš„è°ƒç”¨ã€‚ç”±äºæˆ‘ä»¬å®ç°çš„æ–¹å¼æ˜¯é€šè¿‡åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­å¯¹å¤§æ¨¡å‹çš„è¾“å‡ºå†…å®¹è¿›è¡Œé™åˆ¶ï¼Œå¹¶å¼ºåˆ¶è§„èŒƒäº†å¤§æ¨¡å‹çš„è¾“å‡ºç»“æœï¼Œå½“å¤§æ¨¡å‹è¦è¿›è¡Œå·¥å…·è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬åˆ©ç”¨æç¤ºè¯è¦æ±‚å¤§æ¨¡å‹æŒ‰ç…§`MCP`åè®®è¾“å‡ºå¯¹åº”çš„è§„èŒƒåŒ–ç»“æœã€‚è¿™æ ·åšè™½ç„¶é™ä½äº†æˆ‘ä»¬å¤§æ¨¡å‹çš„é€‰æ‹©é—¨æ§›ï¼Œä½†æ˜¯åŒæ ·ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œå…¶ä¸­æœ€çªå‡ºçš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¸€ä½†å¤§æ¨¡å‹æ²¡æœ‰æŒ‰ç…§`MCP`åè®®çš„è¦æ±‚è¾“å‡ºè§„èŒƒåŒ–çš„ç»“æœï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´`MCP`å·¥å…·è°ƒç”¨å¤±è´¥ï¼Œæ­£æ˜¯ç”±äºè¿™ç§ä¸ç¡®å®šæ€§çš„å­˜åœ¨ï¼Œå¯¼è‡´å¾ˆå¤šä¼ä¸šä¸æ”¾å¿ƒçœŸæ­£åœ¨ç”Ÿäº§ä¸­å»ä½¿ç”¨`MCP`ç›¸å…³å·¥å…·ï¼Œä»ç„¶åœç•™åœ¨æµ‹è¯•ç¯èŠ‚ä¸­ã€‚

éšç€å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆ`LLM`ï¼‰çš„è¿›ä¸€æ­¥å‘å±•ï¼Œå¤§æ¨¡å‹å¯¹äº`MCP`åè®®çš„æ”¯æŒåº¦ï¼Œä¹Ÿæˆä¸ºäº†æ¶ˆè´¹è€…åœ¨é€‰æ‹©å¤§æ¨¡å‹çš„ä¸Šçš„ä¸€ä¸ªå‚è€ƒæ ‡å‡†ã€‚å¤§æ¨¡å‹â€œåŸç”Ÿæ”¯æŒ`MCP`åè®®â€æ„å‘³ç€è¯¥æ¨¡å‹è‡ªèº«å…·å¤‡å†…ç½®çš„ã€éµå¾ª `MCP`ï¼ˆ`Model Context Protocol`ï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰è§„èŒƒçš„èƒ½åŠ›ï¼Œæ— éœ€é¢å¤–çš„é€‚é…å±‚æˆ–ä¸­é—´ä»¶ï¼Œå°±èƒ½ç›´æ¥ä¸å„ç§æ•°æ®æºã€å·¥å…·å’ŒæœåŠ¡è¿›è¡ŒåŒå‘ã€å®‰å…¨ã€é«˜æ•ˆçš„é€šä¿¡ã€‚è¿™æ ·çš„åŸç”Ÿæ”¯æŒä¸ä»…æå‡äº†æ¨¡å‹åœ¨è°ƒç”¨å¤–éƒ¨æ¥å£æ—¶çš„é€Ÿåº¦å’Œç¨³å®šæ€§ï¼Œä¹Ÿç®€åŒ–äº†å¼€å‘è€…çš„é›†æˆå·¥ä½œï¼Œè®©æ¨¡å‹ä¸åº”ç”¨é—´çš„äº¤äº’å¦‚åŒâ€œå¼€ç®±å³ç”¨â€èˆ¬æµç•…ã€‚

è¯´å¾—é€šä¿—ä¸€ç‚¹ï¼ŒåŸç”Ÿæ”¯æŒ`MCP`åè®®çš„å¤§æ¨¡å‹ï¼Œå°±æ˜¯æ¨¡å‹åœ¨å¾®è°ƒé˜¶æ®µï¼Œä½¿ç”¨äº†`MCP`åè®®ç›¸å…³çš„æ•°æ®å¯¹æ¨¡å‹è¿›è¡Œè¿‡å¾®è°ƒï¼Œä½¿å¾—å¤§æ¨¡å‹åŸç”Ÿå°±çŸ¥é“`MCP`åè®®çš„è§„èŒƒï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨`MCP`å·¥å…·æ—¶ï¼Œå¤§å¤§é™ä½å¤§æ¨¡å‹å‡ºé”™çš„å¯èƒ½æ€§ã€‚

## Qwen3ç®€å•ä»‹ç»

![image-20250430154355184](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430154355184.png)

4æœˆ29æ—¥å‡Œæ™¨é˜¿é‡Œæ¨å‡ºæ–°ä¸€ä»£å¼€æºå¤§æ¨¡å‹`Qwen3`ç³»åˆ—ï¼Œåœ¨ä»£ç ã€æ•°å­¦ã€é€šç”¨èƒ½åŠ›ç­‰åŸºå‡†æµ‹è¯•ä¸­è¾¾åˆ°é¡¶çº§æ¨¡å‹æ°´å¹³ï¼ˆå¦‚`DeepSeek-R1`ã€`o1`ã€`Grok-3`ç­‰ï¼‰ã€‚

**æœ‰æ•ˆèåˆæ¨ç†æ¨¡å¼å’Œéæ¨ç†æ¨¡å¼ï¼Œä¸€ä¸ªæ¨¡å‹åŒæ—¶å…¼å…·ä¹‹å‰QwQæ¨¡å‹ï¼ˆæ¨ç†æ¨¡å¼ï¼Œç”¨äºæ•°å­¦ã€ä»£ç ã€é€»è¾‘æ¨ç†ç­‰åœºæ™¯ï¼‰å’Œinstructæ¨¡å‹ï¼ˆéæ¨ç†æ¨¡å¼ï¼Œé€šç”¨å¯¹è¯ç­‰åœºæ™¯ï¼‰çš„å›å¤èƒ½åŠ›ã€‚**

- **è¶…å¤šå°ºå¯¸ï¼šä¸¤æ¬¾MOEæ¨¡å‹ï¼š**Qwen3-235B-A22Bï¼ˆ2350å¤šäº¿æ€»å‚æ•°ã€ 220å¤šäº¿æ¿€æ´»å‚ï¼‰ã€Qwen3-32Bï¼ˆ300äº¿æ€»å‚æ•°ã€30äº¿æ¿€æ´»å‚æ•°ï¼‰ï¼Œä»¥åŠ**å…­ä¸ªDenseæ¨¡å‹**ï¼šQwen3-30B-A3Bã€Qwen3-14Bã€Qwen3-8Bã€Qwen3-4Bã€Qwen3-1.7Bã€Qwen3-0.6Bã€‚
- **æ¨ç†èƒ½åŠ›å¤§å¹…æå‡ï¼š**åœ¨æ•°å­¦ã€ä»£ç å’Œé€»è¾‘æ¨ç†ç­‰è¯„æµ‹ä¸­ï¼Œæ˜¾è‘—è¶…è¿‡QwQï¼ˆæ¨ç†æ¨¡å¼ï¼‰å’ŒQwen2.5-Plus-Instructï¼ˆéæ¨ç†æ¨¡å¼ï¼‰ï¼Œè¾¾åˆ°åŒè§„æ¨¡ä¸šç•ŒSOTAæ°´å¹³ã€‚
- **æ¨¡å‹äººç±»åå¥½èƒ½åŠ›æ˜¾è‘—å¢å¼ºï¼š**åˆ›æ„å†™ä½œã€è§’è‰²æ‰®æ¼”ã€å¤šè½®å¯¹è¯ã€æŒ‡ä»¤éµå¾ªèƒ½åŠ›å‡æœ‰æ˜æ˜¾æå‡ï¼Œç”¨æˆ·ä½“éªŒé¢„æœŸæ˜æ˜¾æ›´ä½³ï¼Œé€šç”¨èƒ½åŠ›æ˜¾è‘—è¶…è¿‡Qwen2.5-Plus-Instructã€‚
- **Agentèƒ½åŠ›æ˜¾è‘—å¢å¼ºï¼š**åœ¨ä¸Šè¿°ä¸¤ç§æ¨¡å¼ä¸‹éƒ½è¾¾åˆ°ç›®å‰ä¸šç•Œé¢†å…ˆæ°´å¹³ï¼Œèƒ½å¤Ÿå®ç°ç²¾å‡†çš„å¤–éƒ¨å·¥å…·è°ƒç”¨ã€‚

æ­¤å¤–ï¼Œ`Qwen3`åŸç”Ÿæ”¯æŒ`MCP`åè®®ï¼Œå¹¶å…·å¤‡å¼ºå¤§çš„å·¥å…·è°ƒç”¨èƒ½åŠ›ï¼Œç»“åˆå°è£…äº†å·¥å…·è°ƒç”¨æ¨¡æ¿å’Œå·¥å…·è°ƒç”¨è§£æå™¨çš„`Qwen-Agent`æ¡†æ¶ã€‚

## Qwen3çš„MCPå®æµ‹

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Qwen-Agent`å¯¹`Qwen3`çš„å·¥å…·è°ƒç”¨èƒ½åŠ›è¿›è¡Œæµ‹è¯•ã€‚

ä½¿ç”¨`uv`å·¥å…·åˆ›å»ºæµ‹è¯•å·¥ç¨‹ï¼š

```plain
uv init qwen3-mcp-test -p 3.12
```

![image-20250430154917253](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430154917253.png)

è¿›å…¥å·¥ç¨‹ï¼Œç„¶ååˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

![image-20250430155013780](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430155013780.png)

å®‰è£…ä¾èµ–ï¼š

```plain
uv add qwen-agent[code-interpreter,gui,mcp,rag]
```

![image-20250430155116543](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430155116543.png)

æ¥ä¸‹æ¥æ‰§è¡Œæµ‹è¯•ä»£ç ï¼š

å¤åˆ¶

```plain
from qwen_agent.agents import Assistant
from dotenv import load_dotenv
import os

load_dotenv()

API_KEY = os.getenv("API_KEY")
BASE_URL = os.getenv("BASE_URL")
MODEL = os.getenv("MODEL")


llm_cfg = {
    'model': MODEL,
    'model_server': BASE_URL,
    'api_key': API_KEY,
    'enable_thinking': False  
}

tools = [
    {
        "mcpServers": {
            "time-sse": {
            "url": "https://time.mcp.minglog.cn/sse",
            "name": "time-sse"
            }
        }
    },
  'code_interpreter'  
]

bot = Assistant(llm=llm_cfg, function_list=tools)

messages = [{'role': 'user', 'content': 'ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ'}]

for responses in bot.run(messages=messages):
    ...
print(responses)
print("___________________")
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘è°ƒç”¨çš„æ˜¯è‡ªå·±å†™çš„`MCP Server`ï¼Œå¤§å®¶éœ€è¦è‡ªå·±åœ¨å·¥ç¨‹ä¸­å¦å¤–åˆ›å»ºä¸€ä¸ª`.env`æ–‡ä»¶ï¼Œç”¨æ¥å­˜å‚¨è‡ªå·±çš„å¯†é’¥ã€‚

![image-20250430155302050](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430155302050.png)

æ‰§è¡Œæµ‹è¯•ä»£ç ï¼š

![image-20250430155532042](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430155532042.png)

å¼€å¯è°ƒè¯•ï¼ŒæŸ¥çœ‹è¾“å‡ºç»“æœçš„ç»†èŠ‚ä¿¡æ¯ã€‚

![image-20250430161133212](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430161133212.png)

å¯ä»¥çœ‹åˆ°ï¼Œ`responses`ä¸€å…±è¿”å›äº†`5`æ¡ç»“æœï¼Œä¾æ¬¡å°†æ¯æ¡ç»“æœæ‰“å°å‡ºæ¥ã€‚

![image-20250430161110870](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250430161110870.png)

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹å‡ºï¼Œ`qwen-agent`æ¡†æ¶åœ¨å¤„ç†æ—¶ï¼Œæ•´ä½“çš„æµç¨‹å’Œ`Function Call`çš„å¤„ç†æµç¨‹ä¸€è‡´ã€‚

1. é¦–å…ˆæ ¹æ®ç”¨æˆ·çš„æé—®ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ã€‚
2. å¦‚æœéœ€è¦è°ƒç”¨å·¥å…·ï¼Œåˆ™è¿”å›`function_call`å­—æ®µï¼Œå¹¶æºå¸¦å·¥å…·ç›¸å…³å‚æ•°ã€‚å¦‚æœä¸éœ€è¦è°ƒç”¨å·¥å…·ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
3. è°ƒç”¨å·¥å…·æ‰§è¡Œç›¸å…³åŠŸèƒ½ï¼Œå¹¶å°†å·¥å…·çš„è¿”å›ç»“æœè¿”å›ã€‚
4. å°†ç”¨æˆ·çš„æé—®å’Œå·¥å…·çš„è¿”å›ç»“æœä¸€èµ·ä¸¢ç»™å¤§æ¨¡å‹ã€‚
5. å¤§æ¨¡å‹ç»¼åˆå·¥å…·çš„è¿”å›ç»“æœå’Œç”¨æˆ·çš„æé—®ï¼Œç»™äºˆç”¨æˆ·æœ€ç»ˆå›ç­”ã€‚

ç»“è®ºï¼Œæœ¬è´¨ä¸Šæ¥è®²`MCP`æ˜¯`Function Call`çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œæ‰€ä»¥åœ¨`Agent`æ¡†æ¶ä¸­çš„å¤„ç†æ–¹å¼å’Œ`Function Call`çš„å¤„ç†æ–¹å¼ä¸€è‡´ã€‚

# Streamable HTTP â€”â€” MCPåè®®çš„ä¼ è¾“æœºåˆ¶é©æ–°

éšç€äººå·¥æ™ºèƒ½ï¼ˆ`AI`ï¼‰æŠ€æœ¯çš„è¿…çŒ›å‘å±•ï¼ŒAIåŠ©æ‰‹ä¸åº”ç”¨ç¨‹åºä¹‹é—´çš„é«˜æ•ˆé€šä¿¡å˜å¾—å°¤ä¸ºé‡è¦ã€‚æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼ˆ`Model Context Protocol`ï¼Œç®€ç§°`MCP`ï¼‰åº”è¿è€Œç”Ÿï¼Œæ—¨åœ¨ä¸ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆ`LLMs`ï¼‰ä¸å¤–éƒ¨æ•°æ®æºå’Œå·¥å…·ä¹‹é—´æä¾›æ ‡å‡†åŒ–çš„æ¥å£ã€‚åœ¨`MCP`çš„ä¼—å¤šç‰¹æ€§ä¸­ï¼Œ`Streamable HTTP`ä¼ è¾“æœºåˆ¶ä½œä¸ºä¸€ç§ç°ä»£åŒ–çš„é€šä¿¡æ–¹å¼ï¼Œæ­£åœ¨é€æ¸å–ä»£ä¼ ç»Ÿçš„`Server-Sent Eventsï¼ˆSSEï¼‰`ä¼ è¾“æ–¹å¼ï¼Œæˆä¸º`AI`é€šä¿¡çš„æ–°æ ‡å‡†ã€‚

![image-20250513181409075](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513181409075.png)

## MCPåè®®æ¦‚è¿°

`MCP`æ˜¯ç”±`Anthropic`æ¨åŠ¨çš„ä¸€é¡¹å¼€æ”¾æ ‡å‡†ï¼Œæ—¨åœ¨è§£å†³LLMsåœ¨æ‰§è¡Œä»»åŠ¡æ—¶å¯¹å¤–éƒ¨ä¿¡æ¯çš„ä¾èµ–é—®é¢˜ã€‚é€šè¿‡å®šä¹‰ä¸€å¥—é€šç”¨çš„é€šä¿¡è§„åˆ™å’Œæ•°æ®æ ¼å¼ï¼Œ`MCP`ä½¿å¾—`LLMs`èƒ½å¤ŸåŠ¨æ€åœ°è·å–æ‰€éœ€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»è€Œå¢å¼ºå…¶åŠŸèƒ½å’Œä½¿ç”¨èŒƒå›´ã€‚`MCP`çš„æ ¸å¿ƒæ¶æ„åŒ…æ‹¬ï¼š

- **MCPå®¢æˆ·ç«¯**ï¼šåœ¨`LLM`æˆ–å…¶æœåŠ¡åŸºç¡€è®¾æ–½ç«¯çš„å®ç°ï¼Œè´Ÿè´£æ„å»ºè¯·æ±‚å¹¶å‘é€ç»™`MCP`æœåŠ¡å™¨ã€‚
- **MCPæœåŠ¡å™¨**ï¼šåœ¨å¤–éƒ¨ç³»ç»Ÿç«¯çš„å®ç°ï¼Œæ¥æ”¶æ¥è‡ª`MCP`å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¸å®é™…çš„æ•°æ®æºæˆ–å·¥å…·è¿›è¡Œäº¤äº’ï¼Œå¹¶å°†è·å–çš„æ•°æ®æŒ‰ç…§`MCP`åè®®è§„èŒƒæ ¼å¼åŒ–åè¿”å›ç»™å®¢æˆ·ç«¯ã€‚
- **ä¸Šä¸‹æ–‡ä¿¡æ¯äº¤æ¢**ï¼šä¿ƒè¿›`LLMs`ä¸å¤–éƒ¨ç³»ç»Ÿä¹‹é—´ä¸Šä¸‹æ–‡ä¿¡æ¯çš„åŒå‘äº¤æ¢ã€‚

é€šè¿‡`MCP`ï¼Œå¼€å‘è€…å¯ä»¥æ›´è½»æ¾åœ°å°†AIåŠ©æ‰‹ä¸å„ç§åº”ç”¨ç¨‹åºå’Œæ•°æ®æºé›†æˆï¼Œå®ç°æ›´é«˜æ•ˆçš„`AI`é€šä¿¡ã€‚

## ä¼ ç»ŸSSEçš„å±€é™æ€§

`Server-Sent Eventsï¼ˆSSEï¼‰`æ˜¯ä¸€ç§åŸºäº`HTTP`çš„å•å‘é€šä¿¡åè®®ï¼Œå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å®æ—¶æ›´æ–°ã€‚ç„¶è€Œï¼Œ`SSE`åœ¨ä»¥ä¸‹æ–¹é¢å­˜åœ¨å±€é™æ€§ï¼š

- **é€šä¿¡æ–¹å‘å—é™**ï¼š`SSE`ä»…æ”¯æŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯çš„å•å‘é€šä¿¡ï¼Œæ— æ³•æ»¡è¶³åŒå‘äº¤äº’çš„éœ€æ±‚ã€‚
- **ä¼šè¯ç®¡ç†ç¼ºå¤±**ï¼š`SSE`ç¼ºä¹å†…å»ºçš„ä¼šè¯ç®¡ç†æœºåˆ¶ï¼Œéš¾ä»¥å®ç°å¤æ‚çš„çŠ¶æ€ç»´æŠ¤ã€‚
- **è¿æ¥æ¢å¤èƒ½åŠ›å¼±**ï¼šåœ¨ç½‘ç»œä¸­æ–­åï¼Œ`SSE`çš„è¿æ¥æ¢å¤èƒ½åŠ›æœ‰é™ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚
- **æ•°æ®æ ¼å¼æ”¯æŒæœ‰é™**ï¼š`SSE`ä¸»è¦æ”¯æŒ`UTF-8`æ–‡æœ¬ï¼Œæ— æ³•å¤„ç†å¤šç§æ•°æ®æ ¼å¼ã€‚

è¿™äº›å±€é™æ€§ä½¿å¾—`SSE`åœ¨ç°ä»£`AI`åº”ç”¨ä¸­é€æ¸æ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚

## Streamable HTTPçš„åˆ›æ–°ä¹‹å¤„

`Streamable HTTP`æ˜¯`MCP`æ¡†æ¶ä¸­æ¨èçš„ä¼ è¾“æœºåˆ¶ï¼Œæ—¨åœ¨é€šè¿‡æ ‡å‡†`HTTP`å®ç°é«˜æ•ˆã€åŒå‘çš„æ•°æ®æµé€šä¿¡ã€‚å…¶ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- **å•ä¸€ç«¯ç‚¹é€šä¿¡**ï¼šä½¿ç”¨å•ä¸€`HTTP`ç«¯ç‚¹å¤„ç†æ‰€æœ‰`MCP`é€šä¿¡ï¼Œç®€åŒ–äº†ç½‘ç»œæ¶æ„ã€‚
- **å¤šç§å“åº”æ¨¡å¼**ï¼šæ”¯æŒæ‰¹é‡`ï¼ˆJSONï¼‰`å’Œæµå¼`ï¼ˆSSEï¼‰`å“åº”ï¼Œæ»¡è¶³ä¸åŒçš„é€šä¿¡éœ€æ±‚ã€‚
- **å†…å»ºä¼šè¯ç®¡ç†**ï¼šé€šè¿‡`Mcp-Session-Id`å¤´éƒ¨è¿›è¡Œä¼šè¯ç®¡ç†ï¼Œç®€åŒ–äº†çŠ¶æ€ç»´æŠ¤ã€‚
- **è¿æ¥å¯æ¢å¤æ€§**ï¼šæ”¯æŒåœ¨ç½‘ç»œä¸­æ–­åæ¢å¤`SSE`è¿æ¥ï¼Œæé«˜é€šä¿¡çš„ç¨³å®šæ€§ã€‚
- **çµæ´»çš„èº«ä»½éªŒè¯**ï¼šæ”¯æŒå¤šç§èº«ä»½éªŒè¯æ–¹å¼ï¼Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚
- **è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰é…ç½®**ï¼šæä¾›çµæ´»çš„`CORS`é…ç½®ï¼Œä¾¿äºWebåº”ç”¨çš„é›†æˆã€‚

è¿™äº›ç‰¹æ€§ä½¿å¾—`Streamable HTTP`åœ¨ç°ä»£`AI`é€šä¿¡ä¸­å…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ã€‚

## æŠ€æœ¯å¯¹æ¯”ï¼šSSE vs. Streamable HTTP

| ç‰¹æ€§                   | ä¼ ç»Ÿ`SSE`ä¼ è¾“           | `Streamable HTTP`åè®®ï¼ˆ`MCP`ï¼‰ |
| ---------------------- | ----------------------- | ------------------------------ |
| é€šä¿¡æ–¹å‘               | å•å‘ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰ | åŒå‘ï¼ˆå®¢æˆ·ç«¯ â†” æœåŠ¡å™¨ï¼‰        |
| ä¼šè¯ç®¡ç†               | æ— å†…å»ºæœºåˆ¶              | åŸºäº`Mcp-Session-Id`å¤´éƒ¨       |
| æ•°æ®æ ¼å¼æ”¯æŒ           | ä»…æ”¯æŒUTF-8æ–‡æœ¬         | æ”¯æŒå¤šç§æ•°æ®æ ¼å¼               |
| è‡ªåŠ¨é‡è¿               | æ”¯æŒ                    | æ”¯æŒ                           |
| ä¸ç°æœ‰åŸºç¡€è®¾æ–½çš„å…¼å®¹æ€§ | é«˜                      | é«˜                             |

ä»ä¸Šè¿°å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼Œ`Streamable HTTP`åœ¨é€šä¿¡çµæ´»æ€§ã€ä¼šè¯ç®¡ç†å’Œæ•°æ®æ ¼å¼æ”¯æŒç­‰æ–¹é¢å‡ä¼˜äºä¼ ç»Ÿçš„`SSE`ä¼ è¾“æ–¹å¼ã€‚

## å®ç°ä¸æ•ˆæœæ¼”ç¤º

## åŸºäºStreamable HTTPçš„MCP Server

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·ç¼–å†™è¿‡åŸºäº`sse`åè®®çš„å¤©æ°”æŸ¥è¯¢`MCP Server`å¹¶æˆåŠŸéƒ¨ç½²åˆ°çº¿ä¸Šã€‚

é¡¹ç›®åœ°å€ï¼šhttps://gitee.com/ming_log/mcp-server

å°†åŸºäº`sse`åè®®çš„`MCP Server`ä¿®æ”¹ä¸º`Streamable HTTP`åè®®ï¼Œæ–¹æ³•éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†`MCP Server`çš„æ‰§è¡Œæ–¹å¼ä¿®æ”¹ä¸º`streamable-http`å³å¯ã€‚

![image-20250513175712008](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513175712008.png)

æ³¨æ„ï¼šéœ€è¦é¦–å…ˆæ›´æ–°ä¸€ä¸‹`mcp[cli]`çš„ç‰ˆæœ¬ä¸º`1.8.0`ã€‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

å¤åˆ¶

```plain
from typing import Any
import httpx
from mcp.server.fastmcp import FastMCP


mcp = FastMCP(
    name="weather",
    host="0.0.0.0",
    port=8002,
    description="é€šè¿‡åŸå¸‚åç§°ï¼ˆæ‹¼éŸ³ï¼‰æˆ–ç»çº¬åº¦è·å–å¤©æ°”ä¿¡æ¯",
    sse_path="/mcp"
)


NWS_API_BASE = "https://api.openweathermap.org/data/2.5/weather"
USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36"


def kelvin_to_celsius(kelvin: float) -> float:
    return kelvin - 273.15

async def get_weather_from_cityname(cityname: str) -> dict[str, Any] | None:
    """å‘openweathermapå‘é€è¯·æ±‚å¹¶è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†ã€‚"""
    headers = {
        "User-Agent": USER_AGENT,
        "Accept": "application/geo+json"
    }
    params = {
        "q": cityname,
        "appid": "24ecadbe4bb3d55cb1f06ea48a41ac51"
    }
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(NWS_API_BASE, headers=headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None
        

async def get_weather_from_latitude_longitude(latitude: float, longitude: float) -> dict[str, Any] | None:
    """å‘openweathermapå‘é€è¯·æ±‚å¹¶è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†ã€‚"""
    headers = {
        "User-Agent": USER_AGENT,
        "Accept": "application/geo+json"
    }
    params = {
        "lat": latitude,
        "lon": longitude,
        "appid": "24ecadbe4bb3d55cb1f06ea48a41ac51"
    }
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(NWS_API_BASE, headers=headers, params=params)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None

def format_alert(feature: dict) -> str:
    """å°†æ¥å£è¿”å›çš„å¤©æ°”ä¿¡æ¯è¿›è¡Œæ ¼å¼åŒ–æ–‡æœ¬è¾“å‡º"""
    if feature["cod"] == 404:
        return "å‚æ•°å¼‚å¸¸ï¼Œè¯·ç¡®è®¤åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"
    elif feature["cod"] == 401:
        return "API key å¼‚å¸¸ï¼Œè¯·ç¡®è®¤API keyæ˜¯å¦æ­£ç¡®ã€‚"
    elif feature["cod"] == 200:
        return f"""
        City: {feature.get('name', 'Unknown')}
        Weather: {feature.get('weather', [{}])[0].get('description', 'Unknown')}
        Temperature: {kelvin_to_celsius(feature.get('main', {}).get('temp', 0)):.2f}Â°C
        Humidity: {feature.get('main', {}).get('humidity', 0)}%
        Wind Speed: {feature.get('wind', {}).get('speed', 0):.2f} m/s
        """
    else:
        return "æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚"

@mcp.tool()
async def get_weather_from_cityname_tool(city: str) -> str:
    """Get weather information for a city.

    Args:
        city: City name (e.g., "wuhan"). For Chinese cities, please use pinyin
    """
    data = await get_weather_from_cityname(city)
    return format_alert(data)

@mcp.tool()
async def get_weather_from_latitude_longitude_tool(latitude: float, longitude: float) -> str:
    """Get weather information for a location.

    Args:
        latitude: Latitude of the location
        longitude: Longitude of the location
    """
    data = await get_weather_from_latitude_longitude(latitude, longitude)
    return format_alert(data)

if __name__ == "__main__":
    
    
    print("Starting server...")
    mcp.run(transport='streamable-http')
```

å¼€å¯æœåŠ¡

![image-20250513175829712](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513175829712.png)

æ¥ä¸‹æ¥æµ‹è¯•è¯¥æœåŠ¡æ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

ç”±äº`Cursor`å¯¹äº`Streamable HTTP`åè®®ç›®å‰è¿˜ä¸æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨`Cherry Studio`æ¥è¿›è¡Œæµ‹è¯•ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œä¸‹è½½ã€‚å®˜ç½‘åœ°å€ï¼šhttps://www.cherry-ai.com/

ä¸‹è½½ç™»é™†åï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„è®¾ç½®ã€‚

![image-20250513180108389](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180108389.png)

ç„¶åç‚¹å‡»`MCP`æœåŠ¡å™¨

![image-20250513180143361](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180143361.png)

æ¥ä¸‹æ¥ç‚¹å‡»æ·»åŠ æœåŠ¡å™¨ï¼Œå°†æˆ‘ä»¬åˆšæ‰å¼€å¯çš„`MCP Server`é…ç½®è¿›å»ã€‚

![image-20250513180223922](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180223922.png)

æŒ‰ç…§ä¸‹å›¾æ‰€ç¤ºçš„å†…å®¹å¡«å†™ã€‚

![image-20250513180301435](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180301435.png)

ç„¶åç‚¹å‡»å³ä¸Šè§’çš„ä¿å­˜ã€‚

![image-20250513180332988](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180332988.png)

å¦‚æœæ²¡æœ‰é—®é¢˜çš„è¯ï¼Œå¯ä»¥çœ‹åˆ°å›¾ç¤ºä¸­æ˜¾ç¤ºçš„ï¼ŒæœåŠ¡å™¨æ›´æ–°æˆåŠŸã€‚å¦‚æœæœ‰é—®é¢˜ä¼šå‡ºç°æŠ¥é”™ã€‚

ä¸ºäº†æµ‹è¯•`MCP Server`æœåŠ¡ï¼Œè¿˜éœ€è¦å¤§å®¶å‡†å¤‡ä¸€ä¸ª`LLM`ï¼Œå¤§å®¶æ ¹æ®è‡ªå·±çš„æƒ…å†µåœ¨è®¾ç½®ä¸­è¿›è¡Œé…ç½®å³å¯ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯`Moonshot`ã€‚

![image-20250513180546680](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180546680.png)

æ¥ä¸‹æ¥å›åˆ°èŠå¤©åŠ©æ‰‹é¡µé¢ï¼Œåˆ›å»ºä¸€ä¸ªèŠå¤©åŠ©æ‰‹ã€‚åœ¨èŠå¤©è¾“å…¥æ¡†ä¸‹æ–¹é€‰æ‹©è¦ä½¿ç”¨çš„`MCP Server`ã€‚

![image-20250513180650887](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513180650887.png)

åˆ°æ­¤ï¼Œæˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œå’Œé…ç½®å·¥ä½œå°±åšå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å‘èŠå¤©åŠ©æ‰‹è¯¢é—®å¤©æ°”ï¼Œæµ‹è¯•`MCP Server`äº†ã€‚

ä¾‹å¦‚ï¼šæˆ‘è¯¢é—®â€œæ­¦æ±‰å’ŒåŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿâ€

![PixPin_2025-05-13_17-21-22](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/PixPin_2025-05-13_17-21-22.gif)

`Streamable HTTP`åè®®åœ¨è®¿é—®`MCP Server`æ—¶æ˜¯å¹¶å‘çš„ï¼Œé€šè¿‡ä»¥ä¸‹åŠ¨å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼ŒåŒ—äº¬çš„å¤©æ°”æ˜¯å…ˆè¯·æ±‚æˆåŠŸçš„ã€‚

![o303p-9167f](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/o303p-9167f.gif)

## åŸºäºStreamable HTTPçš„MCP Client

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç¼–å†™äº†`MCP Client`ä»£ç ï¼Œå¹¶ä¸”åŒæ ·å¯ä»¥æ ¹æ®`mcp.json`é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å¯¹åº”çš„`MCP Server`æœåŠ¡ã€‚å½“æ—¶åªé€‚é…äº†`stdio`å’Œ`sse`åè®®ï¼Œç°åœ¨åŠ ä¸Š`Streamable HTTP`åè®®ã€‚

é¡¹ç›®åœ°å€ï¼šhttps://gitee.com/ming_log/mcp_client

å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
import asyncio
from typing import Optional
from contextlib import AsyncExitStack
import json

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client
from mcp.client.sse import sse_client
from mcp.client.streamable_http import streamablehttp_client

from dotenv import load_dotenv
import os, re
from openai import OpenAI
from lxml import etree

load_dotenv()  

class MCPClient:
    def __init__(self):
        
        self.session: Optional[ClientSession] = None
        self.exit_stack = AsyncExitStack()
        
        self.API_KEY = os.getenv("API_KEY")
        self.BASE_URL = os.getenv("BASE_URL")
        self.MODEL = os.getenv("MODEL")
        self.client = OpenAI(api_key=self.API_KEY, base_url=self.BASE_URL)
        self.sessions = {}
        self.messages = []
        with open("./MCP_Prompt.txt", "r", encoding="utf-8") as file:
            self.system_prompt = file.read()

    async def mcp_json_config(self, mcp_json_file):
        try:
            with open(mcp_json_file, 'r') as f:
                mcp_config: dict = json.load(f)
        except json.JSONDecodeError:
            raise ValueError("Invalid MCP config")
        servers_config: dict = mcp_config.get('mcpServers', {})
        for k, v in servers_config.items():
            try:
                if v.get('isActive', False) == False:
                    continue
                print('-'*50)
                mcp_name = v.get('name', k)
                mcp_type: str = v.get('type', 'stdio')
                if mcp_type.lower() == 'stdio':
                    command = v.get('command', None)
                    args = v.get('args', [])
                    env = v.get('env', {})
                    if command is None:
                        raise ValueError(f'{mcp_name} command is empty.')
                    if args == []:
                        raise ValueError(f'{mcp_name} args is empty.')
                    await self.connect_to_stdio_server(mcp_name, command, args, env)
                elif mcp_type.lower() == 'sse':
                    server_url = v.get('url', None)
                    if server_url is None:
                        raise ValueError(f'{mcp_name} server_url is empty.')
                    await self.connect_to_sse_server(mcp_name, server_url)
                elif mcp_type.lower() == 'streamable_http':
                    server_url = v.get('url', None)
                    if server_url is None:
                        raise ValueError(f'{mcp_name} server_url is empty.')
                    await self.connect_to_streamable_http_server(mcp_name, server_url)
                else:
                    raise ValueError(f'{mcp_name} mcp type must in [stdio, sse, streamable_http].')
            except Exception as e:
                print(f"Error connecting to {mcp_name}: {e}")

    async def connect_to_stdio_server(self, mcp_name, command: str, args: list[str], env: dict[str, str]={}):
        server_params = StdioServerParameters(
            command=command,
            args=args,
            env=env
        )

        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))
        self.sessions[mcp_name] = self.session

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def connect_to_sse_server(self, mcp_name, server_url: str):
        """Connect to an MCP server

        Args:
            server_script_path: Path to the server script (.py or .js)
        """
        stdio_transport = await self.exit_stack.enter_async_context(sse_client(server_url))
        self.sse, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.sse, self.write))
        self.sessions[mcp_name] = self.session

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>\n")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def connect_to_streamable_http_server(self, mcp_name, server_url: str):
        """Connect to an MCP server

        Args:
            server_script_path: Path to the server script (.py or .js)
        """
        stdio_transport = await self.exit_stack.enter_async_context(streamablehttp_client(server_url))
        self.streamable_http, self.write, _ = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.streamable_http, self.write))
        self.sessions[mcp_name] = self.session

        await self.session.initialize()
        
        response = await self.session.list_tools()
        available_tools = ['##' + mcp_name + '\n### Available Tools\n- ' + tool.name + "\n" + tool.description + "\n" + json.dumps(tool.inputSchema) for tool in response.tools]
        self.system_prompt = self.system_prompt.replace("<$MCP_INFO$>", "\n".join(available_tools)+"\n<$MCP_INFO$>\n")
        tools = response.tools
        print(f"Successfully connected to {mcp_name} server with tools:", [tool.name for tool in tools])

    async def process_query(self, query: str) -> str:
        """Process a query using Claude and available tools"""
        self.messages.append(
            {
                "role": "system",
                "content": self.system_prompt
            }
        )
        self.messages.append(
            {
                "role": "user",
                "content": query
            }
        )

        
        response = self.client.chat.completions.create(
            model=self.MODEL,
            max_tokens=1024,
            messages=self.messages
        )

        
        final_text = []
        content = response.choices[0].message.content
        if '<use_mcp_tool>' not in content:
            final_text.append(content)
        else:
            
            server_name, tool_name, tool_args = self.parse_tool_string(content)

            
            result = await self.sessions[server_name].call_tool(tool_name, tool_args)
            print(f"[Calling tool {tool_name} with args {tool_args}]")
            print("-"*40)
            print("Server:", server_name)
            print("Tool:", tool_name)
            print("Args:", tool_args)
            print("-"*40)
            print("Result:", result.content[0].text)
            print("-"*40)
            self.messages.append({
                "role": "assistant",
                "content": content
            })
            self.messages.append({
                "role": "user",
                "content": f"[Tool {tool_name} \n returned: {result}]"
            })

            response = self.client.chat.completions.create(
                model=self.MODEL,
                max_tokens=1024,
                messages=self.messages
            )
            final_text.append(response.choices[0].message.content)
        return "\n".join(final_text)
    
    def parse_tool_string(self, tool_string: str) -> tuple[str, str, dict]:
        tool_string = re.findall("(<use_mcp_tool>.*?</use_mcp_tool>)", tool_string, re.S)[0]
        root = etree.fromstring(tool_string)
        server_name = root.find('server_name').text
        tool_name = root.find('tool_name').text
        try:
            tool_args = json.loads(root.find('arguments').text)
        except json.JSONDecodeError:
            raise ValueError("Invalid tool arguments")
        return server_name, tool_name, tool_args

    async def chat_loop(self):
        """Run an interactive chat loop"""
        print("\nMCP Client Started!")
        print("Type your queries or 'quit' to exit.")
        self.messages = []
        while True:
            try:
                query = input("\nQuery: ").strip()

                if query.lower() == 'quit':
                    break
                if query.strip() == '':
                    print("Please enter a query.")
                    continue
                response = await self.process_query(query)
                print(response)

            except Exception as e:
                print(f"\nError: {str(e)}")

    async def cleanup(self):
        """Clean up resources"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
        
        mcp_config_file = './mcp.json'
        await client.mcp_json_config(mcp_config_file)
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå·±ç¼–å†™çš„`MCP Client`è¿æ¥å‰é¢çš„`MCP Server`ã€‚

ä¿®æ”¹`mcp.json`æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
{
    "mcpServers": {
      "weather-http": {
        "isActive": true,
        "type": "streamable_http",
        "url": "http://127.0.0.1:8002/mcp",
        "name": "weather-http"
      }
    }
}
```

åŒæ ·å¯ä»¥æˆåŠŸè°ƒç”¨åˆ°`MCP Server`çš„æœåŠ¡ã€‚

![image-20250513182033814](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513182033814.png)

å¤š`MCP Server`æµ‹è¯•ï¼Œä¿®æ”¹`mcp.json`æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
{
    "mcpServers": {
      "time-http": {
        "isActive": true,
        "type": "streamable_http",
        "url": "https://time.mcp.minglog.cn/mcp",
        "name": "time-http"
      },
      "weather-http": {
        "isActive": true,
        "type": "streamable_http",
        "url": "http://127.0.0.1:8002/mcp",
        "name": "weather-http"
      }
    }
}
```

è¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªæˆ‘æœåŠ¡å™¨ä¸­çš„`MCP Server`ï¼ŒåŒæ ·æ˜¯`streamable_http`åè®®ã€‚

![image-20250513182306857](./7%E6%9C%8816%E6%97%A5%E8%AE%B0%E5%BD%95.assets/image-20250513182306857.png)

æ‰€æœ‰å·¥å…·éƒ½å¯ä»¥è°ƒç”¨æˆåŠŸã€‚

## ç»“è¯­

`Streamable HTTP`ä½œä¸º`MCP`åè®®ä¸­çš„æ¨èä¼ è¾“æœºåˆ¶ï¼Œç»“åˆäº†`HTTP`çš„å¹¿æ³›å…¼å®¹æ€§å’Œ`SSE`çš„å®æ—¶æ•°æ®æ¨é€èƒ½åŠ›ï¼Œæä¾›äº†ä¸€ç§é«˜æ•ˆã€çµæ´»çš„é€šä¿¡æ–¹å¼ã€‚åœ¨AIåŠ©æ‰‹ä¸åº”ç”¨ç¨‹åºä¹‹é—´çš„é€šä¿¡éœ€æ±‚æ—¥ç›Šå¢é•¿çš„èƒŒæ™¯ä¸‹ï¼Œ`Streamable HTTP`æœ‰æœ›æˆä¸ºAIé€šä¿¡çš„æ–°æ ‡å‡†ã€‚

å¦‚æœæ‚¨å¸Œæœ›æ·±å…¥äº†è§£`MCP`åè®®å’Œ`Streamable HTTP`çš„å®ç°ç»†èŠ‚ï¼Œå¯ä»¥è®¿é—®ä»¥ä¸‹èµ„æºï¼š

- MCPå®˜æ–¹æ–‡æ¡£ï¼šhttps://modelcontextprotocol.io/
- MCPæ¡†æ¶æ–‡æ¡£ï¼šhttps://mcp-framework.com/docs/Transports/http-stream-transport/
- MCP GitHubä»“åº“ï¼šhttps://github.com/mcp-ai

é€šè¿‡è¿™äº›èµ„æºï¼Œæ‚¨å¯ä»¥æ›´æ·±å…¥åœ°äº†è§£`MCP`åè®®çš„è®¾è®¡ç†å¿µå’Œå®ç°æ–¹å¼ï¼Œæ¢ç´¢å…¶åœ¨å®é™…åº”ç”¨ä¸­çš„æ½œåŠ›ã€‚

