# 7月19日记录

再一次安装espIDF环境再次出现问题

```
liuli@liuli:~/esp32$ cd ~/esp32/esp-idf && ./install.sh esp32s3 
-bash: ./install.sh: Permission denied
```

1. 进入目录并赋予执行权限（如果需要）：

```bash
cd esp-idf
chmod +x install.sh
```



```
liuli@liuli:~/esp32/esp-idf$ ./install.sh esp32s3 
/usr/bin/env: ‘bash\r’: No such file or directory 
/usr/bin/env: use -[v]S to pass options in shebang lines
```


这个错误通常是由于脚本文件使用了 Windows 风格的换行符（CRLF），而 Linux 系统需要 Unix 风格的换行符（LF）导致的。可以按照以下步骤解决：

1. 首先安装`dos2unix`工具（如果尚未安装）：

```bash
sudo apt install dos2unix
```

2.转换`install.sh`文件的换行符格式：

```bash
dos2unix install.sh
```





liuli@liuli:~/esp32/esp-idf$ ./install.sh esp32s3 Detecting the Python interpreter /home/liuli/esp32/esp-idf/tools/detect_python.sh: line 9: $'\r': command not found


这个错误仍然是由于脚本文件中存在 Windows 风格的换行符（CRLF）导致的，这次是`detect_python.sh`文件出现了同样的问题。你需要对相关的脚本文件进行格式转换：

1. 先转换`detect_python.sh`文件：

```bash
dos2unix tools/detect_python.sh
```

1. 为了彻底解决问题，建议将整个项目中的所有 shell 脚本都转换为 Unix 格式：

```bash
find . -name "*.sh" -exec dos2unix {} \;
```

1. 之后再次尝试运行安装命令：

```bash
./install.sh esp32s3
```



**有这上面问题的主要原因应该是我使用了Windows的git bash**





```
Guru Meditation Error: Core  1 panic'ed (LoadProhibited). Exception was unhandled.

Core  1 register dump:
PC      : 0x42009e90  PS      : 0x00060a30  A0      : 0x8037f518  A1      : 0x3fcdbd90  
--- 0x42009e90: task(AppFace*) at /home/liuli/esp32/esp_sparkbot/example/human_face_recognition_no_wakenet/main/src/app_face.cpp:223
```

我看到你的 ESP32 人脸识别项目出现了 Guru Meditation Error，这是一个内存访问错误（LoadProhibited）。错误发生在 `app_face.cpp` 的第 223 行，让我先查看一下具体的错误位置。

读取 [app_face.cpp](vscode-file://vscode-app/d:/Microsoft VS Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html)，行 215 到 230

问题出现在第 223 行，也就是：

rgb_printf(frame, RGB565_MASK_BLUE, "Enroll: ID %d", self->recognizer->get_enrolled_ids().back().id);

这个错误是因为当没有注册的人脸 ID 时，`get_enrolled_ids()` 返回的容器是空的，调用 `.back()` 会导致未定义行为和内存访问错误。



现在让我修复这个问题。问题在于在执行人脸注册后，如果 `get_enrolled_ids()` 返回空容器，调用 `.back()` 会导致崩溃。我需要在访问 `.back()` 之前检查容器是否为空：

case FACE_ENROLL:

​            **{**

​              **auto enrolled_ids = self->recognizer->get_enrolled_ids();**

​              **if (!enrolled_ids.empty()) {**

​                rgb_printf(frame, RGB565_MASK_BLUE, "Enroll: ID %d", enrolled_ids.back().id);

​              **} else {**

​                **rgb_print(frame, RGB565_MASK_BLUE, "Enroll failed");**

​              **}**

​            **}**

​            break;



同样对who_human_face_recognition.cpp中的人脸注册逻辑，进行相同处理



同时，我发现在注册人脸的代码部分也可能存在类似问题。让我查看一下注册人脸的代码：

读取 [app_face.cpp](vscode-file://vscode-app/d:/Microsoft VS Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html)，行 165 到 180

我找到了另一个潜在问题！在第 167 行，同样存在直接调用 `.back()` 的问题。让我修复这个：

app_face.cpp**+6****-1**

现在让我检查一下是否还有其他类似的问题。让我搜索所有使用 `get_enrolled_ids().back()` 的地方：





```
W (47571) AFE_SR: Ringbuffer of AFE is full. Please use fetch() to retrieve data from the ringbuffer soon to avoid data loss or overwriting!!!

W (47611) AFE_SR: Ringbuffer of AFE is full. Please use fetch() to retrieve data from the ringbuffer soon to avoid data loss or overwriting!!!


```

AFE_SR (Audio Front End - Speech Recognition) 的环形缓冲区满的警告。这个问题表明音频数据处理速度跟不上音频采集速度，导致缓冲区溢出。

在 AFE_CONFIG_DEFAULT 宏中，`afe_ringbuf_size = 50` 这个值可能太小了，导致环形缓冲区很快就满了。让我继续查看任务执行的部分：



现在我明白了问题的根源。有两个任务在运行：

1. [feed_handler](vscode-file://vscode-app/d:/Microsoft VS Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html) - 负责从麦克风读取音频数据并喂给 AFE
2. [detect_hander](vscode-file://vscode-app/d:/Microsoft VS Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html) - 负责从 AFE 获取处理后的数据进行语音识别

问题是：

1. AFE 的环形缓冲区大小设置为 50，这对于连续的音频处理可能太小
2. [detect_hander](vscode-file://vscode-app/d:/Microsoft VS Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html) 中的 `fetch` 调用可能没有足够频繁地清空缓冲区
3. 两个任务之间可能存在处理速度不匹配的问题

让我修复这些问题：



```
.afe_ringbuf_size = 200, \
```

