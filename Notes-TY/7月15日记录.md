# 7月15日记录



[立创文档教程 16章人脸检测](https://wiki.lckfb.com/zh-hans/szpi-esp32s3/beginner/face-detection.html) 

[嘉立创b站 人脸检测教学](https://www.bilibili.com/video/BV1vTCUYyETZ?spm_id_from=333.788.videopod.episodes&vd_source=2f758a08e066db2801f9d6bece289ee7&p=20)

------

### **核心总结**

1. **核心功能**：利用 ESP32-S3 的 AI 能力（esp-dl 库）实现实时人脸检测，在 LCD 上显示摄像头画面并用绿色框标注人脸，红/绿/蓝点标记眼、鼻、嘴位置。
2. **依赖组件**：必须手动集成 `esp-dl` 组件（[官网下载](https://components.espressif.com/) → 搜索 esp-dl → 解压至 `工程/components/esp-dl`）。
3. **方向限制**：当前模型**仅支持特定方向**（USB 接口在右侧横向放置时生效）。

------

### **实现原理**



![deepseek_mermaid_20250715_6824b9](./7%E6%9C%8815%E6%97%A5%E8%AE%B0%E5%BD%95.assets/deepseek_mermaid_20250715_6824b9.svg)

- **三个核心任务**（通过队列通信）：
  - **`task_process_camera`**：捕获图像 → 发送到 `xQueueAIFrame`。
  - **`task_process_ai`**：调用 `HumanFaceDetectMSR01` 和 `HumanFaceDetectMNP01` 模型检测人脸 → 绘制标记 → 发送到 `xQueueLCDFrame`。
  - **`task_process_lcd`**：接收处理后的帧 → 显示到 LCD。
- **关键队列**：
  - `xQueueAIFrame`：摄像头 → AI 的通信管道。
  - `xQueueLCDFrame`：AI → LCD 的通信管道。

------

### **移植关键步骤**

1. **基础工程**：复制 **摄像头例程**（如 `07-lcd_camera`）重命名为 `13-human_face_detection`。

2. **添加必要文件**：从 `esp-who` 复制以下文件到 `main/`：

   - `who_ai_utils.cpp/hpp`

   - `who_human_face_detection.cpp/hpp`

   - who_human_face_detection.cpp 文件里面有函数调用 esp-dl 库实现人脸识别。

     who_ai_utils.cpp 文件里面有绘制人脸框图以及输出人脸坐标的函数。

3. **代码改造**：

   - **`main.c` → `main.cpp`**：因需调用 C++ 函数。

   - **`app_main` 改造**：

     ```
     extern "C" void app_main() {
       // ...初始化硬件（I2C/LCD/摄像头）
       app_camera_ai_lcd(); // 替换原app_camera_lcd()
     }
     ```

   - **任务函数重构**：

     - 删除冗余队列（`xQueueFrameI/O`），仅保留 `xQueueLCDFrame` 和 `xQueueAIFrame`。
     - 修改 `task_process_ai` 中的队列收发逻辑（指向新建队列）。

   - **C/C++ 兼容**：在 `esp32_s3_szp.h` 中用 `extern "C"` 包裹函数声明。

4. **分区表调整**：因固件变大，需修改 `partitions.csv`：

   - 将 `factory` 分区大小设为 **3MB**。

   - SDK 配置中启用自定义分区表：

     text

     ```
     CONFIG_PARTITION_TABLE_CUSTOM=y
     ```

------

### **注意事项**

1. **绘制函数兼容**：

   - 在 `esp32_s3_szp.c` 中实现 `lcd_draw_bitmap()` 供 C++ 调用。
   - 头文件用 `extern "C"` 确保跨语言访问。

2. **模型参数**：

   ```
   HumanFaceDetectMSR01 detector(0.3F, 0.3F, 10, 0.3F); // 阈值/步长参数
   HumanFaceDetectMNP01 detector2(0.4F, 0.3F, 10);     // 二级检测参数
   ```

   - 可调整参数优化识别精度/速度。

3. **资源限制**：

   - 人脸检测较耗资源，需确保 FreeRTOS 任务栈足够（例程中 ≥ 4KB）。
   - 摄像头分辨率建议使用 **QVGA (320x240)** 以平衡性能。























